<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Purchase Order Monitoring - Genetek</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <!-- Library untuk Export Excel -->
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>

    <style>
        /* Palet Warna Baru */
        :root {
            --primary-blue: #3b82f6; /* Biru utama */
            --primary-dark-blue: #2563eb; /* Biru gelap */
            --accent-teal: #14b8a6; /* Aksen teal */
            --accent-green: #22c55e; /* Aksen hijau */
            --text-dark: #1e293b; /* Teks gelap */
            --text-medium: #475569; /* Teks sedang */
            --text-light: #64748b; /* Teks terang */
            --bg-light: #f8fafc; /* Latar belakang terang */
            --bg-medium: #e2e8f0; /* Latar belakang sedang */
            --bg-soft: #f0f2f5; /* Latar belakang sangat lembut */
            --border-color: #cbd5e1; /* Warna border */
            --shadow-light: rgba(0, 0, 0, 0.05);
            --shadow-medium: rgba(0, 0, 0, 0.1);
            --shadow-strong: rgba(0, 0, 0, 0.2);
        }

        html, body {
            height: 100%; /* Penting untuk fullscreen modal */
            width: 100%; /* Penting untuk fullscreen modal */
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-soft);
            color: var(--text-medium);
            line-height: 1.6;
        }

        /* Header Styling */
        .header {
            background-color: #ffffff;
            border-radius: 1rem; /* Lebih bulat */
            box-shadow: 0 8px 20px var(--shadow-light); /* Bayangan lebih halus */
            padding: 1.75rem 2rem;
            position: relative; /* Untuk menempatkan tombol logout */
        }
        .header h1 {
            color: var(--text-dark);
            font-size: 2.25rem; /* Lebih besar */
            font-weight: 800;
        }
        .header .logout-btn-container {
            position: absolute;
            top: 1.75rem;
            right: 2rem;
        }
        .header button {
            font-weight: 600;
            border-radius: 0.65rem;
            padding: 0.75rem 1.25rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .header button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px var(--shadow-medium);
        }
        .header button.bg-blue-600 { background-color: var(--primary-blue); }
        .header button.bg-blue-600:hover { background-color: var(--primary-dark-blue); }
        .header button.bg-green-500 { background-color: var(--accent-green); } /* Menggunakan accent-green */
        .header button.bg-green-500:hover { background-color: #16a34a; } /* Darker green */
        .header button.bg-red-500 { background-color: #ef4444; }
        .header button.bg-red-500:hover { background-color: #dc2626; }
        .header button.bg-gray-500 { background-color: #6b7280; }
        .header button.bg-gray-500:hover { background-color: #4b5563; }
        .header button.bg-gray-200 { background-color: var(--bg-medium); color: var(--text-dark); }
        .header button.bg-gray-200:hover { background-color: var(--border-color); }

        /* Ripple Effect */
        .ripple {
            position: absolute;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.7);
            animation: ripple-animation 0.6s linear forwards;
            transform: scale(0);
            pointer-events: none;
        }
        @keyframes ripple-animation {
            from { transform: scale(0); opacity: 1; }
            to { transform: scale(4); opacity: 0; }
        }

        /* Input & Select Styling */
        input[type="text"], input[type="date"], input[type="number"], select, textarea {
            border: 1px solid var(--border-color);
            border-radius: 0.65rem;
            padding: 0.75rem 1rem;
            font-size: 0.95rem;
            color: var(--text-dark);
            transition: all 0.2s ease;
        }
        input:focus, select:focus, textarea:focus {
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
            outline: none;
        }

        /* Pipeline Stage */
        .pipeline-stage {
            min-height: 480px;
            max-height: 600px;
            transition: all 0.4s ease-out;
            border-radius: 1rem; /* Lebih bulat */
            overflow: hidden;
            display: flex;
            flex-direction: column;
            background-color: #ffffff;
            box-shadow: 0 12px 30px var(--shadow-light); /* Bayangan lebih dalam */
            box-sizing: border-box;
        }
        .pipeline-stage-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--bg-medium);
            background-image: linear-gradient(to right, var(--primary-blue), var(--accent-teal)); /* Animasi: Gradien pada header */
            color: white; /* Animasi: Warna teks agar kontras dengan gradien */
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); /* Animasi: Bayangan pada header */
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
        }
        .pipeline-stage-header h3 {
            font-size: 1.2rem; /* Lebih besar */
            font-weight: 700;
            color: white; /* Animasi: Pastikan teks judul tetap putih */
            flex-shrink: 0;
            text-align: center;
            width: 100%;
        }
        .pipeline-stage-content {
            flex-grow: 1;
            padding: 1.25rem; /* Padding lebih besar */
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            min-height: 100px;
            height: 100%;
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-content: flex-start;
            background-image: linear-gradient(to bottom right, var(--bg-light), var(--bg-soft)); /* Animasi: Gradien lembut pada konten */
        }

        /* Deal Card */
        .deal-card {
            transition: transform 0.4s ease-out, opacity 0.4s ease-out, box-shadow 0.3s ease-out; /* Animasi: Transisi yang lebih halus */
            cursor: grab;
            position: relative;
            background-color: #ffffff;
            border: 1px solid var(--bg-medium);
            border-radius: 0.85rem; /* Lebih bulat */
            padding: 1.1rem; /* Padding lebih besar */
            margin-bottom: 0;
            box-shadow: 0 6px 15px var(--shadow-light); /* Bayangan lebih jelas */
            font-size: 0.875rem;
            width: calc(25% - 0.75rem); /* Disesuaikan untuk 4 kolom */
            min-width: 220px; /* Min-width sedikit lebih kecil agar muat 4 kolom */
            box-sizing: border-box;
            opacity: 0; /* Animasi: Mulai dengan tidak terlihat */
            transform: translateY(20px); /* Animasi: Mulai sedikit di bawah */
            display: flex; /* Menggunakan flexbox untuk tata letak internal */
            flex-direction: column;
            justify-content: space-between;
        }
        .deal-card.show {
            opacity: 1;
            transform: translateY(0);
        }
        .deal-card:hover {
            transform: translateY(-7px) scale(1.02); /* Animasi: Efek hover lebih dramatis (naik dan membesar) */
            box-shadow: 0 15px 35px var(--shadow-medium); /* Bayangan hover lebih kuat */
        }
        .deal-card:active {
            cursor: grabbing;
        }
        .deal-card h3 {
            font-size: 1.05rem; /* Ukuran font sedikit lebih besar */
            font-weight: 700;
            color: var(--text-dark);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: calc(100% - 60px);
            margin-bottom: 0.5rem; /* Spasi di bawah judul */
        }
        .deal-details {
            flex-grow: 1; /* Memungkinkan detail mengisi ruang */
            margin-bottom: 1rem; /* Spasi di bawah detail */
        }
        .deal-details p {
            font-size: 0.85rem; /* Ukuran font sedikit lebih besar */
            margin-top: 0.3rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--text-medium);
            display: flex;
            align-items: center;
        }
        .deal-details p i {
            font-size: 0.8rem;
            color: var(--text-light);
            margin-right: 0.5rem; /* Spasi antara ikon dan teks */
            width: 1rem; /* Lebar tetap untuk ikon */
            text-align: center;
        }
        .deal-actions {
            display: flex;
            justify-content: flex-end; /* Tombol aksi ke kanan */
            gap: 0.5rem; /* Spasi antar tombol aksi */
        }
        .deal-actions button {
            padding: 0.3rem 0.6rem;
            font-size: 0.8rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease-out, transform 0.2s ease-out;
            color: var(--text-medium); /* Warna ikon default */
            background-color: var(--bg-light); /* Latar belakang tombol aksi */
            border: 1px solid var(--border-color);
        }
        .deal-actions button:hover {
            transform: translateY(-2px);
            background-color: var(--bg-medium);
        }
        .deal-actions button.text-blue-600:hover { color: var(--primary-blue); }
        .deal-actions button.text-green-600:hover { color: #22c55e; } /* Menggunakan accent-green */
        .deal-actions button.text-red-600:hover { color: #ef4444; }

        .deal-footer {
            margin-top: 1rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--bg-medium);
            display: flex; /* Tambahkan ini untuk flexbox */
            justify-content: space-between; /* Untuk menempatkan status di kiri dan aksi di kanan */
            align-items: center; /* Untuk menyelaraskan vertikal */
        }

        /* Scrollbar */
        .pipeline-stage-content::-webkit-scrollbar {
            width: 8px; /* Animasi: Lebar scrollbar */
        }
        .pipeline-stage-content::-webkit-scrollbar-track {
            background: var(--bg-soft); /* Animasi: Warna track */
            border-radius: 10px;
        }
        .pipeline-stage-content::-webkit-scrollbar-thumb {
            background: var(--primary-blue); /* Animasi: Warna thumb */
            border-radius: 10px;
            border: 2px solid var(--bg-soft); /* Animasi: Border agar terlihat lebih baik */
        }
        .pipeline-stage-content::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark-blue); /* Animasi: Warna thumb saat hover */
        }

        /* Modals */
        /* Hapus properti transition untuk menghilangkan animasi */
        .modal-content-enter-active, .modal-content-leave-active {
            /* transition: opacity 0.15s cubic-bezier(0.25, 0.8, 0.25, 1), transform 0.15s cubic-bezier(0.25, 0.8, 0.25, 1); */
        }
        #poModalContent, #poDetailModalContent, #deleteModalContent, #filterPanelContent, #successAlertModalContent, #documentChecklistModalContent {
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 20px 50px var(--shadow-strong);
            padding: 2.5rem;
        }

        /* Fullscreen PO Modal */
        #poModalContent {
            width: 98vw; /* Hampir fullscreen */
            height: 98vh; /* Hampir fullscreen */
            max-width: 98vw; /* Pastikan tidak melebihi viewport */
            max-height: 98vh; /* Pastikan tidak melebihi viewport */
            border-radius: 1rem;
            box-shadow: 0 20px 50px var(--shadow-strong);
            display: flex;
            flex-direction: column;
            padding: 1rem; /* Sesuaikan padding agar tidak terlalu besar */
        }
        #poModalContent .po-form-container {
            flex-grow: 1;
            overflow-y: auto; /* Scrollbar hanya di dalam form jika konten terlalu panjang */
            padding-right: 0.5rem; /* Ruang untuk scrollbar */
        }
        #poModalContent .po-form-container::-webkit-scrollbar {
            width: 8px;
        }
        #poModalContent .po-form-container::-webkit-scrollbar-track {
            background: var(--bg-soft);
            border-radius: 10px;
        }
        #poModalContent .po-form-container::-webkit-scrollbar-thumb {
            background: var(--primary-blue);
            border-radius: 10px;
            border: 2px solid var(--bg-soft);
        }
        #poModalContent .po-form-container::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark-blue);
        }


        #poModalContent h2, #poDetailModalContent h2, #deleteModalContent h2, #filterPanelContent h2, #successAlertModalContent h2, #documentChecklistModalContent h2 {
            color: var(--text-dark);
            font-weight: 800;
            font-size: 1.75rem; /* Lebih kecil */
            margin-bottom: 1rem; /* Lebih kecil */
        }
        #poForm label, #documentChecklistForm label {
            color: var(--text-dark);
            font-weight: 600;
            font-size: 0.75rem; /* Lebih kecil */
            margin-bottom: 0.25rem; /* Lebih kecil */
        }
        #poForm input, #poForm select, #poForm textarea, #documentChecklistForm input, #documentChecklistForm select, #documentChecklistForm textarea {
            border-radius: 0.5rem;
            padding: 0.5rem 0.75rem; /* Lebih kecil */
            font-size: 0.85rem; /* Lebih kecil */
        }
        #poForm textarea, #documentChecklistForm textarea { height: 80px; } /* Sedikit lebih pendek */

        /* Detail Grid */
        #poDetailModalContent .detail-grid {
            display: grid; /* Pastikan ini adalah grid */
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); /* Lebih rapat */
            gap: 1rem;
        }
        /* Modifikasi untuk 3 kolom pada detail PO */
        @media (min-width: 768px) { /* Untuk tablet dan desktop */
            #poDetailModalContent .detail-grid {
                grid-template-columns: repeat(3, 1fr); /* 3 kolom */
            }
        }
        /* Modifikasi untuk 4 kolom pada detail PO */
        @media (min-width: 1024px) { /* Untuk desktop */
            #poDetailModalContent .detail-grid {
                grid-template-columns: repeat(4, 1fr); /* 4 kolom */
            }
        }
        #poDetailModalContent .detail-item p { /* Gabungkan kedua aturan ini */
            color: var(--text-dark); /* Warna teks utama */
            font-size: 0.9rem; /* Ukuran font yang diinginkan */
            font-weight: 500;
        }
        #poDetailModalContent .detail-item p:first-child {
            color: var(--text-dark); /* Pertahankan warna teks yang lebih terang untuk label */
            font-weight: 600; /* Jadikan label sedikit lebih tebal */
        }
        #poDetailModalContent .detail-item ul,
        #poDetailModalContent .detail-item li {
            font-size: 0.9rem; /* Sesuaikan dengan ukuran font detail lainnya */
            color: var(--text-dark); /* Sesuaikan dengan warna teks detail lainnya */
            font-weight: 500; /* Sesuaikan dengan ketebalan teks detail lainnya */
        }

        /* Loading Spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--primary-blue);
            border-radius: 50%;
            width: 40px; /* Lebih besar */
            height: 40px;
            animation: spin 1s linear infinite;
        }
        /* Global Loading Overlay */
        #global-loading-overlay.show {
            display: flex; /* Pastikan overlay terlihat saat 'show' */
        }

        /* Empty State */
        .empty-state {
            color: var(--text-light);
            text-align: center;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
        }
        .empty-state i {
            font-size: 3rem;
            color: var(--bg-medium);
            margin-bottom: 1rem;
        }
        .empty-state p {
            font-size: 1rem;
            color: var(--text-light);
        }

        /* PO Card Number */
        .po-card-number {
            position: absolute;
            top: 0.6rem;
            right: 0.6rem; /* Pindah ke kanan atas */
            left: unset; /* Pastikan tidak ada properti left yang mengganggu */
            font-size: 0.8rem; /* Sedikit lebih besar */
            font-weight: 700;
            color: var(--text-dark); /* Warna teks lebih gelap */
            background-color: var(--bg-medium);
            padding: 0.15rem 0.5rem;
            border-radius: 0.35rem;
            z-index: 10; /* Pastikan di atas konten lain */
        }

        /* Warna Status - Disesuaikan agar mirip dengan warna tombol */
        .status-on-order { background-color: var(--primary-blue); color: white; } /* Biru utama */
        .status-waiting { background-color: #facc15; color: #333; } /* Kuning */
        .status-picked-up { background-color: var(--accent-green); color: white; } /* Hijau aksen */
        .status-on-delivery { background-color: #a78bfa; color: white; } /* Ungu */
        .status-delivered { background-color: #10b981; color: white; } /* Hijau zamrud */
        .status-partial-delivered { background-color: #fbbf24; color: #333; } /* Amber */
        .status-delayed { background-color: #ef4444; color: white; } /* Merah */
        .status-on-hold { background-color: #9ca3af; color: white; } /* Abu-abu */

        /* Styling untuk dropdown status di deal-card */
        .status-dropdown {
            appearance: none; /* Hapus tampilan default browser */
            background-color: var(--primary-blue);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            min-width: 100px; /* Agar tidak terlalu kecil */
            max-width: 120px;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            position: relative;
            padding-right: 1.5rem; /* Ruang untuk ikon panah */
        }
        .status-dropdown:hover {
            background-color: var(--primary-blue);
        }
        .status-dropdown:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        /* Custom arrow for dropdown */
        .status-dropdown::after {
            content: '\f078'; /* FontAwesome chevron-down icon */
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: var(--text-medium);
        }

        /* Media Queries untuk responsivitas */
        @media (max-width: 1280px) { /* Untuk layar laptop besar, 3 kolom */
            .deal-card {
                width: calc(33.333% - 0.666rem);
                min-width: 280px;
            }
        }

        @media (max-width: 1024px) { /* Untuk tablet, 2 kolom */
            .deal-card {
                width: calc(50% - 0.5rem);
                min-width: 280px;
            }
            /* Menyesuaikan grid kolom utama form PO untuk tablet */
            #poModalContent .grid.grid-cols-1.sm\:grid-cols-2.md\:grid-cols-3.lg\:grid-cols-4 > div {
                grid-column: span 1; /* Default 1 kolom */
            }
            @media (min-width: 640px) { /* sm breakpoint */
                #poModalContent .grid.grid-cols-1.sm\:grid-cols-2.md\:grid-cols-3.lg\:grid-cols-4 > div {
                    grid-column: span 1; /* 2 kolom */
                }
            }
            @media (min-width: 768px) { /* md breakpoint */
                #poModalContent .grid.grid-cols-1.sm\:grid-cols-2.md\:grid-cols-3.lg\:grid-cols-4 > div {
                    grid-column: span 1; /* 3 kolom */
                }
            }
        }

        @media (max-width: 768px) { /* Untuk mobile, 1 kolom */
            .deal-card {
                width: 100%;
                min-width: unset;
            }
            .max-w-7xl {
                padding-left: 1rem;
                padding-right: 1rem;
            }
            .header {
                flex-direction: column;
                align-items: flex-start;
                padding: 1.25rem 1.5rem;
            }
            .header h1 {
                font-size: 1.75rem;
            }
            .header .logout-btn-container {
                position: static; /* Kembali ke posisi normal di mobile */
                margin-top: 1rem;
                width: 100%;
            }
            .header > div:last-child { /* Ini adalah div yang berisi tombol-tombol di bawah judul */
                margin-top: 1rem;
                width: 100%;
                flex-direction: column;
                align-items: stretch;
                gap: 0.75rem;
            }
            .header button {
                width: 100%;
                justify-content: center;
                padding: 0.65rem 1rem;
                font-size: 0.9rem;
            }
            .header .flex-col.sm\:flex-row {
                flex-direction: column;
            }
            .header .sm\:w-1\/2 {
                width: 100%;
            }
            #poModalContent {
                padding: 1rem; /* Padding lebih kecil untuk mobile */
            }
            #poModalContent h2 {
                font-size: 1.5rem;
            }
            /* Menyesuaikan grid kolom utama form PO untuk mobile */
            #poModalContent .grid.grid-cols-1.sm\:grid-cols-2.md\:grid-cols-3.lg\:grid-cols-4 > div {
                grid-column: span 1; /* 1 kolom */
            }
        }

        /* Styling for search dropdown */
        .autocomplete-items {
            position: absolute;
            border: 1px solid #d4d4d4;
            border-bottom: none;
            border-top: none;
            z-index: 99;
            /*position the autocomplete items to be the same width as the container:*/
            top: 100%;
            left: 0;
            right: 0;
            max-height: 200px; /* Batasi tinggi dropdown */
            overflow-y: auto; /* Tambahkan scroll jika terlalu banyak item */
            background-color: #fff; /* Pastikan background putih */
        }

        .autocomplete-items div {
            padding: 10px;
            cursor: pointer;
            background-color: #fff;
            border-bottom: 1px solid #d4d4d4;
        }

        .autocomplete-items div:hover {
            /*when hovering an item:*/
            background-color: #e9e9e9;
        }

        .autocomplete-active {
            /*when navigating through the items using the arrow keys:*/
            background-color: DodgerBlue !important;
            color: #ffffff;
        }

        /* Custom styles for item rows */
        .item-row-container {
            display: flex;
            flex-direction: column;
            gap: 0.75rem; /* Space between item rows, lebih rapat */
            margin-top: 1rem; /* Tambahkan margin atas agar tidak terlalu mepet */
            padding-top: 1rem; /* Tambahkan padding atas */
            border-top: 1px solid var(--border-color); /* Tambahkan garis pemisah */
        }

        .item-row {
            display: grid;
            /* Default untuk mobile: 1 kolom */
            grid-template-columns: 1fr;
            gap: 0.4rem; /* Space between inputs in a row, lebih rapat */
            align-items: end; /* Align items at the bottom */
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 0.6rem; /* Lebih kecil */
            background-color: var(--bg-light);
        }

        /* Untuk layar yang lebih besar, sesuaikan kolom item-row */
        @media (min-width: 640px) { /* sm breakpoint */
            .item-row {
                /* PID (1.5fr), Description (3fr), Qty (0.8fr), COO (1.2fr), HS Code (1.5fr), Revised HS Code (1.5fr), Actions (0.5fr) */
                grid-template-columns: 1.5fr 3fr 0.8fr 1.2fr 1.5fr 1.5fr 0.5fr;
            }
        }
        @media (min-width: 1024px) { /* lg breakpoint */
            .item-row {
                /* PID (1.5fr), Description (3fr), Qty (0.8fr), COO (1.2fr), HS Code (1.5fr), Revised HS Code (1.5fr), Actions (0.5fr) */
                grid-template-columns: 1.5fr 3fr 0.8fr 1.2fr 1.5fr 1.5fr 0.5fr;
            }
        }


        .item-row > div {
            display: flex;
            flex-direction: column;
        }

        .item-row .item-action-buttons {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 0.5rem;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <div class="max-w-7xl mx-auto px-4 py-8">
        <!-- Header -->
        <header class="mb-8 bg-white p-6 rounded-lg shadow-md header">
            <div class="flex justify-between items-start">
                <div>
                    <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-900">Purchase Order Monitoring <i class="fas fa-box-open text-blue-600 ml-2"></i></h1>
                </div>
                <div class="logout-btn-container">
                    <button id="authButton" onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg shadow-md transition duration-200 ease-in-out transform hover:scale-105 flex items-center text-sm">
                        <i class="fas fa-sign-out-alt mr-2"></i> Logout
                    </button>
                </div>
            </div>

            <!-- Buttons below title -->
            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4 mt-4">
                <button id="newPOBtn" onclick="openPOModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow-md transition duration-200 ease-in-out transform hover:scale-105 flex items-center text-sm">
                    <i class="fas fa-plus-circle mr-2"></i> PO Baru
                </button>

                <button id="documentChecklistBtn" onclick="openDocumentChecklistModal()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg shadow-md transition duration-200 ease-in-out transform hover:scale-105 flex items-center text-sm">
                    <i class="fas fa-clipboard-list mr-2"></i> Document Checklist
                </button>

                <button id="exportExcelBtn" onclick="exportToExcel()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg shadow-md transition duration-200 ease-in-out transform hover:scale-105 flex items-center text-sm">
                    <i class="fas fa-file-excel mr-2"></i> Export Excel
                </button>

                <button id="backButton" onclick="goToIndex()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg shadow-md transition duration-200 ease-in-out transform hover:scale-105 flex items-center text-sm">
                    <i class="fas fa-arrow-left mr-2"></i> Kembali
                </button>
            </div>

            <!-- Combined Filter Section -->
            <div class="mt-6 flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4 items-center">
                <input type="text" id="searchPOs" onkeyup="filterPOs()" placeholder="Cari PO berdasarkan nomor, supplier, barang..." class="w-full sm:w-1/2 p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">

                <button id="openFilterPanelBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg shadow-md transition duration-200 ease-in-out transform hover:scale-105 flex items-center text-sm">
                    <i class="fas fa-filter mr-2"></i> Filter
                </button>
            </div>
        </header>

        <!-- Pipeline Visualization -->
        <div class="grid grid-cols-1 gap-6 mb-10">
            <div class="pipeline-stage stage-main-pipeline">
                <div class="pipeline-stage-header">
                    <h3>Daftar PO</h3>
                </div>
                <div id="pos-stage" class="pipeline-stage-content">
                    <!-- POs akan ditampilkan di sini -->
                    <div id="loading-spinner" class="flex justify-center items-center w-full h-full hidden">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add/Edit PO Modal -->
        <div id="poModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
            <div class="bg-white rounded-none p-8 w-full h-full shadow-2xl modal-content-enter" id="poModalContent">
                <h2 class="text-xl sm:text-2xl font-bold mb-4 text-gray-900" id="modalTitle">Tambah PO Baru</h2>
                <form id="poForm" class="po-form-container">
                    <input type="hidden" id="poId">
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-x-3 gap-y-2"> <!-- Gap lebih rapat -->
                        <!-- Kolom 1 -->
                        <div>
                            <div class="mb-2"> <!-- Margin lebih kecil -->
                                <label class="block text-gray-700 text-sm font-semibold mb-1" for="noPO">PO Number <span class="text-red-500">*</span></label>
                                <input type="text" id="noPO" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm" required>
                            </div>
                            <div class="mb-2">
                                <label class="block text-gray-700 text-sm font-semibold mb-1" for="supplierName">Vendor</label>
                                <input type="text" id="supplierName" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                            </div>
                            <div class="mb-2">
                                <label class="block text-gray-700 text-sm font-semibold mb-1" for="allocation">Allocation</label>
                                <input type="text" id="allocation" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                            </div>
                            <div class="mb-2">
                                <label class="block text-gray-700 text-sm font-semibold mb-1" for="invoice">Invoice Number</label>
                                <input type="text" id="invoice" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                            </div>
                            <div class="mb-2">
                                <label class="block text-gray-700 text-sm font-semibold mb-1" for="value">Value</label>
                                <input type="text" id="value" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                            </div>
                        </div>
                        <!-- Kolom 2 -->
                        <div>
                            <div class="mb-2">
                                <label class="block text-gray-700 text-sm font-semibold mb-1" for="tracking">AWB/Tracking Number</label>
                                <input type="text" id="tracking" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                            </div>
                            <div class="mb-2">
                                <label class="block text-gray-700 text-sm font-semibold mb-1" for="forwarderName">Nama Forwarder</label>
                                <select id="forwarderName" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                                    <option value="">Pilih Forwarder</option>
                                    <option value="Fedex">Fedex</option>
                                    <option value="Binex">Binex</option>
                                    <option value="Hardrodt">Hardrodt</option>
                                    <option value="DLL">DLL</option>
                                </select>
                            </div>
                            <div class="mb-2">
                                <label class="block text-gray-700 text-sm font-semibold mb-1" for="freightType">Jenis Freight</label>
                                <select id="freightType" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                                    <option value="">Pilih Jenis Freight</option>
                                    <option value="Sea Freight">Sea Freight</option>
                                    <option value="Air Freight">Air Freight</option>
                                </select>
                            </div>
                            <div class="mb-2">
                                <label class="block text-gray-700 text-sm font-semibold mb-1" for="disrc">DISRC</label>
                                <input type="text" id="disrc" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                            </div>
                        </div>
                        <!-- Kolom 3 -->
                        <div>
                            <div class="mb-2">
                                <label class="block text-gray-700 text-sm font-semibold mb-1" for="status">Order Status</label>
                                <select id="status" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                                    <option value="On Order">On Order</option>
                                    <option value="Waiting">Waiting</option>
                                    <option value="Picked Up">Picked Up</option>
                                    <option value="On Delivery">On Delivery</option>
                                    <option value="Delivered">Delivered</option>
                                    <option value="Partial Delivered">Partial Delivered</option>
                                    <option value="Delayed">Delayed</option>
                                    <option value="On Hold">On Hold</option>
                                </select>
                            </div>
                            <div class="mb-2">
                                <label class="block text-gray-700 text-sm font-semibold mb-1" for="planDelivery">Plan Delivery</label>
                                <input type="date" id="planDelivery" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                            </div>
                            <div class="mb-2">
                                <label class="block text-gray-700 text-sm font-semibold mb-1" for="eta">ETA</label>
                                <input type="date" id="eta" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                            </div>
                            <div class="mb-2">
                                <label class="block text-gray-700 text-sm font-semibold mb-1" for="actualDelivery">Actual Delivery</label>
                                <input type="date" id="actualDelivery" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                            </div>
                        </div>
                        <!-- Kolom 4 -->
                        <div>
                            <div class="mb-2">
                                <label class="block text-gray-700 text-sm font-semibold mb-1" for="note">Note</label>
                                <textarea id="note" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm" rows="4" placeholder="Tambahkan catatan atau deskripsi tambahan..."></textarea>
                            </div>
                        </div>

                        <!-- Item Details Section - Now integrated directly into the main grid -->
                        <div class="col-span-full"> <!-- This div will span all columns -->
                            <div id="items-container" class="item-row-container">
                                <!-- Item rows will be added here by JavaScript -->
                            </div>
                            <button type="button" onclick="addItemField()" class="mt-3 bg-gray-200 hover:bg-gray-300 text-gray-800 px-3 py-2 rounded-lg shadow-md transition duration-200 ease-in-out transform hover:scale-105 flex items-center text-sm">
                                <i class="fas fa-plus mr-1"></i> Tambah Item
                            </button>
                        </div>
                    </div>

                    <div class="flex justify-end space-x-3 mt-4"> <!-- Margin lebih kecil -->
                        <button type="button" onclick="closePOModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800 font-medium rounded-lg transition duration-200 text-sm">
                            Batal
                        </button>
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow-md font-medium transition duration-200 ease-in-out transform hover:scale-105 text-sm">
                            Simpan PO
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- PO Detail Modal -->
        <div id="poDetailModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
            <div class="bg-white rounded-xl p-8 w-full max-w-5xl shadow-2xl modal-content-enter overflow-y-auto" id="poDetailModalContent"> <!-- Max-width lebih besar untuk menampung 2 kolom utama -->
                <h2 class="text-xl sm:text-2xl font-bold mb-6 text-gray-900" id="poDetailTitle">Detail PO</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Kolom Kiri: Detail PO Utama -->
                    <div>
                        <h3 class="text-lg font-bold text-gray-900 mb-4">Informasi PO</h3>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <p class="text-gray-700 font-semibold">PO Number:</p>
                                <p id="detailNoPO" class="text-gray-900"></p>
                            </div>
                            <div class="detail-item">
                                <p class="text-gray-700 font-semibold">Vendor:</p>
                                <p id="detailSupplierName" class="text-gray-900"></p>
                            </div>
                            <div class="detail-item">
                                <p class="text-gray-700 font-semibold">Allocation:</p>
                                <p id="detailAllocation" class="text-gray-900"></p>
                            </div>
                            <div class="detail-item">
                                <p class="text-gray-700 font-semibold">Invoice Number:</p>
                                <p id="detailInvoice" class="text-gray-900"></p>
                            </div>
                            <div class="detail-item">
                                <p class="text-gray-700 font-semibold">Value:</p>
                                <p id="detailValue" class="text-gray-900"></p>
                            </div>
                            <div class="detail-item">
                                <p class="text-gray-700 font-semibold">AWB/Tracking Number:</p>
                                <p id="detailTracking" class="text-gray-900"></p>
                            </div>
                            <div class="detail-item">
                                <p class="text-gray-700 font-semibold">Nama Forwarder:</p>
                                <p id="detailForwarderName" class="text-gray-900"></p>
                            </div>
                            <div class="detail-item">
                                <p class="text-gray-700 font-semibold">Jenis Freight:</p>
                                <p id="detailFreightType" class="text-gray-900"></p>
                            </div>
                            <div class="detail-item">
                                <p class="text-gray-700 font-semibold">DISRC:</p>
                                <p id="detailDisrc" class="text-gray-900"></p>
                            </div>
                            <div class="detail-item">
                                <p class="text-gray-700 font-semibold">Order Status:</p>
                                <p id="detailStatus" class="text-gray-900"></p>
                            </div>
                            <div class="detail-item">
                                <p class="text-gray-700 font-semibold">Plan Delivery:</p>
                                <p id="detailPlanDelivery" class="text-gray-900"></p>
                            </div>
                            <div class="detail-item">
                                <p class="text-gray-700 font-semibold">ETA:</p>
                                <p id="detailETA" class="text-gray-900"></p>
                            </div>
                            <div class="detail-item">
                                <p class="text-gray-700 font-semibold">Actual Delivery:</p>
                                <p id="detailActualDelivery" class="text-gray-900"></p>
                            </div>
                            <div class="detail-item col-span-full">
                                <p class="text-gray-700 font-semibold">Note:</p>
                                <p id="detailNote" class="text-gray-900"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Kolom Kanan: Document Checklist -->
                    <div>
                        <h3 class="text-lg font-bold text-gray-900 mb-4">Document Checklist</h3>
                        <div id="detailDocumentChecklist" class="text-gray-900 text-sm grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-2">
                            <!-- Document checklist items will be rendered here -->
                        </div>
                    </div>
                </div>

                <!-- Detail Barang Section (tetap di bawah, spanning full width) -->
                <div class="detail-item col-span-full border-t pt-4 mt-4 border-gray-200">
                    <h3 class="text-lg font-bold text-gray-900 mb-2">Detail Barang</h3>
                    <div id="detailItemsList" class="flex flex-col gap-2">
                        <!-- Item details will be rendered here -->
                    </div>
                </div>

                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="closePODetailModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800 font-medium rounded-lg transition duration-200 text-sm">
                        Tutup
                    </button>
                </div>
            </div>
        </div>

        <!-- Delete Confirmation Modal -->
        <div id="deleteModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
            <div class="bg-white rounded-xl p-8 w-full max-w-sm shadow-2xl modal-content-enter" id="deleteModalContent">
                <h2 class="text-xl font-bold mb-4 text-gray-900">Konfirmasi Penghapusan</h2>
                <p class="text-gray-700 mb-6 text-sm">Apakah Anda yakin ingin menghapus "<span id="dealToDeleteName" class="font-semibold"></span>"? Aksi ini tidak dapat dibatalkan.</p>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeDeleteModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800 font-medium rounded-lg transition duration-200 text-sm">
                        Batal
                    </button>
                    <button type="button" id="confirmDeleteBtn" onclick="deletePO()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg shadow-md font-medium transition duration-200 ease-in-out transform hover:scale-105 text-sm">
                        Hapus
                    </button>
                </div>
            </div>
        </div>

        <!-- Filter Panel Modal -->
        <div id="filterPanel" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
            <div class="bg-white rounded-xl p-8 w-full max-w-2xl shadow-2xl modal-content-enter" id="filterPanelContent">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-900 flex items-center"><i class="fas fa-filter mr-3 text-gray-500"></i> Filter POs</h2>
                    <button onclick="closeFilterPanel()" class="text-gray-500 hover:text-gray-700 transition duration-200">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Filter: Nama Supplier -->
                    <div>
                        <label class="block text-gray-700 text-sm font-semibold mb-2" for="filterSupplier">Vendor</label>
                        <select id="filterSupplier" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                            <option value="all">Semua Vendor</option>
                            <!-- Opsi akan diisi secara dinamis oleh JavaScript -->
                        </select>
                    </div>
                    <!-- Filter: COO -->
                    <div>
                        <label class="block text-gray-700 text-sm font-semibold mb-2" for="filterCOO">COO</label>
                        <select id="filterCOO" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                            <option value="all">Semua COO</option>
                            <!-- Options populated dynamically -->
                        </select>
                    </div>
                    <!-- Filter: HS Code -->
                    <div>
                        <label class="block text-gray-700 text-sm font-semibold mb-2" for="filterHSCode">HS Code</label>
                        <select id="filterHSCode" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                            <option value="all">Semua HS Code</option>
                            <!-- Options populated dynamically -->
                        </select>
                    </div>
                    <!-- Filter: Status -->
                    <div>
                        <label class="block text-gray-700 text-sm font-semibold mb-2" for="filterStatus">Order Status</label>
                        <select id="filterStatus" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                            <option value="all">Semua Status</option>
                            <option value="On Order">On Order</option>
                            <option value="Waiting">Waiting</option>
                            <option value="Picked Up">Picked Up</option>
                            <option value="On Delivery">On Delivery</option>
                            <option value="Delivered">Delivered</option>
                            <option value="Partial Delivered">Partial Delivered</option>
                            <option value="Delayed">Delayed</option>
                            <option value="On Hold">On Hold</option>
                        </select>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="resetFilters()" class="px-4 py-2 text-gray-600 hover:text-gray-800 font-medium rounded-lg transition duration-200 text-sm">
                        Reset Filter
                    </button>
                    <button type="button" onclick="applyFiltersAndClosePanel()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow-md font-medium transition duration-200 ease-in-out transform hover:scale-105 text-sm">
                        Terapkan Filter
                    </button>
                </div>
            </div>
        </div>

        <!-- Document Checklist Modal (NEW) -->
        <div id="documentChecklistModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
            <div class="bg-white rounded-xl p-8 w-full max-w-2xl shadow-2xl modal-content-enter" id="documentChecklistModalContent">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-900 flex items-center"><i class="fas fa-clipboard-check mr-3 text-gray-500"></i> Document Checklist</h2>
                    <button onclick="closeDocumentChecklistModal()" class="text-gray-500 hover:text-gray-700 transition duration-200">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <form id="documentChecklistForm">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4"> <!-- Changed to 3 columns -->
                        <!-- Kolom 1: Dokumen -->
                        <div>
                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-semibold mb-2">OC/OA</label>
                                <select class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm" id="docChecklist_OC_OA">
                                    <option value="">Pilih Status</option>
                                    <option value="Download">Download</option>
                                    <option value="Printed">Printed</option>
                                    <option value="Waiting">Waiting</option>
                                </select>
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-semibold mb-2">PI</label>
                                <select class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm" id="docChecklist_PI">
                                    <option value="">Pilih Status</option>
                                    <option value="Download">Download</option>
                                    <option value="Printed">Printed</option>
                                    <option value="Waiting">Waiting</option>
                                </select>
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-semibold mb-2">CI</label>
                                <select class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm" id="docChecklist_CI">
                                    <option value="">Pilih Status</option>
                                    <option value="Download">Download</option>
                                    <option value="Printed">Printed</option>
                                    <option value="Waiting">Waiting</option>
                                </select>
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-semibold mb-2">PL</label>
                                <select class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm" id="docChecklist_PL">
                                    <option value="">Pilih Status</option>
                                    <option value="Download">Download</option>
                                    <option value="Printed">Printed</option>
                                    <option value="Waiting">Waiting</option>
                                </select>
                            </div>
                        </div>
                        <!-- Kolom 2: COO, COC, PIB, SPPB -->
                        <div>
                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-semibold mb-2">COO</label>
                                <select class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm" id="docChecklist_COO">
                                    <option value="">Pilih Status</option>
                                    <option value="Download">Download</option>
                                    <option value="Printed">Printed</option>
                                    <option value="Waiting">Waiting</option>
                                </select>
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-semibold mb-2">COC</label>
                                <select class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:focus:border-blue-500 transition duration-150 text-sm" id="docChecklist_COC">
                                    <option value="">Pilih Status</option>
                                    <option value="Download">Download</option>
                                    <option value="Printed">Printed</option>
                                    <option value="Waiting">Waiting</option>
                                </select>
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-semibold mb-2">PIB</label>
                                <select class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm" id="docChecklist_PIB">
                                    <option value="">Pilih Status</option>
                                    <option value="Download">Download</option>
                                    <option value="Printed">Printed</option>
                                    <option value="Waiting">Waiting</option>
                                </select>
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-semibold mb-2">SPPB</label>
                                <select class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm" id="docChecklist_SPPB">
                                    <option value="">Pilih Status</option>
                                    <option value="Download">Download</option>
                                    <option value="Printed">Printed</option>
                                    <option value="Waiting">Waiting</option>
                                </select>
                            </div>
                        </div>
                        <!-- Kolom 3: Hardcopy, Softcopy, Prepared By, Order By -->
                        <div>
                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-semibold mb-2">Hardcopy</label>
                                <select class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm" id="docChecklist_Hardcopy">
                                    <option value="">Pilih Status</option>
                                    <option value="Printed">Printed</option>
                                    <option value="Signed">Signed</option>
                                    <option value="Waiting">Waiting</option>
                                </select>
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-semibold mb-2">Softcopy</label>
                                <select class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm" id="docChecklist_Softcopy">
                                    <option value="">Pilih Status</option>
                                    <option value="Printed">Printed</option>
                                    <option value="Signed">Signed</option>
                                    <option value="Waiting">Waiting</option>
                                </select>
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-semibold mb-2">Prepared By</label>
                                <select class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm" id="docChecklist_PreparedBy">
                                    <option value="">Pilih Nama</option>
                                    <option value="Maida">Maida</option>
                                    <option value="Rossiana">Rossiana</option>
                                </select>
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-semibold mb-2">Order By</label>
                                <select class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm" id="docChecklist_OrderBy">
                                    <option value="">Pilih Nama</option>
                                    <option value="Maida">Maida</option>
                                    <option value="Rossiana">Rossiana</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="closeDocumentChecklistModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800 font-medium rounded-lg transition duration-200 text-sm">
                            Batal
                        </button>
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow-md font-medium transition duration-200 ease-in-out transform hover:scale-105 text-sm">
                            Simpan Checklist
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Success Alert Modal (New) -->
        <div id="successAlertModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
            <div class="bg-white rounded-xl p-8 w-full max-w-sm text-center shadow-2xl modal-content-enter" id="successAlertModalContent">
                <div class="text-green-500 text-6xl mb-4">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h2 class="text-2xl font-bold mb-4 text-gray-900">Berhasil!</h2>
                <p class="text-gray-700 mb-6" id="successAlertMessage">PO berhasil disimpan.</p>
                <button type="button" onclick="closeSuccessAlertModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg shadow-md font-medium transition duration-200 ease-in-out transform hover:scale-105">
                    OK
                </button>
            </div>
        </div>

        <!-- Global Loading Overlay -->
        <div id="global-loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-[9999] hidden">
            <div class="spinner"></div>
        </div>

    </div>

<script>
    // Konfigurasi Firebase (tetap ada untuk otentikasi dan PO, tapi tidak untuk productsCollection)
    const firebaseConfig = {
          apiKey: "AIzaSyB9s6k2K75vrbe1lWgiu42SAXV_lySHHNU",
          authDomain: "monitoring-efk.firebaseapp.com",
          projectId: "monitoring-efk",
          storageBucket: "monitoring-efk.firebasestorage.app",
          messagingSenderId: "1083858508151",
          appId: "1:1083858508151:web:3d505dec79d715f9cd6972"
    };

    // Inisialisasi Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const dealsCollection = db.collection('purchaseOrders');
    const usersCollection = db.collection('users');

    let pos = [];
    const DEFAULT_STATUS = 'On Order';
    let currentUserRole = 'user';
    let sortableInstances = {};
    let authInitialized = false;
    let unsubscribeFromPOs = null;

    // Data untuk search PID dan Item Description (akan berisi array objek dari pid.json)
    let productCatalog = [];

    // Hanya menyimpan Set untuk filter yang diinginkan
    let uniqueSuppliers = new Set();
    let uniqueCOOs = new Set();
    let uniqueHSCodes = new Set();
    let uniqueStatuses = new Set();

    const ADMIN_EMAIL = 'maida@genetek.co.id';

    // ==================== FUNGSI UTAMA ====================

    auth.onAuthStateChanged(async (user) => {
        if (authInitialized) return;
        authInitialized = true;

        console.log("Auth state changed:", user ? user.email : "no user");

        if (!user && window.location.pathname.includes('app.html')) {
            console.log("No user, redirecting to login");
            window.location.href = 'login.html';
            return;
        }

        if (user && window.location.pathname.includes('login.html')) {
            console.log("User already logged in, redirecting to app");
            window.location.href = 'app.html';
            return;
        }

        if (user && window.location.pathname.includes('app.html')) {
            try {
                showGlobalLoading();
                if (user.email === ADMIN_EMAIL) {
                    currentUserRole = 'admin';
                    await usersCollection.doc(user.uid).set({
                        role: 'admin',
                        email: user.email
                    }, { merge: true });
                } else {
                    console.log("Unauthorized user, logging out and redirecting to login.");
                    await auth.signOut();
                    window.location.href = 'login.html';
                    return;
                }

                console.log("Current role:", currentUserRole);
                // Panggil fungsi baru untuk memuat katalog produk
                await fetchProductCatalog(); // <--- PENTING: Panggil ini

                listenForPOs();
                initEventListeners();
                hideGlobalLoading();
            } catch (error) {
                console.error("Error checking user role or loading data:", error);
                showCustomAlert("Gagal memuat data pengguna atau aplikasi. Silakan refresh halaman.", "error");
                hideGlobalLoading();
            }
        }
    });

    // Fungsi untuk mengambil data katalog produk dari pid.json
    async function fetchProductCatalog() {
        try {
            // Ganti URL ini dengan lokasi file JSON katalog produk Anda
            const response = await fetch('https://raw.githubusercontent.com/bandeng77/monitoring.github.io/main/pid.json');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            productCatalog = await response.json();
            console.log("Product catalog loaded:", productCatalog.length, "items");

        } catch (error) {
            console.error("Error fetching product catalog data:", error);
            showCustomAlert("Gagal memuat data katalog produk. Fitur autocomplete mungkin tidak berfungsi.", "error");
            productCatalog = []; // Pastikan kosong jika gagal
        }
    }

    // ==================== FUNGSI UTILITAS ====================

    function formatDateTime(timestamp) {
        if (!timestamp) return '-';
        try {
            const date = timestamp instanceof Date ? timestamp : (timestamp && typeof timestamp.toDate === 'function' ? timestamp.toDate() : null);
            if (!date) return '-';

            return date.toLocaleString('id-ID', {
                day: 'numeric',
                month: 'short',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        } catch (e) {
            console.error("Error formatting date time:", e);
            return '-';
        }
    }

    function formatNumber(num) {
        if (num === null || num === undefined || isNaN(num)) {
            return '0';
        }
        return new Intl.NumberFormat('id-ID').format(num);
    }

    function formatDate(timestamp) {
        if (!timestamp) return '-';
        try {
            const date = timestamp instanceof Date ? timestamp : (timestamp && typeof timestamp.toDate === 'function' ? timestamp.toDate() : null);
            if (!date) return '-';

            return date.toLocaleDateString('id-ID');
        } catch (e) {
            console.error("Error formatting date:", e);
            return '-';
        }
    }

    function showCustomAlert(message, type = 'success') {
        const modal = document.getElementById('successAlertModal');
        const modalContent = document.getElementById('successAlertModalContent');
        const alertMessage = document.getElementById('successAlertMessage');
        const alertIcon = modalContent.querySelector('.text-6xl i');

        alertMessage.textContent = message;

        if (type === 'success') {
            alertIcon.className = 'fas fa-check-circle text-green-500';
        } else if (type === 'error') {
            alertIcon.className = 'fas fa-times-circle text-red-500';
        } else if (type === 'info') {
            alertIcon.className = 'fas fa-info-circle text-blue-500';
        } else if (type === 'warning') {
            alertIcon.className = 'fas fa-exclamation-triangle text-yellow-500';
        }

        modal.classList.remove('hidden');
    }

    function closeSuccessAlertModal() {
        const modal = document.getElementById('successAlertModal');
        if (!modal) return;
        modal.classList.add('hidden');
    }

    function showGlobalLoading() {
        document.getElementById('global-loading-overlay').classList.add('show');
    }

    function hideGlobalLoading() {
        document.getElementById('global-loading-overlay').classList.remove('show');
    }

    // ==================== FUNGSI PO ====================

    function listenForPOs() {
        console.log("Listening for POs from Firebase (onSnapshot)...");
        const pipelineStage = document.getElementById('pos-stage');
        const loadingSpinner = document.getElementById('loading-spinner');
        if (pipelineStage && loadingSpinner) {
            pipelineStage.innerHTML = '';
            loadingSpinner.classList.remove('hidden');
        }

        if (unsubscribeFromPOs) {
            unsubscribeFromPOs();
        }

        dealsCollection.orderBy("createdAt", "asc").onSnapshot(snapshot => {
            pos = [];
            uniqueSuppliers.clear();
            uniqueCOOs.clear();
            uniqueHSCodes.clear();
            uniqueStatuses.clear();

            snapshot.forEach((doc) => {
                const poData = doc.data();
                poData.createdAt = poData.createdAt && typeof poData.createdAt.toDate === 'function' ? poData.createdAt.toDate() : null;
                poData.planDelivery = poData.planDelivery && typeof poData.planDelivery.toDate === 'function' ? poData.planDelivery.toDate() : null;
                poData.eta = poData.eta && typeof poData.eta.toDate === 'function' ? poData.eta.toDate() : null;
                poData.actualDelivery = poData.actualDelivery && typeof poData.actualDelivery.toDate === 'function' ? poData.actualDelivery.toDate() : null;

                pos.push({ id: doc.id, ...poData });

                if (poData.supplierName) uniqueSuppliers.add(poData.supplierName);
                // Collect COO and HS Code from items
                if (poData.items && poData.items.length > 0) {
                    poData.items.forEach(item => {
                        if (item.coo) uniqueCOOs.add(item.coo);
                        if (item.hsCode) uniqueHSCodes.add(item.hsCode);
                    });
                }
                if (poData.status) uniqueStatuses.add(poData.status);
            });
            console.log("Total POs updated by onSnapshot:", pos.length);
            populateFilterDropdowns();
            filterPOs();
            if (loadingSpinner) {
                loadingSpinner.classList.add('hidden');
            }
        }, (error) => {
            console.error("Error listening to POs:", error);
            showCustomAlert("Gagal memuat data PO secara realtime.", "error");
            if (loadingSpinner) {
                loadingSpinner.classList.add('hidden');
            }
        });
    }

    function renderPO(po, index) {
        const poCard = document.createElement('div');
        poCard.className = 'deal-card';
        poCard.dataset.id = po.id;

        function getStatusClass(status) {
            switch (status) {
                case 'On Order': return 'status-on-order';
                case 'Waiting': return 'status-waiting';
                case 'Picked Up': return 'status-picked-up';
                case 'On Delivery': return 'status-on-delivery';
                case 'Delivered': return 'status-delivered';
                case 'Partial Delivered': return 'status-partial-delivered';
                case 'Delayed': return 'status-delayed';
                case 'On Hold': return 'status-on-hold';
                default: return 'bg-gray-400 text-white';
            }
        }

        poCard.innerHTML = `
            <span class="po-card-number">${index + 1}</span>
            <div class="flex justify-between items-start">
                <h3 class="font-bold text-gray-800">PO Number: ${po.noPO || 'No PO'}</h3>
            </div>
            <div class="mt-1 text-sm text-gray-600 deal-details">
                <p><i class="fas fa-building"></i> Vendor: ${po.supplierName || '-'}</p>
                <p><i class="fas fa-truck"></i> Nama Forwarder: ${po.forwarderName || '-'}</p>
                <p><i class="fas fa-file-invoice"></i> Invoice Number: ${po.invoice || '-'}</p>
            </div>
            <div class="mt-2 flex justify-between items-center deal-footer">
                <div class="relative">
                    <select onchange="updatePOStatus('${po.id}', this.value)" class="status-dropdown ${getStatusClass(po.status)}">
                        <option value="On Order" ${po.status === 'On Order' ? 'selected' : ''}>On Order</option>
                        <option value="Waiting" ${po.status === 'Waiting' ? 'selected' : ''}>Waiting</option>
                        <option value="Picked Up" ${po.status === 'Picked Up' ? 'selected' : ''}>Picked Up</option>
                        <option value="On Delivery" ${po.status === 'On Delivery' ? 'selected' : ''}>On Delivery</option>
                        <option value="Delivered" ${po.status === 'Delivered' ? 'selected' : ''}>Delivered</option>
                        <option value="Partial Delivered" ${po.status === 'Partial Delivered' ? 'selected' : ''}>Partial Delivered</option>
                        <option value="Delayed" ${po.status === 'Delayed' ? 'selected' : ''}>Delayed</option>
                        <option value="On Hold" ${po.status === 'On Hold' ? 'selected' : ''}>On Hold</option>
                    </select>
                </div>
                <div class="flex space-x-1 deal-actions">
                    <button onclick="openPODetailModal('${po.id}')" class="text-blue-600 hover:text-blue-800" title="Lihat Detail">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button onclick="prepareEditPO('${po.id}')" class="text-green-600 hover:text-green-800" title="Edit PO">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="confirmDeletePO('${po.id}', '${po.noPO}')" class="text-red-600 hover:text-red-800" title="Hapus PO">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            </div>
        `;

        return poCard;
    }

    function populateDropdown(selectElementId, uniqueValues, selectedValue = 'all') {
        const selectElement = document.getElementById(selectElementId);
        if (!selectElement) {
            console.warn(`Element with ID '${selectElementId}' not found.`);
            return;
        }

        const currentSelectedValue = selectElement.value;

        selectElement.innerHTML = '';

        const defaultOption = document.createElement('option');
        defaultOption.value = 'all';
        const labelElement = selectElement.previousElementSibling;
        const labelText = labelElement ? labelElement.textContent.replace(':', '').replace('*', '').trim() : '';
        defaultOption.textContent = `Semua ${labelText}`;
        selectElement.appendChild(defaultOption);

        const sortedValues = Array.from(uniqueValues).sort();
        sortedValues.forEach(value => {
            if (value) {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = value;
                selectElement.appendChild(option);
            }
        });

        if (Array.from(selectElement.options).some(option => option.value === currentSelectedValue)) {
            selectElement.value = currentSelectedValue;
        } else {
            selectElement.value = 'all';
        }
    }

    function populateFilterDropdowns() {
        populateDropdown('filterSupplier', uniqueSuppliers, document.getElementById('filterSupplier').value);
        populateDropdown('filterCOO', uniqueCOOs, document.getElementById('filterCOO').value);
        populateDropdown('filterHSCode', uniqueHSCodes, document.getElementById('filterHSCode').value);
        populateDropdown('filterStatus', uniqueStatuses, document.getElementById('filterStatus').value);
    }

    // ==================== FUNGSI UNTUK FORM TAMBAHAN DENGAN SEARCH (Autocomplete Generik) ====================

    // Fungsi debounce untuk menunda eksekusi fungsi
    function debounce(func, delay) {
        let timeout;
        return function(...args) {
            const context = this;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), delay);
        };
    }

    /**
     * Fungsi autocomplete generik yang mendukung hidden input untuk menyimpan nilai yang dipilih.
     * @param {HTMLInputElement} searchInput - Elemen input teks yang digunakan untuk pencarian.
     * @param {HTMLInputElement} hiddenInput - Elemen input hidden untuk menyimpan nilai yang dipilih.
     * @param {HTMLDivElement} suggestionsDiv - Elemen div untuk menampilkan saran.
     * @param {Array<Object>} dataList - Array objek dari nilai yang mungkin.
     * @param {string} displayProperty - Nama properti dari objek yang akan ditampilkan dan dicari.
     * @param {Function} [onSelectCallback] - Callback function to execute when an item is selected. Menerima objek item yang dipilih.
     */
    function setupSearchWithSuggestions(searchInput, hiddenInput, suggestionsDiv, dataList, displayProperty, onSelectCallback = null) {
        const MAX_SUGGESTIONS = 20;
        let currentFocus = -1;

        const processInput = () => {
            const val = searchInput.value.trim();
            suggestionsDiv.innerHTML = '';
            suggestionsDiv.classList.add('hidden');

            if (!val) {
                hiddenInput.value = '';
                return false;
            }
            currentFocus = -1;

            const filteredSuggestions = dataList
                .filter(item => {
                    const itemValue = item[displayProperty];
                    return itemValue && itemValue.toLowerCase().includes(val.toLowerCase());
                })
                .sort((a, b) => {
                    const valA = a[displayProperty];
                    const valB = b[displayProperty];
                    return valA.localeCompare(valB);
                })
                .slice(0, MAX_SUGGESTIONS);

            if (filteredSuggestions.length > 0) {
                filteredSuggestions.forEach(item => {
                    const itemValue = item[displayProperty];
                    const b = document.createElement("DIV");
                    b.classList.add("autocomplete-item");
                    const startIdx = itemValue.toLowerCase().indexOf(val.toLowerCase());
                    b.innerHTML = itemValue.substring(0, startIdx) + "<strong>" + itemValue.substring(startIdx, startIdx + val.length) + "</strong>" + itemValue.substring(startIdx + val.length);

                    b.addEventListener("click", function(e) {
                        e.stopPropagation();
                        searchInput.value = itemValue; // Set input teks dengan nilai yang ditampilkan
                        hiddenInput.value = itemValue; // Update hidden input dengan nilai yang ditampilkan
                        suggestionsDiv.classList.add('hidden');
                        if (onSelectCallback) {
                            onSelectCallback(item); // Kirim seluruh objek item yang dipilih
                        }
                    });
                    suggestionsDiv.appendChild(b);
                });
                suggestionsDiv.classList.remove('hidden');
            } else {
                suggestionsDiv.classList.add('hidden');
            }
        };

        const debouncedProcessInput = debounce(processInput, 300);

        const handleKeydown = (e) => {
            let x = suggestionsDiv.getElementsByClassName("autocomplete-item");
            if (e.keyCode == 40) {
                currentFocus++;
                addActive(x);
            } else if (e.keyCode == 38) {
                currentFocus--;
                addActive(x);
            } else if (e.keyCode == 13) {
                e.preventDefault();
                if (currentFocus > -1) {
                    if (x && x[currentFocus]) x[currentFocus].click();
                } else {
                    // Jika Enter ditekan dan tidak ada saran yang dipilih, gunakan nilai yang diketik
                    hiddenInput.value = searchInput.value;
                    suggestionsDiv.classList.add('hidden');
                    // Jika ada callback, panggil dengan objek sederhana yang hanya berisi properti yang dicari
                    if (onSelectCallback) {
                        onSelectCallback({ [displayProperty]: searchInput.value });
                    }
                }
            }
        };

        const handleBlur = () => {
            setTimeout(() => {
                const currentInputValue = searchInput.value.trim();
                if (currentInputValue !== '') {
                    hiddenInput.value = currentInputValue;
                } else {
                    hiddenInput.value = '';
                }
                suggestionsDiv.classList.add('hidden');
            }, 100);
        };

        const handleFocus = () => {
            if (searchInput.value.length > 0) {
                processInput();
            }
        };

        searchInput.removeEventListener('input', debouncedProcessInput);
        searchInput.removeEventListener('keydown', handleKeydown);
        searchInput.removeEventListener('blur', handleBlur);
        searchInput.removeEventListener('focus', handleFocus);

        searchInput.addEventListener('input', debouncedProcessInput);
        searchInput.addEventListener('keydown', handleKeydown);
        searchInput.addEventListener('blur', handleBlur);
        searchInput.addEventListener('focus', handleFocus);

        function addActive(x) {
            if (!x || x.length === 0) return false;
            removeActive(x);
            currentFocus = (currentFocus + x.length) % x.length;
            x[currentFocus].classList.add("autocomplete-active");
            x[currentFocus].scrollIntoView({ block: "nearest", inline: "nearest" });
        }

        function removeActive(x) {
            for (let i = 0; i < x.length; i++) {
                x[i].classList.remove("autocomplete-active");
            }
        }
    }

    // Fungsi global untuk menutup semua daftar saran autocomplete
    function closeAllAutocompleteSuggestions() {
        document.querySelectorAll(".suggestions-list").forEach(item => {
            item.classList.add('hidden');
            item.innerHTML = ''; // Clear content
        });
    }

    // Event listener global untuk menutup saran saat klik di luar
    document.addEventListener("click", function(e) {
        // Cek apakah target klik bukan bagian dari autocomplete
        let isAutocompleteClick = false;
        let target = e.target;
        while (target && target !== document.body) {
            if (target.classList.contains('autocomplete-items') || target.classList.contains('item-description-search') || target.classList.contains('pid-search-input')) {
                isAutocompleteClick = true;
                break;
            }
            target = target.parentNode;
        }
        if (!isAutocompleteClick) {
            closeAllAutocompleteSuggestions();
        }
    });

    // Fungsi untuk menambah field Item Description & Quantity baru
    function addItemField(item = { pid: '', description: '', quantity: '', coo: '', hsCode: '', revisiHS: '' }) {
        const itemsContainer = document.getElementById('items-container');
        const itemRow = document.createElement('div');
        itemRow.className = 'item-row';

        const uniqueId = `item-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;

        itemRow.innerHTML = `
            <div class="relative">
                <label class="block text-gray-700 text-xs font-semibold mb-1" for="${uniqueId}-pid-search">PID</label>
                <input type="text" id="${uniqueId}-pid-search" class="pid-search-input w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm" placeholder="Cari PID..." value="${item.pid}">
                <input type="hidden" id="${uniqueId}-pid-hidden" class="pid-hidden" value="${item.pid}">
                <div id="${uniqueId}-pid-suggestions" class="autocomplete-items suggestions-list"></div>
            </div>
            <div class="relative">
                <label class="block text-gray-700 text-xs font-semibold mb-1" for="${uniqueId}-description-search">Item Description</label>
                <input type="text" id="${uniqueId}-description-search" class="item-description-search w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm" placeholder="Cari atau ketik Item Description..." value="${item.description}">
                <input type="hidden" id="${uniqueId}-description-hidden" class="item-description-hidden" value="${item.description}">
                <div id="${uniqueId}-description-suggestions" class="autocomplete-items suggestions-list"></div>
            </div>
            <div>
                <label class="block text-gray-700 text-xs font-semibold mb-1" for="${uniqueId}-quantity">Qty</label>
                <input type="number" id="${uniqueId}-quantity" class="item-quantity w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm" placeholder="Qty" min="1" value="${item.quantity}">
            </div>
            <div>
                <label class="block text-gray-700 text-xs font-semibold mb-1" for="${uniqueId}-coo">COO</label>
                <select id="${uniqueId}-coo" class="item-coo w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm">
                    <option value="">Pilih COO</option>
                    <option value="China" ${item.coo === 'China' ? 'selected' : ''}>China</option>
                    <option value="USA" ${item.coo === 'USA' ? 'selected' : ''}>USA</option>
                    <option value="UK" ${item.coo === 'UK' ? 'selected' : ''}>UK</option>
                    <option value="Mexico" ${item.coo === 'Mexico' ? 'selected' : ''}>Mexico</option>
                    <option value="DLL" ${item.coo === 'DLL' ? 'selected' : ''}>DLL</option>
                </select>
            </div>
            <div>
                <label class="block text-gray-700 text-xs font-semibold mb-1" for="${uniqueId}-hsCode">HS Code</label>
                <input type="text" id="${uniqueId}-hsCode" class="item-hsCode w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm" value="${item.hsCode}">
            </div>
            <div>
                <label class="block text-gray-700 text-xs font-semibold mb-1" for="${uniqueId}-revisiHS">Revised HS Code</label>
                <input type="text" id="${uniqueId}-revisiHS" class="item-revisiHS w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm" value="${item.revisiHS}">
            </div>
            <div class="item-action-buttons">
                <button type="button" onclick="removeItemField(this)" class="text-red-500 hover:text-red-700 p-1"><i class="fas fa-times-circle"></i></button>
            </div>
        `;
        itemsContainer.appendChild(itemRow);

        const pidSearchInput = document.getElementById(`${uniqueId}-pid-search`);
        const pidHiddenInput = document.getElementById(`${uniqueId}-pid-hidden`);
        const pidSuggestionsDiv = document.getElementById(`${uniqueId}-pid-suggestions`);

        const itemDescriptionSearchInput = document.getElementById(`${uniqueId}-description-search`);
        const itemDescriptionHiddenInput = document.getElementById(`${uniqueId}-description-hidden`);
        const itemDescriptionSuggestionsDiv = document.getElementById(`${uniqueId}-description-suggestions`);

        // Callback function for PID selection
        const onPidSelect = (selectedItem) => {
            // Menggunakan 'description' karena itu adalah properti yang benar di JSON Anda
            if (selectedItem && selectedItem.description) {
                itemDescriptionSearchInput.value = selectedItem.description;
                itemDescriptionHiddenInput.value = selectedItem.description;
            } else {
                itemDescriptionSearchInput.value = '';
                itemDescriptionHiddenInput.value = '';
            }
        };

        // Setup autocomplete for PID, passing the productCatalog, 'pid' as displayProperty, and the new callback
        setupSearchWithSuggestions(pidSearchInput, pidHiddenInput, pidSuggestionsDiv, productCatalog, 'pid', onPidSelect);

        // Setup autocomplete for Item Description, passing the productCatalog, 'description' as displayProperty
        setupSearchWithSuggestions(itemDescriptionSearchInput, itemDescriptionHiddenInput, itemDescriptionSuggestionsDiv, productCatalog, 'description');
    }

    // Fungsi untuk menghapus field Item Description & Quantity
    function removeItemField(button) {
        button.closest('.item-row').remove();
    }

    // Membuka modal PO (untuk tambah atau edit)
    async function openPOModal(poId = null) {
        const poModal = document.getElementById('poModal');
        const modalTitle = document.getElementById('modalTitle');
        const poForm = document.getElementById('poForm');

        poForm.reset();
        document.getElementById('poId').value = '';
        document.getElementById('items-container').innerHTML = ''; // Clear all item rows

        document.getElementById('status').value = DEFAULT_STATUS;

        // NEW: Tutup semua saran autocomplete yang mungkin terbuka
        closeAllAutocompleteSuggestions();

        if (poId) {
            modalTitle.textContent = 'Edit PO';
            const po = pos.find(p => p.id === poId);
            if (po) {
                document.getElementById('poId').value = po.id;
                document.getElementById('noPO').value = po.noPO || '';
                document.getElementById('supplierName').value = po.supplierName || '';
                document.getElementById('allocation').value = po.allocation || '';
                document.getElementById('invoice').value = po.invoice || '';
                document.getElementById('value').value = po.value || '';

                if (po.items && po.items.length > 0) {
                    po.items.forEach(item => addItemField(item)); // Pass entire item object
                } else {
                    addItemField(); // Tambahkan satu field kosong jika tidak ada item
                }

                document.getElementById('tracking').value = po.tracking || '';
                document.getElementById('forwarderName').value = po.forwarderName || '';
                document.getElementById('freightType').value = po.freightType || '';
                document.getElementById('disrc').value = po.disrc || '';

                document.getElementById('status').value = po.status || DEFAULT_STATUS;
                document.getElementById('planDelivery').value = po.planDelivery instanceof Date ? po.planDelivery.toISOString().split('T')[0] : '';
                document.getElementById('eta').value = po.eta instanceof Date ? po.eta.toISOString().split('T')[0] : '';
                document.getElementById('actualDelivery').value = po.actualDelivery instanceof Date ? po.actualDelivery.toISOString().split('T')[0] : '';

                document.getElementById('note').value = po.note || '';
            }
        } else {
            modalTitle.textContent = 'Tambah PO Baru';
            addItemField(); // Tambahkan satu field kosong untuk PO baru
        }

        poModal.classList.remove('hidden');
    }

    function closePOModal() {
        const poModal = document.getElementById('poModal');
        if (!poModal) return;
        poModal.classList.add('hidden');
        // Tutup semua daftar autocomplete yang mungkin terbuka saat modal ditutup
        closeAllAutocompleteSuggestions();
    }

    // Menyimpan data PO ke Firestore
    async function savePO() {
        const poId = document.getElementById('poId').value;
        const noPO = document.getElementById('noPO').value;

        if (!noPO) {
            showCustomAlert("PO Number harus diisi.", "error");
            return;
        }

        closePOModal();
        showGlobalLoading();

        const supplierName = document.getElementById('supplierName').value;
        const allocation = document.getElementById('allocation').value;
        const invoice = document.getElementById('invoice').value;
        const value = document.getElementById('value').value;

        const itemsToSave = [];
        document.querySelectorAll('.item-row').forEach(row => {
            const pid = row.querySelector('.pid-hidden').value;
            const description = row.querySelector('.item-description-hidden').value;
            const quantity = row.querySelector('.item-quantity').value;
            const coo = row.querySelector('.item-coo').value;
            const hsCode = row.querySelector('.item-hsCode').value;
            const revisiHS = row.querySelector('.item-revisiHS').value;

            if (pid || description || quantity || coo || hsCode || revisiHS) { // Only save if at least one field is filled
                itemsToSave.push({
                    pid: pid,
                    description: description,
                    quantity: parseInt(quantity) || 0,
                    coo: coo,
                    hsCode: hsCode,
                    revisiHS: revisiHS
                });

                // NEW: Add new PID/Description to productCatalog if not already present
                const existingProduct = productCatalog.find(p => p.pid === pid);
                if (pid && description && !existingProduct) {
                    productCatalog.push({ pid: pid, description: description });
                    console.log(`New product {pid: "${pid}", description: "${description}"} added to local catalog.`);
                } else if (pid && description && existingProduct && existingProduct.description !== description) {
                    // Optionally update description if PID exists but description is different
                    existingProduct.description = description;
                    console.log(`Updated description for PID "${pid}" in local catalog.`);
                }
            }
        });

        const tracking = document.getElementById('tracking').value;
        const forwarderName = document.getElementById('forwarderName').value;
        const freightType = document.getElementById('freightType').value;
        const disrc = document.getElementById('disrc').value;

        const planDelivery = document.getElementById('planDelivery').value ? firebase.firestore.Timestamp.fromDate(new Date(document.getElementById('planDelivery').value)) : null;
        const eta = document.getElementById('eta').value ? firebase.firestore.Timestamp.fromDate(new Date(document.getElementById('eta').value)) : null;
        const actualDelivery = document.getElementById('actualDelivery').value ? firebase.firestore.Timestamp.fromDate(new Date(document.getElementById('actualDelivery').value)) : null;

        const note = document.getElementById('note').value;
        const status = document.getElementById('status').value;

        const poData = {
            noPO: noPO,
            supplierName: supplierName,
            allocation: allocation,
            invoice: invoice,
            value: value,
            items: itemsToSave, // Now an array of objects with more details
            tracking: tracking,
            forwarderName: forwarderName,
            freightType: freightType,
            disrc: disrc,
            planDelivery: planDelivery,
            eta: eta,
            actualDelivery: actualDelivery,
            note: note,
            status: status,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        try {
            if (poId) {
                await dealsCollection.doc(poId).update(poData);
                showCustomAlert("PO berhasil diperbarui!", "success");
            } else {
                poData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                poData.createdBy = auth.currentUser.email;
                await dealsCollection.add(poData);
                showCustomAlert("PO baru berhasil ditambahkan!", "success");
            }
        } catch (error) {
            console.error("Error saving PO:", error);
            showCustomAlert("Gagal menyimpan PO. Silakan coba lagi.", "error");
        } finally {
            hideGlobalLoading();
        }
    }

    function prepareEditPO(poId) {
        openPOModal(poId);
    }

    let poToDeleteId = null;
    let poToDeleteNo = '';

    function confirmDeletePO(poId, poNo) {
        poToDeleteId = poId;
        poToDeleteNo = poNo;
        document.getElementById('dealToDeleteName').textContent = poNo;
        document.getElementById('deleteModal').classList.remove('hidden');
    }

    async function deletePO() {
        if (!poToDeleteId) return;

        closeDeleteModal();
        showGlobalLoading();

        try {
            await dealsCollection.doc(poToDeleteId).delete();
            showCustomAlert(`PO "${poToDeleteNo}" berhasil dihapus!`, "success");
        } catch (error) {
            console.error("Error deleting PO:", error);
            showCustomAlert("Gagal menghapus PO. Silakan coba lagi.", "error");
        } finally {
            hideGlobalLoading();
        }
    }

    async function updatePOStatus(poId, newStatus) {
        showGlobalLoading();
        try {
            await dealsCollection.doc(poId).update({
                status: newStatus,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            showCustomAlert(`Status PO berhasil diperbarui menjadi "${newStatus}"!`, "success");
        } catch (error) {
            console.error("Error updating PO status:", error);
            showCustomAlert("Gagal memperbarui status PO. Silakan coba lagi.", "error");
        } finally {
            hideGlobalLoading();
        }
    }

    // Membuka modal detail PO
    function openPODetailModal(poId) {
        const po = pos.find(p => p.id === poId);
        if (!po) {
            showCustomAlert("Detail PO tidak ditemukan.", "error");
            return;
        }

        document.getElementById('poDetailTitle').textContent = po.noPO || 'Detail PO';
        document.getElementById('detailNoPO').textContent = po.noPO || '-';
        document.getElementById('detailSupplierName').textContent = po.supplierName || '-';
        document.getElementById('detailAllocation').textContent = po.allocation || '-';
        document.getElementById('detailInvoice').textContent = po.invoice || '-';
        document.getElementById('detailValue').textContent = po.value || '-';
        document.getElementById('detailTracking').textContent = po.tracking || '-';
        document.getElementById('detailForwarderName').textContent = po.forwarderName || '-';
        document.getElementById('detailFreightType').textContent = po.freightType || '-';
        document.getElementById('detailDisrc').textContent = po.disrc || '-';
        document.getElementById('detailStatus').textContent = po.status || '-';
        document.getElementById('detailPlanDelivery').textContent = po.planDelivery ? formatDate(po.planDelivery) : '-';
        document.getElementById('detailETA').textContent = po.eta ? formatDate(po.eta) : '-';
        document.getElementById('detailActualDelivery').textContent = po.actualDelivery ? formatDate(po.actualDelivery) : '-';
        document.getElementById('detailNote').textContent = po.note || '-';

        // Populate Document Checklist in Detail Modal
        const detailDocumentChecklist = document.getElementById('detailDocumentChecklist');
        detailDocumentChecklist.innerHTML = `
            <p><span class="font-semibold text-gray-700">OC/OA:</span> ${po.docChecklist_OC_OA || '-'}</p>
            <p><span class="font-semibold text-gray-700">PI:</span> ${po.docChecklist_PI || '-'}</p>
            <p><span class="font-semibold text-gray-700">CI:</span> ${po.docChecklist_CI || '-'}</p>
            <p><span class="font-semibold text-gray-700">PL:</span> ${po.docChecklist_PL || '-'}</p>
            <p><span class="font-semibold text-gray-700">COO:</span> ${po.docChecklist_COO || '-'}</p>
            <p><span class="font-semibold text-gray-700">COC:</span> ${po.docChecklist_COC || '-'}</p>
            <p><span class="font-semibold text-gray-700">PIB:</span> ${po.docChecklist_PIB || '-'}</p>
            <p><span class="font-semibold text-gray-700">SPPB:</span> ${po.docChecklist_SPPB || '-'}</p>
            <p><span class="font-semibold text-gray-700">Hardcopy:</span> ${po.docChecklist_Hardcopy || '-'}</p>
            <p><span class="font-semibold text-gray-700">Softcopy:</span> ${po.docChecklist_Softcopy || '-'}</p>
            <p><span class="font-semibold text-gray-700">Prepared By:</span> ${po.docChecklist_PreparedBy || '-'}</p>
            <p><span class="font-semibold text-gray-700">Order By:</span> ${po.docChecklist_OrderBy || '-'}</p>
        `;

        const detailItemsList = document.getElementById('detailItemsList');
        detailItemsList.innerHTML = '';
        if (po.items && po.items.length > 0) {
            po.items.forEach(item => {
                const itemDetailDiv = document.createElement('div');
                itemDetailDiv.className = 'grid grid-cols-1 md:grid-cols-3 gap-x-4 gap-y-1 border-b border-gray-100 pb-2 mb-2 last:border-b-0';
                itemDetailDiv.innerHTML = `
                    <p class="text-gray-900"><span class="font-semibold text-gray-700">PID:</span> ${item.pid || '-'}</p>
                    <p class="text-gray-900"><span class="font-semibold text-gray-700">Item Description:</span> ${item.description || '-'}</p>
                    <p class="text-gray-900"><span class="font-semibold text-gray-700">Qty:</span> ${item.quantity || '-'}</p>
                    <p class="text-gray-900"><span class="font-semibold text-gray-700">COO:</span> ${item.coo || '-'}</p>
                    <p class="text-gray-900"><span class="font-semibold text-gray-700">HS Code:</span> ${item.hsCode || '-'}</p>
                    <p class="text-gray-900"><span class="font-semibold text-gray-700">Revised HS Code:</span> ${item.revisiHS || '-'}</p>
                `;
                detailItemsList.appendChild(itemDetailDiv);
            });
        } else {
            detailItemsList.innerHTML = '<p class="text-gray-700">- Tidak ada detail barang -</p>';
        }

        document.getElementById('poDetailModal').classList.remove('hidden');
    }

    function closePODetailModal() {
        const poDetailModal = document.getElementById('poDetailModal');
        if (!poDetailModal) return;
        poDetailModal.classList.add('hidden');
    }

    // ==================== FUNGSI SORTABLE ====================

    function initSortable() {
        const pipelineStage = document.getElementById('pos-stage');
        if (!pipelineStage) return;
        console.log("SortableJS is disabled.");
    }

    // ==================== FUNGSI PERMISSIONS ====================

    function applyUserPermissions() {
        try {
            const isAdmin = currentUserRole === 'admin';

            console.log("Applying permissions for Role:", currentUserRole);

            const newPOBtn = document.getElementById('newPOBtn');
            const documentChecklistBtn = document.getElementById('documentChecklistBtn');
            const exportExcelBtn = document.getElementById('exportExcelBtn');
            const searchInput = document.getElementById('searchPOs');
            const openFilterPanelBtn = document.getElementById('openFilterPanelBtn');
            const backButton = document.getElementById('backButton');
            const authButton = document.getElementById('authButton');

            if (newPOBtn) newPOBtn.classList.remove('hidden');
            if (documentChecklistBtn) documentChecklistBtn.classList.remove('hidden');
            if (exportExcelBtn) exportExcelBtn.classList.remove('hidden');
            if (backButton) backButton.classList.remove('hidden');
            if (authButton) authButton.classList.remove('hidden');

            if (searchInput) searchInput.classList.remove('hidden');
            if (openFilterPanelBtn) openFilterPanelBtn.classList.remove('hidden');

        } catch (error) {
            console.error("Error in applyUserPermissions:", error);
            showCustomAlert("Gagal menerapkan permissions", "error");
        }
    }

    // ==================== FUNGSI EVENT LISTENERS ====================

    function initEventListeners() {
        console.log("Initializing event listeners...");

        try {
            const poForm = document.getElementById('poForm');
            if (poForm) {
                poForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    savePO();
                });
            }

            const documentChecklistForm = document.getElementById('documentChecklistForm');
            if (documentChecklistForm) {
                documentChecklistForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    saveDocumentChecklist(); // Call new function to save checklist
                });
            }

            const buttons = [
                { id: 'newPOBtn', func: openPOModal },
                { id: 'documentChecklistBtn', func: openDocumentChecklistModal },
                { id: 'exportExcelBtn', func: exportToExcel },
                { id: 'backButton', func: goToIndex },
                { id: 'authButton', func: logout },
                { id: 'openFilterPanelBtn', func: openFilterPanel }
            ];

            buttons.forEach(btn => {
                const element = document.getElementById(btn.id);
                if (element) {
                    element.removeEventListener('click', btn.func);
                    element.addEventListener('click', btn.func);
                    element.addEventListener('click', createRipple);
                    console.log(`Event listener added for ${btn.id}`);
                }
            });

            const searchInput = document.getElementById('searchPOs');
            if (searchInput) {
                searchInput.removeEventListener('keyup', filterPOs);
                searchInput.addEventListener('keyup', filterPOs);
            }
        } catch (error) {
            console.error("Error initializing event listeners:", error);
            showCustomAlert("Gagal memuat beberapa fungsi", "error");
        }
    }

    function createRipple(event) {
        const button = event.currentTarget;
        const circle = document.createElement('span');
        const diameter = Math.max(button.clientWidth, button.clientHeight);
        const radius = diameter / 2;

        circle.style.width = circle.style.height = `${diameter}px`;
        circle.style.left = `${event.clientX - (button.getBoundingClientRect().left + radius)}px`;
        circle.style.top = `${event.clientY - (button.getBoundingClientRect().top + radius)}px`;
        circle.classList.add('ripple');

        const ripple = button.getElementsByClassName('ripple')[0];

        if (ripple) {
            ripple.remove();
        }

        button.appendChild(circle);
    }

    // ==================== FUNGSI LAINNYA ====================

    function filterPOs() {
        try {
            const searchTerm = document.getElementById('searchPOs').value.toLowerCase();
            const supplierFilter = document.getElementById('filterSupplier').value;
            const cooFilter = document.getElementById('filterCOO').value;
            const hsCodeFilter = document.getElementById('filterHSCode').value;
            const statusFilter = document.getElementById('filterStatus').value;

            let basePOs = pos;

            const filteredPOs = basePOs.filter(po => {
                const matchesSearch =
                    (po.noPO && po.noPO.toLowerCase().includes(searchTerm)) ||
                    (po.supplierName && po.supplierName.toLowerCase().includes(searchTerm)) ||
                    (po.items && po.items.some(item =>
                        (item.pid && item.pid.toLowerCase().includes(searchTerm)) ||
                        (item.description && item.description.toLowerCase().includes(searchTerm))
                    ));

                const matchesSupplier =
                    supplierFilter === 'all' ||
                    (po.supplierName && po.supplierName === supplierFilter);

                const matchesCOO =
                    cooFilter === 'all' ||
                    (po.items && po.items.some(item => item.coo && item.coo === cooFilter));

                const matchesHSCode =
                    hsCodeFilter === 'all' ||
                    (po.items && po.items.some(item => item.hsCode && item.hsCode === hsCodeFilter));

                const matchesStatus =
                    statusFilter === 'all' ||
                    (po.status && po.status === statusFilter);

                return matchesSearch && matchesSupplier && matchesCOO && matchesHSCode && matchesStatus;
            });

            renderFilteredPOs(filteredPOs);
        } catch (error) {
            console.error("Error filtering POs:", error);
        }
    }

    function renderFilteredPOs(filteredPOs) {
        const pipelineStage = document.getElementById('pos-stage');
        if (!pipelineStage) return;

        pipelineStage.innerHTML = '';

        if (filteredPOs.length === 0) {
            pipelineStage.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-search"></i>
                    <p>Tidak ada PO yang sesuai dengan filter.</p>
                </div>
            `;
            return;
        }

        filteredPOs.forEach((po, index) => {
            const poCard = renderPO(po, index);
            pipelineStage.appendChild(poCard);
            setTimeout(() => {
                poCard.classList.add('show');
            }, 50 * index);
        });
    }

    function logout() {
        if (unsubscribeFromPOs) {
            unsubscribeFromPOs();
            unsubscribeFromPOs = null;
        }
        auth.signOut()
            .then(() => {
                console.log("User logged out successfully");
                pos = [];
                window.location.href = 'login.html';
            })
            .catch((error) => {
                console.error("Error logging out:", error);
                showCustomAlert("Gagal logout. Silakan coba lagi.", "error");
            });
    }

    function goToIndex() {
        window.location.href = 'index.html';
    }

    function openFilterPanel() {
        const filterPanel = document.getElementById('filterPanel');
        if (!filterPanel) {
            console.error("Elemen panel filter tidak ditemukan.");
            showCustomAlert("Gagal membuka filter: Elemen tidak lengkap.", "error");
            return;
        }

        populateFilterDropdowns();

        filterPanel.classList.remove('hidden');
    }

    function closeFilterPanel() {
        const filterPanel = document.getElementById('filterPanel');
        if (!filterPanel) {
            console.error("Elemen filterPanelContent tidak ditemukan saat menutup modal.");
            return;
        }
        filterPanel.classList.add('hidden');
    }

    function applyFiltersAndClosePanel() {
        filterPOs();
        closeFilterPanel();
    }

    function resetFilters() {
        document.getElementById('filterSupplier').value = 'all';
        document.getElementById('filterCOO').value = 'all';
        document.getElementById('filterHSCode').value = 'all';
        document.getElementById('filterStatus').value = 'all';
        document.getElementById('searchPOs').value = '';
        filterPOs();
    }

    function closeDeleteModal() {
        const deleteModal = document.getElementById('deleteModal');
        if (!deleteModal) return;
        deleteModal.classList.add('hidden');
    }

    // NEW: Document Checklist Modal functions
    function openDocumentChecklistModal() {
        const documentChecklistModal = document.getElementById('documentChecklistModal');
        if (documentChecklistModal) {
            // Optionally, load existing checklist data if editing a PO
            // For now, it's a generic checklist, not tied to a specific PO
            documentChecklistModal.classList.remove('hidden');
        }
    }

    function closeDocumentChecklistModal() {
        const documentChecklistModal = document.getElementById('documentChecklistModal');
        if (documentChecklistModal) {
            documentChecklistModal.classList.add('hidden');
        }
    }

    // NEW: Function to save Document Checklist (example, needs actual implementation)
    async function saveDocumentChecklist() {
        showGlobalLoading();
        try {
            // In a real application, you would save this data to Firestore
            // For now, we'll just simulate a save and show a success message.
            const checklistData = {
                OC_OA: document.getElementById('docChecklist_OC_OA').value,
                PI: document.getElementById('docChecklist_PI').value,
                CI: document.getElementById('docChecklist_CI').value,
                PL: document.getElementById('docChecklist_PL').value,
                COO: document.getElementById('docChecklist_COO').value,
                COC: document.getElementById('docChecklist_COC').value,
                PIB: document.getElementById('docChecklist_PIB').value,
                SPPB: document.getElementById('docChecklist_SPPB').value,
                Hardcopy: document.getElementById('docChecklist_Hardcopy').value,
                Softcopy: document.getElementById('docChecklist_Softcopy').value,
                PreparedBy: document.getElementById('docChecklist_PreparedBy').value,
                OrderBy: document.getElementById('docChecklist_OrderBy').value,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            console.log("Saving Document Checklist:", checklistData);
            // Example: Save to a 'documentChecklists' collection or update a specific PO's checklist
            // await db.collection('documentChecklists').add(checklistData);
            // For now, we'll just show success.

            showCustomAlert("Document Checklist berhasil disimpan!", "success");
            closeDocumentChecklistModal();
        } catch (error) {
            console.error("Error saving Document Checklist:", error);
            showCustomAlert("Gagal menyimpan Document Checklist. Silakan coba lagi.", "error");
        } finally {
            hideGlobalLoading();
        }
    }


    // ==================== FUNGSI EXPORT TO EXCEL ====================
    function exportToExcel() {
        showGlobalLoading();
        try {
            const data = [];
            const headers = [
                "No. Urut", "PO Number", "Vendor", "Allocation", "Invoice Number", "Value",
                "PID", "Item Description", "Qty", "COO (Item)", "HS Code (Item)", "Revised HS Code (Item)",
                "AWB/Tracking Number", "Nama Forwarder", "Jenis Freight", "DISRC",
                "Order Status", "Plan Delivery", "ETA", "Actual Delivery",
                "Note", "Dibuat Oleh", "Tanggal Dibuat",
                // Document Checklist Headers
                "Doc Checklist OC/OA", "Doc Checklist PI", "Doc Checklist CI", "Doc Checklist PL",
                "Doc Checklist COO", "Doc Checklist COC", "Doc Checklist PIB", "Doc Checklist SPPB",
                "Doc Checklist Hardcopy", "Doc Checklist Softcopy", "Doc Checklist Prepared By", "Doc Checklist Order By"
            ];
            data.push(headers);

            const currentPOs = pos.filter(po => {
                const searchTerm = document.getElementById('searchPOs').value.toLowerCase();
                const supplierFilter = document.getElementById('filterSupplier').value;
                const cooFilter = document.getElementById('filterCOO').value;
                const hsCodeFilter = document.getElementById('filterHSCode').value;
                const statusFilter = document.getElementById('filterStatus').value;

                const matchesSearch =
                    (po.noPO && po.noPO.toLowerCase().includes(searchTerm)) ||
                    (po.supplierName && po.supplierName.toLowerCase().includes(searchTerm)) ||
                    (po.items && po.items.some(item =>
                        (item.pid && item.pid.toLowerCase().includes(searchTerm)) ||
                        (item.description && item.description.toLowerCase().includes(searchTerm))
                    ));

                const matchesSupplier =
                    supplierFilter === 'all' ||
                    (po.supplierName && po.supplierName === supplierFilter);

                const matchesCOO =
                    cooFilter === 'all' ||
                    (po.items && po.items.some(item => item.coo && item.coo === cooFilter));

                const matchesHSCode =
                    hsCodeFilter === 'all' ||
                    (po.items && po.items.some(item => item.hsCode && item.hsCode === hsCodeFilter));

                const matchesStatus =
                    statusFilter === 'all' ||
                    (po.status && po.status === statusFilter);

                return matchesSearch && matchesSupplier && matchesCOO && matchesHSCode && matchesStatus;
            });

            currentPOs.forEach((po, index) => {
                const baseRow = [
                    index + 1,
                    po.noPO || '',
                    po.supplierName || '',
                    po.allocation || '',
                    po.invoice || '',
                    po.value || '',
                    // Item details will be added per item
                    '', '', '', '', '', '',
                    po.tracking || '',
                    po.forwarderName || '',
                    po.freightType || '',
                    po.disrc || '',
                    po.status ? po.status.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : '',
                    po.planDelivery ? formatDate(po.planDelivery) : '',
                    po.eta ? formatDate(po.eta) : '',
                    po.actualDelivery ? formatDate(po.actualDelivery) : '',
                    po.note || '',
                    po.createdBy || '',
                    po.createdAt ? formatDateTime(po.createdAt) : '',
                    // Document Checklist values
                    po.docChecklist_OC_OA || '',
                    po.docChecklist_PI || '',
                    po.docChecklist_CI || '',
                    po.docChecklist_PL || '',
                    po.docChecklist_COO || '',
                    po.docChecklist_COC || '',
                    po.docChecklist_PIB || '',
                    po.docChecklist_SPPB || '',
                    po.docChecklist_Hardcopy || '',
                    po.docChecklist_Softcopy || '',
                    po.docChecklist_PreparedBy || '',
                    po.docChecklist_OrderBy || ''
                ];

                if (po.items && po.items.length > 0) {
                    po.items.forEach(item => {
                        const itemRow = [...baseRow]; // Copy base row
                        itemRow[6] = item.pid || ''; // PID
                        itemRow[7] = item.description || ''; // Item Description
                        itemRow[8] = item.quantity || ''; // Qty
                        itemRow[9] = item.coo || ''; // COO (Item)
                        itemRow[10] = item.hsCode || ''; // HS Code (Item)
                        itemRow[11] = item.revisiHS || ''; // Revised HS Code (Item)
                        data.push(itemRow);
                    });
                } else {
                    // If no items, push the base row with empty item details
                    data.push(baseRow);
                }
            });

            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Purchase Orders");

            const fileName = `Purchase_Orders_${new Date().toISOString().slice(0,10)}.xlsx`;
            XLSX.writeFile(wb, fileName);
            showCustomAlert("Data PO berhasil diekspor ke Excel!", "success");

        } catch (error) {
            console.error("Error exporting to Excel:", error);
            showCustomAlert("Gagal mengekspor data ke Excel.", "error");
        } finally {
            hideGlobalLoading();
        }
    }

    // ==================== INISIALISASI ====================

    document.addEventListener('DOMContentLoaded', function() {
        initSortable();
    });
</script>
</body>
</html>
