<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Purchase Order Monitoring - Genetek</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Warna latar belakang yang lebih lembut */
            color: #334155; /* Warna teks default */
        }
        .pipeline-stage {
            min-height: 480px;
            max-height: 600px;
            transition: all 0.4s ease-out; /* Transisi lebih halus */
            border-radius: 0.75rem;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            background-color: #ffffff;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08); /* Bayangan lebih dalam */
            box-sizing: border-box;
        }
        .pipeline-stage-header {
            padding: 1.25rem;
            border-bottom: 1px solid #e2e8f0;
            background-color: #f8fafc; /* Warna header yang lebih terang */
            display: flex;
            flex-direction: column;
            align-items: center; /* Mengubah dari flex-start menjadi center */
            gap: 0.25rem;
        }
        .pipeline-stage-header h3 {
            font-size: 1.1rem; /* Ukuran font sedikit lebih besar */
            font-weight: 700;
            color: #1e293b; /* Warna teks yang lebih gelap */
            flex-shrink: 0;
            text-align: center; /* Tambahkan ini untuk menengahkan teks */
            width: 100%; /* Pastikan mengambil lebar penuh untuk penengahan */
        }
        .pipeline-stage-header span {
            font-size: 0.8rem; /* Ukuran font sedikit lebih besar */
            font-weight: 600;
            white-space: nowrap;
            color: #64748b; /* Warna teks yang lebih lembut */
        }
        .pipeline-stage-content {
            flex-grow: 1;
            padding: 1rem;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            min-height: 100px;
            height: 100%;
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-content: flex-start;
        }
        .deal-card {
            transition: transform 0.3s ease-out, box-shadow 0.3s ease-out, opacity 0.3s ease-out; /* Animasi lebih halus */
            cursor: grab;
            position: relative;
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 0.65rem; /* Border radius sedikit lebih besar */
            padding: 0.9rem; /* Padding sedikit lebih besar */
            margin-bottom: 0;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.06); /* Bayangan lebih jelas */
            font-size: 0.875rem;
            width: calc(33.333% - 0.666rem);
            min-width: 280px; /* Min-width sedikit lebih besar */
            box-sizing: border-box;
            opacity: 0; /* Default hidden for animation */
            transform: translateY(20px); /* Default position for animation */
        }
        .deal-card.show {
            opacity: 1;
            transform: translateY(0);
        }
        .deal-card:hover {
            transform: translateY(-5px); /* Efek hover lebih dramatis */
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.18); /* Bayangan hover lebih kuat */
        }
        .deal-card:active {
            cursor: grabbing;
        }
        .sortable-ghost {
            opacity: 0.3; /* Opacity lebih rendah */
            background-color: #e0f7fa; /* Warna ghost yang lebih cerah */
            border: 1px dashed #80deea; /* Border yang lebih cerah */
        }
        .sortable-chosen {
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.25); /* Bayangan chosen lebih kuat */
            transform: scale(1.03); /* Skala sedikit lebih besar */
        }
        .sortable-drag {
            opacity: 0.95; /* Opacity lebih tinggi saat drag */
        }
        .stage-main-pipeline { border-left: 6px solid #3b82f6; /* Border lebih tebal */ }
        .pipeline-stage-content::-webkit-scrollbar {
            width: 8px;
        }
        .pipeline-stage-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .pipeline-stage-content::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        .pipeline-stage-content::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        .modal-content-enter {
            opacity: 0;
            transform: scale(0.9); /* Skala awal lebih kecil */
        }
        .modal-content-enter-active {
            opacity: 1;
            transform: scale(1);
            transition: opacity 0.4s cubic-bezier(0.25, 0.8, 0.25, 1), transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); /* Kurva transisi yang lebih baik */
        }
        .modal-content-leave {
            opacity: 1;
            transform: scale(1);
        }
        .modal-content-leave-active {
            opacity: 0;
            transform: scale(0.9); /* Skala akhir lebih kecil */
            transition: opacity 0.4s cubic-bezier(0.25, 0.8, 0.25, 1), transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        #toast-container {
            position: fixed;
            top: 1.5rem; /* Posisi sedikit lebih rendah */
            right: 1.5rem; /* Posisi sedikit lebih ke kiri */
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 0.75rem; /* Jarak antar toast lebih besar */
        }
        .toast {
            background-color: #333;
            color: white;
            padding: 0.9rem 1.5rem; /* Padding lebih besar */
            border-radius: 0.65rem; /* Border radius lebih besar */
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.25); /* Bayangan lebih kuat */
            opacity: 0;
            transform: translateX(120%); /* Animasi masuk lebih jauh */
            transition: opacity 0.4s ease-out, transform 0.4s ease-out;
        }
        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }
        /* #activityModalContent { Dihapus } */
        /* .activity-item { Dihapus } */
        
        /* Penyesuaian CSS untuk deal card yang lebih ringkas */
        .deal-card h3 {
            font-size: 1rem; /* Ukuran font sedikit lebih besar */
            font-weight: 700;
            color: #1f2937;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: calc(100% - 60px);
        }

        .priority-badge {
            font-size: 0.7rem; /* Ukuran font sedikit lebih besar */
            padding: 0.2rem 0.5rem; /* Padding sedikit lebih besar */
            line-height: 1;
            border-radius: 9999px; /* Bentuk pil */
            font-weight: 600;
        }

        .deal-details p {
            font-size: 0.8rem; /* Ukuran font sedikit lebih besar */
            margin-top: 0.2rem; /* Margin sedikit lebih besar */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: #4b5563; /* Warna teks yang lebih gelap */
        }

        .deal-details p i {
            font-size: 0.75rem; /* Ukuran font sedikit lebih besar */
            color: #6b7280; /* Warna ikon yang lebih lembut */
        }

        .deal-actions button {
            padding: 0.2rem 0.4rem; /* Padding lebih besar */
            font-size: 0.75rem; /* Ukuran font sedikit lebih besar */
            border-radius: 0.375rem; /* Border radius lebih besar */
            transition: background-color 0.2s ease-out, transform 0.2s ease-out;
        }
        .deal-actions button:hover {
            transform: translateY(-1px);
        }
        .deal-actions button i {
            font-size: 0.75rem; /* Ukuran font sedikit lebih besar */
        }

        .deal-footer {
            margin-top: 0.75rem; /* Margin lebih besar */
            padding-top: 0.5rem;
            border-top: 1px solid #f3f4f6; /* Garis pemisah yang lebih halus */
        }

        /* Media Queries untuk responsivitas */
        @media (max-width: 1024px) {
            .deal-card {
                width: calc(50% - 0.5rem);
                min-width: 280px;
            }
        }

        @media (max-width: 768px) {
            .deal-card {
                width: 100%;
                min-width: unset; /* Hapus min-width di mobile */
            }
            .max-w-7xl {
                padding-left: 1rem;
                padding-right: 1rem;
            }
            .header {
                flex-direction: column;
                align-items: flex-start;
            }
            .header > div:last-child {
                margin-top: 1rem;
                width: 100%;
                flex-direction: column;
                align-items: stretch;
                gap: 0.75rem;
            }
            .header button {
                width: 100%;
                justify-content: center;
            }
            .header .flex-col.sm\:flex-row {
                flex-direction: column;
            }
            .header .sm\:w-1\/2 {
                width: 100%;
            }
        }

        /* Penyesuaian untuk modal Tambah/Edit PO */
        #poModalContent {
            max-height: 100vh; /* Disesuaikan menjadi 100% tinggi viewport */
            max-width: 100vw; /* Disesuaikan menjadi 100% lebar viewport */
            width: 100%; /* Mengambil lebar 100% */
            height: 100%; /* Mengambil tinggi 100% */
            border-radius: 0; /* Hapus border-radius agar lebih menyatu dengan layar */
            box-sizing: border-box;
            padding: 2rem; /* Padding lebih besar */
            box-shadow: none; /* Hapus bayangan untuk tampilan fullscreen */
            overflow-y: auto; /* Tambahkan scroll jika konten melebihi tinggi layar */
        }

        /* Menyamakan tinggi input dan select */
        #poForm input[type="text"],
        #poForm input[type="number"],
        #poForm input[type="date"],
        #poForm select,
        #poForm textarea {
            height: 44px; /* Disesuaikan */
            padding: 0.65rem 1rem; /* Disesuaikan */
            box-sizing: border-box;
            font-size: 0.9rem; /* Disesuaikan */
            border-width: 1px;
            border-color: #d1d5db; /* Warna border yang lebih lembut */
            border-radius: 0.5rem; /* Border radius lebih besar */
            transition: border-color 0.2s ease-out, box-shadow 0.2s ease-out;
        }
        #poForm input:focus,
        #poForm select:focus,
        #poForm textarea:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25); /* Efek fokus yang lebih jelas */
            outline: none;
        }

        /* Menyesuaikan tinggi textarea note */
        #note {
            height: 120px; /* Disesuaikan */
            resize: vertical;
        }

        /* Menyesuaikan ukuran font label */
        #poForm label {
            font-size: 0.8rem; /* Disesuaikan */
            margin-bottom: 0.25rem; /* Disesuaikan */
            color: #4a5568; /* Warna label yang lebih gelap */
        }

        /* Menyesuaikan ukuran font judul modal */
        #poModalContent h2 {
            font-size: 1.8rem; /* Disesuaikan */
            margin-bottom: 1.5rem; /* Disesuaikan */
            color: #1e293b;
            font-weight: 800;
        }

        /* CSS untuk modal detail PO 3 kolom */
        #poDetailModalContent .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); /* Lebih fleksibel, 3 kolom */
            gap: 1.25rem; /* Jarak antar kolom dan baris lebih besar */
        }
        #poDetailModalContent .detail-item p {
            font-size: 0.9rem;
            line-height: 1.4;
        }
        #poDetailModalContent .detail-item p:first-child {
            font-size: 0.8rem;
            color: #64748b;
            margin-bottom: 0.2rem;
        }

        /* Loading Spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3b82f6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            transition: opacity 0.3s ease-out;
            opacity: 0;
            pointer-events: none;
        }
        .loading-overlay.show {
            opacity: 1;
            pointer-events: all;
        }

        /* Empty State Styling */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #94a3b8;
            font-size: 1rem;
            animation: fadeIn 0.5s ease-out;
            /* Untuk penengahan vertikal dan horizontal di dalam parent */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%; /* Penting agar flexbox bisa menengahkan secara vertikal */
            width: 100%; /* Penting agar flexbox bisa menengahkan secara horizontal */
        }
        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            color: #cbd5e1;
        }
        .empty-state p {
            margin-bottom: 0.5rem;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <div class="max-w-7xl mx-auto px-4 py-8">
        <!-- Header -->
        <header class="mb-8 bg-white p-6 rounded-lg shadow-md header">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                <div>
                    <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-900">Purchase Order Monitoring <i class="fas fa-box-open text-blue-600 ml-2"></i></h1>
                </div>
                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4 mt-4 sm:mt-0">
                    <button id="newPOBtn" onclick="openPOModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow-md transition duration-200 ease-in-out transform hover:scale-105 flex items-center text-sm">
                        <i class="fas fa-plus-circle mr-2"></i> PO Baru
                    </button>
                    
                    <button id="backButton" onclick="goToIndex()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg shadow-md transition duration-200 ease-in-out transform hover:scale-105 flex items-center text-sm">
                        <i class="fas fa-arrow-left mr-2"></i> Kembali
                    </button>

                    <button id="authButton" onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg shadow-md transition duration-200 ease-in-out transform hover:scale-105 flex items-center text-sm">
                        <i class="fas fa-sign-out-alt mr-2"></i> Logout
                    </button>
                </div>
            </div>
            
            <!-- Combined Filter Section -->
            <div class="mt-6 flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4 items-center">
                <input type="text" id="searchPOs" onkeyup="filterPOs()" placeholder="Cari PO berdasarkan nomor, supplier, barang..." class="w-full sm:w-1/2 p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                
                <button id="openFilterPanelBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg shadow-md transition duration-200 ease-in-out transform hover:scale-105 flex items-center text-sm">
                    <i class="fas fa-filter mr-2"></i> Filter
                </button>
            </div>
        </header>

        <!-- Pipeline Visualization -->
        <div class="grid grid-cols-1 gap-6 mb-10">
            <div class="pipeline-stage stage-main-pipeline">
                <div class="pipeline-stage-header">
                    <h3>Daftar PO</h3>
                </div>
                <div id="pos-stage" class="pipeline-stage-content">
                    <!-- POs akan ditampilkan di sini -->
                    <div id="loading-spinner" class="flex justify-center items-center w-full h-full hidden">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add/Edit PO Modal -->
        <div id="poModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
            <div class="bg-white rounded-none p-8 w-full h-full shadow-2xl modal-content-enter" id="poModalContent">
                <h2 class="text-xl sm:text-2xl font-bold mb-6 text-gray-900" id="modalTitle">Tambah PO Baru</h2>
                <form id="poForm">
                    <input type="hidden" id="poId">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"> <!-- Gap lebih besar -->
                        <!-- Kolom 1 -->
                        <div>
                            <div class="mb-4"> <!-- Margin lebih besar -->
                                <label class="block text-gray-700 text-sm font-semibold mb-2" for="orderConfirmation">Order Confirmation</label>
                                <input type="text" id="orderConfirmation" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-semibold mb-2" for="noPO">No. PO <span class="text-red-500">*</span></label>
                                <input type="text" id="noPO" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm" required>
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-semibold mb-2" for="supplierName">Nama Supplier</label>
                                <input type="text" id="supplierName" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                            </div>
                        </div>
                        <!-- Kolom 2 -->
                        <div>
                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-semibold mb-2" for="allocation">Allocation</label>
                                <input type="text" id="allocation" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-semibold mb-2" for="invoice">Invoice</label>
                                <input type="text" id="invoice" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-semibold mb-2" for="tracking">Tracking</label>
                                <input type="text" id="tracking" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-semibold mb-2" for="seaForwarder">Sea Forwarder</label>
                                <input type="text" id="seaForwarder" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-semibold mb-2" for="airForwarder">Air Forwarder</label>
                                <input type="text" id="airForwarder" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                            </div>
                        </div>
                        <!-- Kolom 3 -->
                        <div>
                            <!-- Form Tambahan Baru dengan Fitur Search -->
                            <div class="mb-4 relative"> <!-- Tambahkan relative untuk positioning absolute search results -->
                                <label class="block text-gray-700 text-sm font-semibold mb-2" for="searchableField">No ID</label>
                                <input type="text" id="searchableField" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm" placeholder="Cari produk...">
                                <div id="searchResults" class="absolute z-10 bg-white border border-gray-300 rounded-lg shadow-lg mt-1 w-full max-h-48 overflow-y-auto hidden">
                                    <!-- Hasil pencarian akan ditampilkan di sini -->
                                </div>
                                <input type="hidden" id="selectedProductId">
                            </div>
                            <!-- Akhir Form Tambahan Baru -->

                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-semibold mb-2">Nama Barang & Quantity</label>
                                <div id="itemsList" class="space-y-3 mb-3">
                                    <!-- Item barang akan ditambahkan di sini secara dinamis oleh JS -->
                                </div>
                                <button type="button" onclick="addItemField()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-3 py-1.5 rounded-lg text-xs flex items-center transition duration-200 ease-in-out transform hover:scale-105">
                                    <i class="fas fa-plus mr-1"></i> Tambah Barang
                                </button>
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-semibold mb-2" for="disrc">DISRC</label>
                                <input type="text" id="disrc" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-semibold mb-2" for="planDelivery">Plan Delivery</label>
                                <input type="date" id="planDelivery" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-semibold mb-2" for="eta">ETA</label>
                                <input type="date" id="eta" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-semibold mb-2" for="actualDelivery">Actual Delivery</label>
                                <input type="date" id="actualDelivery" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                            </div>
                        </div>
                        <!-- Kolom 4 -->
                        <div>
                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-semibold mb-2" for="coo">COO</label>
                                <input type="text" id="coo" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-semibold mb-2" for="hsCode">HS Code</label>
                                <input type="text" id="hsCode" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-semibold mb-2" for="revisiHS">Revisi HS</label>
                                <input type="text" id="revisiHS" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-semibold mb-2" for="note">Note</label>
                                <textarea id="note" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm" rows="3" placeholder="Tambahkan catatan atau deskripsi tambahan..."></textarea>
                            </div>
                            <input type="hidden" id="status" value="pending"> <!-- Status default disembunyikan -->
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="closePOModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800 font-medium rounded-lg transition duration-200 text-sm">
                            Batal
                        </button>
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow-md font-medium transition duration-200 ease-in-out transform hover:scale-105 text-sm">
                            Simpan PO
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- PO Detail Modal -->
        <div id="poDetailModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
            <div class="bg-white rounded-xl p-8 w-full max-w-3xl shadow-2xl modal-content-enter" id="poDetailModalContent"> <!-- Max-width lebih besar -->
                <h2 class="text-xl sm:text-2xl font-bold mb-6 text-gray-900" id="poDetailTitle">Detail PO</h2>
                <div class="detail-grid">
                    <div class="detail-item">
                        <p class="text-gray-700 font-semibold">Order Confirmation:</p>
                        <p id="detailOrderConfirmation" class="text-gray-900"></p>
                    </div>
                    <div class="detail-item">
                        <p class="text-gray-700 font-semibold">No. PO:</p>
                        <p id="detailNoPO" class="text-gray-900"></p>
                    </div>
                    <div class="detail-item">
                        <p class="text-gray-700 font-semibold">Nama Supplier:</p>
                        <p id="detailSupplierName" class="text-gray-900"></p>
                    </div>
                    <div class="detail-item">
                        <p class="text-gray-700 font-semibold">Produk Terpilih:</p>
                        <p id="detailSelectedProduct" class="text-gray-900"></p>
                    </div>
                    <div class="detail-item">
                        <p class="text-gray-700 font-semibold">Allocation:</p>
                        <p id="detailAllocation" class="text-gray-900"></p>
                    </div>
                    <div class="detail-item">
                        <p class="text-gray-700 font-semibold">Invoice:</p>
                        <p id="detailInvoice" class="text-gray-900"></p>
                    </div>
                    <div class="detail-item">
                        <p class="text-gray-700 font-semibold">Tracking:</p>
                        <p id="detailTracking" class="text-gray-900"></p>
                    </div>
                    <div class="detail-item">
                        <p class="text-gray-700 font-semibold">Sea Forwarder:</p>
                        <p id="detailSeaForwarder" class="text-gray-900"></p>
                    </div>
                    <div class="detail-item">
                        <p class="text-gray-700 font-semibold">Air Forwarder:</p>
                        <p id="detailAirForwarder" class="text-gray-900"></p>
                    </div>
                    <div class="detail-item">
                        <p class="text-gray-700 font-semibold">DISRC:</p>
                        <p id="detailDisrc" class="text-gray-900"></p>
                    </div>
                    <div class="detail-item">
                        <p class="text-gray-700 font-semibold">Plan Delivery:</p>
                        <p id="detailPlanDelivery" class="text-gray-900"></p>
                    </div>
                    <div class="detail-item">
                        <p class="text-gray-700 font-semibold">ETA:</p>
                        <p id="detailETA" class="text-gray-900"></p>
                    </div>
                    <div class="detail-item">
                        <p class="text-gray-700 font-semibold">Actual Delivery:</p>
                        <p id="detailActualDelivery" class="text-gray-900"></p>
                    </div>
                    <div class="detail-item">
                        <p class="text-gray-700 font-semibold">COO:</p>
                        <p id="detailCOO" class="text-gray-900"></p>
                    </div>
                    <div class="detail-item">
                        <p class="text-gray-700 font-semibold">HS Code:</p>
                        <p id="detailHSCode" class="text-gray-900"></p>
                    </div>
                    <div class="detail-item">
                        <p class="text-gray-700 font-semibold">Revisi HS:</p>
                        <p id="detailRevisiHS" class="text-gray-900"></p>
                    </div>
                    <!-- Status dan Tanggal Dibuat dihapus dari sini -->
                    <div class="detail-item col-span-full"> <!-- Mengambil lebar penuh -->
                        <p class="text-gray-700 font-semibold">Nama Barang & Quantity:</p>
                        <ul id="detailItemsList" class="list-disc list-inside text-gray-900"></ul>
                    </div>
                    <div class="detail-item col-span-full">
                        <p class="text-gray-700 font-semibold">Note:</p>
                        <p id="detailNote" class="text-gray-900"></p>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="closePODetailModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800 font-medium rounded-lg transition duration-200 text-sm">
                        Tutup
                    </button>
                </div>
            </div>
        </div>

        <!-- Delete Confirmation Modal -->
        <div id="deleteModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
            <div class="bg-white rounded-xl p-8 w-full max-w-sm shadow-2xl modal-content-enter" id="deleteModalContent">
                <h2 class="text-xl font-bold mb-4 text-gray-900">Konfirmasi Penghapusan</h2>
                <p class="text-gray-700 mb-6 text-sm">Apakah Anda yakin ingin menghapus "<span id="dealToDeleteName" class="font-semibold"></span>"? Aksi ini tidak dapat dibatalkan.</p>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeDeleteModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800 font-medium rounded-lg transition duration-200 text-sm">
                        Batal
                    </button>
                    <button type="button" id="confirmDeleteBtn" onclick="deletePO()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg shadow-md font-medium transition duration-200 ease-in-out transform hover:scale-105 text-sm">
                        Hapus
                    </button>
                </div>
            </div>
        </div>

        <!-- Filter Panel Modal -->
        <div id="filterPanel" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
            <div class="bg-white rounded-xl p-8 w-full max-w-2xl shadow-2xl modal-content-enter" id="filterPanelContent">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-900 flex items-center"><i class="fas fa-filter mr-3 text-gray-500"></i> Filter POs</h2>
                    <button onclick="closeFilterPanel()" class="text-gray-500 hover:text-gray-700 transition duration-200">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Kolom 1 -->
                    <div>
                        <label class="block text-gray-700 text-sm font-semibold mb-2" for="filterStatus">Status</label>
                        <select id="filterStatus" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                            <option value="all">Semua Status</option>
                            <option value="pending">Pending</option>
                            <option value="in-transit">In Transit</option>
                            <option value="delivered">Delivered</option>
                            <option value="cancelled">Cancelled</option>
                            <option value="on-hold">On Hold</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-semibold mb-2" for="filterSupplier">Supplier</label>
                        <select id="filterSupplier" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                            <option value="all">Semua Supplier</option>
                            <!-- Opsi akan diisi secara dinamis oleh JavaScript -->
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-semibold mb-2" for="filterItemName">Nama Barang</label>
                        <select id="filterItemName" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                            <option value="all">Semua Barang</option>
                            <!-- Opsi akan diisi secara dinamis oleh JavaScript -->
                        </select>
                    </div>
                    <!-- Kolom 2 -->
                    <div>
                        <label class="block text-gray-700 text-sm font-semibold mb-2" for="filterAllocation">Allocation</label>
                        <select id="filterAllocation" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                            <option value="all">Semua Allocation</option>
                            <!-- Opsi akan diisi secara dinamis oleh JavaScript -->
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-semibold mb-2" for="filterYear">Tahun PO</label>
                        <select id="filterYear" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                            <option value="all">Semua Tahun</option>
                            <!-- Tahun akan diisi secara dinamis oleh JavaScript -->
                        </select>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="resetFilters()" class="px-4 py-2 text-gray-600 hover:text-gray-800 font-medium rounded-lg transition duration-200 text-sm">
                        Reset Filter
                    </button>
                    <button type="button" onclick="applyFiltersAndClosePanel()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow-md font-medium transition duration-200 ease-in-out transform hover:scale-105 text-sm">
                        Terapkan Filter
                    </button>
                </div>
            </div>
        </div>

        <!-- Toast Notification Container -->
        <div id="toast-container"></div>
    </div>
    <div id="global-loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
    </div>

    <script>
        // Konfigurasi Firebase
        const firebaseConfig = {
              apiKey: "AIzaSyB9s6k2K75vrbe1lWgiu42SAXV_lySHHNU",
              authDomain: "monitoring-efk.firebaseapp.com",
              projectId: "monitoring-efk",
              storageBucket: "monitoring-efk.firebasestorage.app",
              messagingSenderId: "1083858508151",
              appId: "1:1083858508151:web:3d505dec79d715f9cd6972"
        };

        // Inisialisasi Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const dealsCollection = db.collection('purchaseOrders');
        const usersCollection = db.collection('users'); // Tetap diperlukan untuk menyimpan role admin

        let pos = [];
        const DEFAULT_STATUS = 'pending';
        let currentUserRole = 'user'; // Default role, akan diubah jika admin
        let sortableInstances = {};
        let authInitialized = false;

        let uniqueSuppliers = new Set();
        let uniqueItemNames = new Set();
        let uniqueAllocations = new Set();
        let uniqueYears = new Set();

        // Hanya satu admin yang diizinkan
        const ADMIN_EMAIL = 'maida@genetek.co.id';

        // ==================== DATA PRODUK SEDERHANA (BUKAN FIREBASE) ====================
        const productData = [
            { id: 'prod001', name: 'Laptop Gaming XYZ', description: 'Laptop dengan RTX 3080' },
            { id: 'prod002', name: 'Monitor UltraWide 34"', description: 'Monitor 144Hz QHD' },
            { id: 'prod003', name: 'Keyboard Mekanikal RGB', description: 'Switch Cherry MX Brown' },
            { id: 'prod004', name: 'Mouse Gaming Wireless', description: 'Sensor Hero 25K' },
            { id: 'prod005', name: 'Headset Gaming Surround', description: 'Audio 7.1 Virtual' },
            { id: 'prod006', name: 'Webcam Full HD', description: '1080p 60fps' },
            { id: 'prod007', name: 'Microphone Kondenser USB', description: 'Cocok untuk streaming' },
            { id: 'prod008', name: 'SSD NVMe 1TB', description: 'Kecepatan baca 7000MB/s' },
            { id: 'prod009', name: 'RAM DDR4 16GB (2x8GB)', description: '3200MHz CL16' },
            { id: 'prod010', name: 'Router Wi-Fi 6', description: 'Dual-band AX3000' },
            { id: 'prod011', name: 'Printer Laser Monokrom', description: 'Cepat dan efisien' },
            { id: 'prod012', name: 'Speaker Bluetooth Portable', description: 'Suara jernih, baterai tahan lama' },
            { id: 'prod013', name: 'Smartwatch Sport', description: 'Fitur kesehatan lengkap' },
            { id: 'prod014', name: 'Drone Mini dengan Kamera', description: 'Mudah diterbangkan' },
            { id: 'prod015', name: 'Power Bank 20000mAh', description: 'Fast charging' },
        ];

        // ==================== FUNGSI UTAMA ====================

        auth.onAuthStateChanged(async (user) => {
            if (authInitialized) return;
            authInitialized = true;
            
            console.log("Auth state changed:", user ? user.email : "no user");
            
            if (!user && window.location.pathname.includes('app.html')) {
                console.log("No user, redirecting to login");
                window.location.href = 'login.html';
                return;
            }
            
            if (user && window.location.pathname.includes('login.html')) {
                console.log("User already logged in, redirecting to app");
                window.location.href = 'app.html';
                return;
            }

            if (user && window.location.pathname.includes('app.html')) {
                try {
                    showGlobalLoading();
                    if (user.email === ADMIN_EMAIL) {
                        currentUserRole = 'admin';
                        await usersCollection.doc(user.uid).set({ 
                            role: 'admin',
                            email: user.email 
                        }, { merge: true });
                    } else {
                        // Jika bukan admin yang diizinkan, paksa logout dan redirect ke login
                        console.log("Unauthorized user, logging out and redirecting to login.");
                        await auth.signOut();
                        window.location.href = 'login.html';
                        return;
                    }

                    console.log("Current role:", currentUserRole);
                    applyUserPermissions();
                    await loadPOsFromFirebase(); // Tunggu PO dimuat
                    initEventListeners();
                    hideGlobalLoading();
                } catch (error) {
                    console.error("Error checking user role or loading data:", error);
                    showToast("Gagal memuat data pengguna atau aplikasi. Silakan refresh halaman.", 5000);
                    hideGlobalLoading();
                }
            }
        });

        // ==================== FUNGSI UTILITAS ====================

        function formatDateTime(timestamp) {
            if (!timestamp) return '-';
            try {
                const date = timestamp.toDate();
                return date.toLocaleString('id-ID', {
                    day: 'numeric',
                    month: 'short',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                return '-';
            }
        }

        function formatNumber(num) {
            if (num === null || num === undefined || isNaN(num)) {
                return '0';
            }
            return new Intl.NumberFormat('id-ID').format(num);
        }

        function formatDate(timestamp) {
            if (!timestamp) return '-';
            try {
                if (timestamp instanceof Date) {
                    return timestamp.toLocaleDateString('id-ID');
                }
                // Handle Firebase Timestamp objects
                if (timestamp && typeof timestamp.toDate === 'function') {
                    return timestamp.toDate().toLocaleDateString('id-ID');
                }
                return '-';
            } catch (e) {
                return '-';
            }
        }

        function showToast(message, duration = 3000) {
            const toastContainer = document.getElementById('toast-container');
            if (!toastContainer) return;
            
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerText = message;
            toastContainer.appendChild(toast);

            requestAnimationFrame(() => {
                toast.classList.add('show');
            });

            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove(), { once: true });
            }, duration);
        }

        function showGlobalLoading() {
            document.getElementById('global-loading-overlay').classList.add('show');
        }

        function hideGlobalLoading() {
            document.getElementById('global-loading-overlay').classList.remove('show');
        }

        // ==================== FUNGSI PO ====================

        function populateYearDropdown() {
            const filterYearSelect = document.getElementById('filterYear');
            if (!filterYearSelect) return;

            const allYearsOption = filterYearSelect.querySelector('option[value="all"]');
            filterYearSelect.innerHTML = '';
            filterYearSelect.appendChild(allYearsOption);

            const sortedYears = Array.from(uniqueYears).sort((a, b) => parseInt(b) - parseInt(a));
            sortedYears.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                filterYearSelect.appendChild(option);
            });
        }

        async function loadPOsFromFirebase() {
            console.log("Loading POs from Firebase...");
            const pipelineStage = document.getElementById('pos-stage');
            const loadingSpinner = document.getElementById('loading-spinner');
            if (pipelineStage && loadingSpinner) {
                pipelineStage.innerHTML = ''; // Clear current POs
                loadingSpinner.classList.remove('hidden'); // Show spinner
            }

            try {
                let query = dealsCollection.orderBy("createdAt", "desc");
                const querySnapshot = await query.get();
                pos = [];
                uniqueSuppliers.clear();
                uniqueItemNames.clear();
                uniqueAllocations.clear();
                uniqueYears.clear();

                querySnapshot.forEach((doc) => {
                    const poData = doc.data();
                    // Ensure createdAt is a Date object
                    if (poData.createdAt && typeof poData.createdAt.toDate === 'function') {
                        poData.createdAt = poData.createdAt.toDate();
                    } else if (poData.createdAt && typeof poData.createdAt === 'object' && poData.createdAt.seconds !== undefined) {
                        poData.createdAt = new firebase.firestore.Timestamp(poData.createdAt.seconds, poData.createdAt.nanoseconds).toDate();
                    } else {
                        poData.createdAt = null; 
                    }

                    // Ensure planDelivery is a Date object
                    if (poData.planDelivery && typeof poData.planDelivery.toDate === 'function') {
                        poData.planDelivery = poData.planDelivery.toDate();
                    } else if (poData.planDelivery && typeof poData.planDelivery === 'object' && poData.planDelivery.seconds !== undefined) {
                        poData.planDelivery = new firebase.firestore.Timestamp(poData.planDelivery.seconds, poData.planDelivery.nanoseconds).toDate();
                    } else {
                        poData.planDelivery = null;
                    }

                    // Ensure eta is a Date object
                    if (poData.eta && typeof poData.eta.toDate === 'function') {
                        poData.eta = poData.eta.toDate();
                    } else if (poData.eta && typeof poData.eta === 'object' && poData.eta.seconds !== undefined) {
                        poData.eta = new firebase.firestore.Timestamp(poData.eta.seconds, poData.eta.nanoseconds).toDate();
                    } else {
                        poData.eta = null;
                    }

                    // Ensure actualDelivery is a Date object
                    if (poData.actualDelivery && typeof poData.actualDelivery.toDate === 'function') {
                        poData.actualDelivery = poData.actualDelivery.toDate();
                    } else if (poData.actualDelivery && typeof poData.actualDelivery === 'object' && poData.actualDelivery.seconds !== undefined) {
                        poData.actualDelivery = new firebase.firestore.Timestamp(poData.actualDelivery.seconds, poData.actualDelivery.nanoseconds).toDate();
                    } else {
                        poData.actualDelivery = null;
                    }

                    pos.push({ id: doc.id, ...poData });

                    if (poData.supplierName) uniqueSuppliers.add(poData.supplierName);
                    if (poData.allocation) uniqueAllocations.add(poData.allocation);
                    if (poData.items && Array.isArray(poData.items)) {
                        poData.items.forEach(item => {
                            if (item.itemName) uniqueItemNames.add(item.itemName);
                        });
                    }
                    
                    if (poData.createdAt instanceof Date) { // Check if it's a valid Date object
                        uniqueYears.add(poData.createdAt.getFullYear().toString());
                    }
                });
                console.log("Total POs loaded:", pos.length);
                populateYearDropdown();
                populateFilterDropdowns();
                filterPOs();
            } catch (error) {
                console.error("Error loading POs:", error);
                showToast("Gagal memuat data PO", 3000);
            } finally {
                if (loadingSpinner) {
                    loadingSpinner.classList.add('hidden'); // Hide spinner
                }
            }
        }

        function renderPO(po, index) { // Tambahkan parameter index
            const poCard = document.createElement('div');
            poCard.className = 'deal-card';
            poCard.dataset.id = po.id;
            
            // Menghilangkan status PO dari card
            // let statusColorClass = '';
            // switch (po.status) {
            //     case 'pending':
            //         statusColorClass = 'bg-gray-100 text-gray-800';
            //         break;
            //     case 'in-transit':
            //         statusColorClass = 'bg-blue-100 text-blue-800';
            //         break;
            //     case 'delivered':
            //         statusColorClass = 'bg-green-100 text-green-800';
            //         break;
            //     case 'cancelled':
            //         statusColorClass = 'bg-red-100 text-red-800';
            //         break;
            //     case 'on-hold':
            //         statusColorClass = 'bg-yellow-100 text-yellow-800';
            //         break;
            //     default:
            //         statusColorClass = 'bg-gray-100 text-gray-800';
            // }

            poCard.innerHTML = `
                <div class="flex justify-between items-start">
                    <h3 class="font-bold text-gray-800">${index + 1}. No. PO: ${po.noPO || '-'}</h3> <!-- Format No. PO -->
                    <!-- Menghilangkan badge status PO -->
                    <!-- <span class="priority-badge px-2 py-1 rounded-full ${statusColorClass}">
                        ${po.status ? po.status.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'Unknown Status'}
                    </span> -->
                </div>
                <div class="mt-1 text-sm text-gray-600 deal-details">
                    <p><i class="fas fa-building mr-1"></i> Supplier: ${po.supplierName || '-'}</p> <!-- Menampilkan Nama Supplier -->
                    <p><i class="fas fa-globe mr-1"></i> COO: ${po.coo || '-'}</p> <!-- Menampilkan COO -->
                    <p><i class="fas fa-calendar-alt mr-1"></i> Plan Delivery: ${po.planDelivery ? formatDate(po.planDelivery) : '-'}</p>
                </div>
                <div class="mt-2 flex justify-between items-center deal-footer">
                    <span class="text-xs text-gray-500">Dibuat: ${formatDate(po.createdAt)}</span>
                    <div class="flex space-x-1 deal-actions">
                        <button onclick="openPODetailModal('${po.id}')" class="text-blue-600 hover:text-blue-800" title="Lihat Detail">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button onclick="prepareEditPO('${po.id}')" class="text-green-600 hover:text-green-800" title="Edit PO">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="confirmDeletePO('${po.id}', '${po.noPO}')" class="text-red-600 hover:text-red-800" title="Hapus PO">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </div>
            `;
            
            return poCard;
        }

        function renderAllPOs() {
            const pipelineStage = document.getElementById('pos-stage');
            if (!pipelineStage) return;
            
            pipelineStage.innerHTML = '';

            let posToDisplay = pos;

            if (posToDisplay.length === 0) {
                pipelineStage.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <p>Tidak ada PO di daftar.</p>
                    </div>
                `;
            } else {
                posToDisplay.forEach((po, index) => { // Teruskan index di sini
                    const poCard = renderPO(po, index); // Panggil renderPO dengan index
                    if (poCard) {
                        pipelineStage.appendChild(poCard);
                        // Animate cards on load
                        setTimeout(() => {
                            poCard.classList.add('show');
                        }, 50 * index); // Staggered animation
                    }
                });
            }

            initSortable(); // Tetap panggil, tapi fungsinya sudah dinonaktifkan
        }

        function populateDropdown(selectElementId, uniqueValues, selectedValue = 'all') {
            const selectElement = document.getElementById(selectElementId);
            if (!selectElement) {
                console.warn(`Element with ID '${selectElementId}' not found.`);
                return;
            }

            selectElement.innerHTML = '';

            const defaultOption = document.createElement('option');
            defaultOption.value = 'all';
            const labelElement = selectElement.previousElementSibling;
            const labelText = labelElement ? labelElement.textContent.replace(':', '').replace('*', '').trim() : '';
            defaultOption.textContent = `Semua ${labelText}`;
            selectElement.appendChild(defaultOption);

            const sortedValues = Array.from(uniqueValues).sort();
            sortedValues.forEach(value => {
                if (value) {
                    const option = document.createElement('option');
                    option.value = value;
                    option.textContent = value;
                    selectElement.appendChild(option);
                }
            });

            selectElement.value = selectedValue;
        }

        function populateFilterDropdowns() {
            populateDropdown('filterStatus', ['pending', 'in-transit', 'delivered', 'cancelled', 'on-hold'], document.getElementById('filterStatus').value);
            populateDropdown('filterSupplier', uniqueSuppliers, document.getElementById('filterSupplier').value);
            populateDropdown('filterItemName', uniqueItemNames, document.getElementById('filterItemName').value);
            populateDropdown('filterAllocation', uniqueAllocations, document.getElementById('filterAllocation').value);
        }

        function addItemField(initialItemName = '', initialQuantity = '') {
            const itemsListDiv = document.getElementById('itemsList');
            const newItemDiv = document.createElement('div');
            newItemDiv.className = 'flex items-center space-x-2 mb-2';

            newItemDiv.innerHTML = `
                <input type="text" class="item-name-input w-3/5 p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm" placeholder="Nama Barang" value="${initialItemName}">
                <input type="number" class="item-quantity-input w-1/5 p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm" placeholder="Qty" min="1" value="${initialQuantity}">
                <button type="button" onclick="removeItemField(this)" class="text-red-500 hover:text-red-700 p-1">
                    <i class="fas fa-times"></i>
                </button>
            `;
            itemsListDiv.appendChild(newItemDiv);
        }

        function removeItemField(buttonElement) {
            buttonElement.closest('.flex').remove();
        }

        // ==================== FUNGSI UNTUK FORM TAMBAHAN DENGAN SEARCH ====================

        function setupSearchableField() {
            const searchableField = document.getElementById('searchableField');
            const searchResultsDiv = document.getElementById('searchResults');
            const selectedProductIdInput = document.getElementById('selectedProductId');

            if (!searchableField || !searchResultsDiv || !selectedProductIdInput) return;

            searchableField.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                searchResultsDiv.innerHTML = ''; // Clear previous results

                if (searchTerm.length < 2) { // Minimal 2 karakter untuk mulai mencari
                    searchResultsDiv.classList.add('hidden');
                    return;
                }

                const filteredProducts = productData.filter(product => 
                    product.name.toLowerCase().includes(searchTerm) || 
                    product.description.toLowerCase().includes(searchTerm)
                );

                if (filteredProducts.length > 0) {
                    filteredProducts.forEach(product => {
                        const resultItem = document.createElement('div');
                        resultItem.className = 'p-2 cursor-pointer hover:bg-gray-100 border-b border-gray-200 last:border-b-0';
                        resultItem.textContent = product.name;
                        resultItem.dataset.productId = product.id;
                        resultItem.dataset.productName = product.name;
                        resultItem.addEventListener('click', function() {
                            selectProduct(this.dataset.productId, this.dataset.productName);
                        });
                        searchResultsDiv.appendChild(resultItem);
                    });
                    searchResultsDiv.classList.remove('hidden');
                } else {
                    const noResultItem = document.createElement('div');
                    noResultItem.className = 'p-2 text-gray-500';
                    noResultItem.textContent = 'Tidak ada hasil.';
                    searchResultsDiv.appendChild(noResultItem);
                    searchResultsDiv.classList.remove('hidden');
                }
            });

            // Sembunyikan hasil pencarian saat klik di luar
            document.addEventListener('click', function(event) {
                if (!searchableField.contains(event.target) && !searchResultsDiv.contains(event.target)) {
                    searchResultsDiv.classList.add('hidden');
                }
            });

            // Fungsi untuk memilih produk dari hasil pencarian
            function selectProduct(productId, productName) {
                searchableField.value = productName;
                selectedProductIdInput.value = productId;
                searchResultsDiv.classList.add('hidden');
                // Opsional: Tambahkan produk yang dipilih ke daftar item PO secara otomatis
                // addItemField(productName, 1); // Contoh: tambahkan dengan quantity default 1
            }

            // Override openPOModal untuk reset/isi field pencarian
            const originalOpenPOModal = openPOModal;
            openPOModal = function(poId = null) {
                originalOpenPOModal(poId); // Panggil fungsi asli
                if (!poId) { // Jika ini adalah PO baru
                    searchableField.value = '';
                    selectedProductIdInput.value = '';
                    searchResultsDiv.classList.add('hidden');
                } else {
                    // Jika edit PO, Anda mungkin ingin mengisi searchableField
                    // dengan data yang sudah ada di PO
                    const po = pos.find(p => p.id === poId);
                    if (po && po.selectedProduct && po.selectedProduct.name) { 
                        searchableField.value = po.selectedProduct.name;
                        selectedProductIdInput.value = po.selectedProduct.id || '';
                    } else {
                        searchableField.value = '';
                        selectedProductIdInput.value = '';
                    }
                }
            };
        }


        function openPOModal(poId = null) {
            const poModal = document.getElementById('poModal');
            const modalTitle = document.getElementById('modalTitle');
            const poForm = document.getElementById('poForm');
            
            poForm.reset();
            document.getElementById('itemsList').innerHTML = ''; // Pastikan ini kosong sebelum mengisi
            document.getElementById('poId').value = '';

            if (poId) {
                modalTitle.textContent = 'Edit PO';
                const po = pos.find(p => p.id === poId);
                if (po) {
                    document.getElementById('poId').value = po.id;
                    document.getElementById('orderConfirmation').value = po.orderConfirmation || '';
                    document.getElementById('noPO').value = po.noPO || '';
                    document.getElementById('supplierName').value = po.supplierName || '';
                    
                    // Isi field produk terpilih jika ada
                    if (po.selectedProduct && po.selectedProduct.name) {
                        document.getElementById('searchableField').value = po.selectedProduct.name;
                        document.getElementById('selectedProductId').value = po.selectedProduct.id || '';
                    } else {
                        document.getElementById('searchableField').value = '';
                        document.getElementById('selectedProductId').value = '';
                    }

                    if (po.items && Array.isArray(po.items) && po.items.length > 0) { // Cek jika ada item
                        po.items.forEach(item => {
                            addItemField(item.itemName, item.quantity);
                        });
                    } else {
                        addItemField(); // Tambahkan minimal satu jika tidak ada item
                    }

                    document.getElementById('allocation').value = po.allocation || '';
                    document.getElementById('invoice').value = po.invoice || '';
                    document.getElementById('tracking').value = po.tracking || '';
                    document.getElementById('seaForwarder').value = po.seaForwarder || '';
                    document.getElementById('airForwarder').value = po.airForwarder || '';
                    document.getElementById('disrc').value = po.disrc || '';
                    
                    // Perbaikan: Pastikan po.planDelivery adalah objek Date sebelum memanggil toISOString()
                    document.getElementById('planDelivery').value = po.planDelivery instanceof Date ? po.planDelivery.toISOString().split('T')[0] : '';
                    document.getElementById('eta').value = po.eta instanceof Date ? po.eta.toISOString().split('T')[0] : '';
                    document.getElementById('actualDelivery').value = po.actualDelivery instanceof Date ? po.actualDelivery.toISOString().split('T')[0] : '';

                    document.getElementById('coo').value = po.coo || '';
                    document.getElementById('hsCode').value = po.hsCode || '';
                    document.getElementById('revisiHS').value = po.revisiHS || '';
                    document.getElementById('note').value = po.note || '';
                    document.getElementById('status').value = po.status || DEFAULT_STATUS; // Tetap set status, tapi inputnya hidden
                }
            } else {
                modalTitle.textContent = 'Tambah PO Baru';
                document.getElementById('status').value = DEFAULT_STATUS;
                document.getElementById('searchableField').value = ''; // Reset untuk PO baru
                document.getElementById('selectedProductId').value = ''; // Reset untuk PO baru
                addItemField(); // Tambahkan minimal satu form item saat membuat PO baru
            }
            
            poModal.classList.remove('hidden');
            document.getElementById('poModalContent').classList.remove('modal-content-leave-active');
            document.getElementById('poModalContent').classList.add('modal-content-enter-active');
        }

        function closePOModal() {
            const poModalContent = document.getElementById('poModalContent');
            if (!poModalContent) return;

            poModalContent.classList.remove('modal-content-enter-active');
            poModalContent.classList.add('modal-content-leave-active');
            
            poModalContent.addEventListener('transitionend', function handler() {
                document.getElementById('poModal').classList.add('hidden');
                poModalContent.classList.remove('modal-content-leave-active');
                poModalContent.removeEventListener('transitionend', handler);
            }, { once: true });
        }

        async function savePO() {
            const poId = document.getElementById('poId').value;
            const orderConfirmation = document.getElementById('orderConfirmation').value;
            const noPO = document.getElementById('noPO').value;
            const supplierName = document.getElementById('supplierName').value;
            
            // Ambil data dari form pencarian produk
            const selectedProductId = document.getElementById('selectedProductId').value;
            const selectedProductName = document.getElementById('searchableField').value; // Ambil nama dari input field

            const itemInputs = document.querySelectorAll('#itemsList .item-name-input');
            const quantityInputs = document.querySelectorAll('#itemsList .item-quantity-input');
            const itemsToSave = [];
            itemInputs.forEach((input, index) => {
                const itemName = input.value.trim();
                const quantity = parseInt(quantityInputs[index].value) || 0;
                if (itemName) {
                    itemsToSave.push({ itemName, quantity });
                }
            });

            const allocation = document.getElementById('allocation').value;
            const invoice = document.getElementById('invoice').value;
            const tracking = document.getElementById('tracking').value;
            const seaForwarder = document.getElementById('seaForwarder').value;
            const airForwarder = document.getElementById('airForwarder').value;
            const disrc = document.getElementById('disrc').value;
            
            const planDelivery = document.getElementById('planDelivery').value ? firebase.firestore.Timestamp.fromDate(new Date(document.getElementById('planDelivery').value)) : null;
            const eta = document.getElementById('eta').value ? firebase.firestore.Timestamp.fromDate(new Date(document.getElementById('eta').value)) : null;
            const actualDelivery = document.getElementById('actualDelivery').value ? firebase.firestore.Timestamp.fromDate(new Date(document.getElementById('actualDelivery').value)) : null;

            const coo = document.getElementById('coo').value;
            const hsCode = document.getElementById('hsCode').value;
            const revisiHS = document.getElementById('revisiHS').value;
            const note = document.getElementById('note').value;
            const status = document.getElementById('status').value; // Ambil dari hidden input

            if (!noPO) { // Hanya No. PO yang required
                showToast("No. PO harus diisi.", 3000);
                return;
            }

            const poData = {
                orderConfirmation: orderConfirmation,
                noPO: noPO,
                supplierName: supplierName,
                // Tambahkan data produk yang dipilih
                selectedProduct: selectedProductId ? { id: selectedProductId, name: selectedProductName } : null,
                items: itemsToSave,
                allocation: allocation,
                invoice: invoice,
                tracking: tracking,
                seaForwarder: seaForwarder,
                airForwarder: airForwarder,
                disrc: disrc,
                planDelivery: planDelivery,
                eta: eta,
                actualDelivery: actualDelivery,
                coo: coo,
                hsCode: hsCode,
                revisiHS: revisiHS,
                note: note,
                status: status,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                showGlobalLoading();
                if (poId) {
                    await dealsCollection.doc(poId).update(poData);
                    showToast("PO berhasil diperbarui!", 2000);
                } else {
                    poData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    poData.createdBy = auth.currentUser.email;
                    await dealsCollection.add(poData);
                    showToast("PO baru berhasil ditambahkan!", 2000);
                }
                closePOModal();
                
                // --- START MODIFIKASI: Reset semua filter dan kolom pencarian ---
                document.getElementById('searchPOs').value = '';
                document.getElementById('filterStatus').value = 'all';
                document.getElementById('filterSupplier').value = 'all';
                document.getElementById('filterItemName').value = 'all';
                document.getElementById('filterAllocation').value = 'all';
                document.getElementById('filterYear').value = 'all';
                // --- END MODIFIKASI ---

                await loadPOsFromFirebase(); // Ini akan memuat ulang data dan memanggil filterPOs()
            } catch (error) {
                console.error("Error saving PO:", error);
                showToast("Gagal menyimpan PO. Silakan coba lagi.", 3000);
            } finally {
                hideGlobalLoading();
            }
        }

        function prepareEditPO(poId) {
            openPOModal(poId);
        }

        let poToDeleteId = null;
        let poToDeleteNo = '';

        function confirmDeletePO(poId, poNo) {
            poToDeleteId = poId;
            poToDeleteNo = poNo;
            document.getElementById('dealToDeleteName').textContent = poNo;
            document.getElementById('deleteModal').classList.remove('hidden');
            document.getElementById('deleteModalContent').classList.remove('modal-content-leave-active');
            document.getElementById('deleteModalContent').classList.add('modal-content-enter-active');
        }

        async function deletePO() {
            if (!poToDeleteId) return;

            try {
                showGlobalLoading();
                await dealsCollection.doc(poToDeleteId).delete();
                showToast(`PO "${poToDeleteNo}" berhasil dihapus!`, 2000);
                closeDeleteModal(); // Ini seharusnya berfungsi sekarang
                await loadPOsFromFirebase();
            } catch (error) {
                console.error("Error deleting PO:", error);
                showToast("Gagal menghapus PO. Silakan coba lagi.", 3000);
            } finally {
                hideGlobalLoading();
            }
        }

        function openPODetailModal(poId) {
            const po = pos.find(p => p.id === poId);
            if (!po) {
                showToast("Detail PO tidak ditemukan.", 3000);
                return;
            }

            document.getElementById('poDetailTitle').textContent = po.noPO || 'Detail PO';
            document.getElementById('detailOrderConfirmation').textContent = po.orderConfirmation || '-';
            document.getElementById('detailNoPO').textContent = po.noPO || '-';
            document.getElementById('detailSupplierName').textContent = po.supplierName || '-';
            
            // Tampilkan produk terpilih
            document.getElementById('detailSelectedProduct').textContent = po.selectedProduct ? po.selectedProduct.name : '-';

            const detailItemsList = document.getElementById('detailItemsList');
            detailItemsList.innerHTML = '';
            if (po.items && Array.isArray(po.items) && po.items.length > 0) {
                po.items.forEach(item => {
                    const listItem = document.createElement('li');
                    listItem.textContent = `${item.itemName || '-'} (Qty: ${item.quantity || 0})`;
                    detailItemsList.appendChild(listItem);
                });
            } else {
                const listItem = document.createElement('li');
                listItem.textContent = '-';
                detailItemsList.appendChild(listItem);
            }

            document.getElementById('detailAllocation').textContent = po.allocation || '-';
            document.getElementById('detailInvoice').textContent = po.invoice || '-';
            document.getElementById('detailTracking').textContent = po.tracking || '-';
            document.getElementById('detailSeaForwarder').textContent = po.seaForwarder || '-';
            document.getElementById('detailAirForwarder').textContent = po.airForwarder || '-';
            document.getElementById('detailDisrc').textContent = po.disrc || '-';
            
            document.getElementById('detailPlanDelivery').textContent = po.planDelivery ? formatDate(po.planDelivery) : '-';
            document.getElementById('detailETA').textContent = po.eta ? formatDate(po.eta) : '-';
            document.getElementById('detailActualDelivery').textContent = po.actualDelivery ? formatDate(po.actualDelivery) : '-';

            document.getElementById('detailCOO').textContent = po.coo || '-';
            document.getElementById('detailHSCode').textContent = po.hsCode || '-';
            document.getElementById('detailRevisiHS').textContent = po.revisiHS || '-';
            document.getElementById('detailNote').textContent = po.note || '-';
            // document.getElementById('detailStatus').textContent = po.status ? po.status.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : '-'; // Dihapus
            // document.getElementById('detailCreatedDate').textContent = formatDate(po.createdAt) || '-'; // Dihapus

            document.getElementById('poDetailModal').classList.remove('hidden');
            document.getElementById('poDetailModalContent').classList.remove('modal-content-leave-active');
            document.getElementById('poDetailModalContent').classList.add('modal-content-enter-active');
        }

        function closePODetailModal() {
            const poDetailModalContent = document.getElementById('poDetailModalContent');
            if (!poDetailModalContent) return;

            poDetailModalContent.classList.remove('modal-content-enter-active');
            poDetailModalContent.classList.add('modal-content-leave-active');
            
            poDetailModalContent.addEventListener('transitionend', function handler() {
                document.getElementById('poDetailModal').classList.add('hidden');
                poDetailModalContent.classList.remove('modal-content-leave-active');
                poDetailModalContent.removeEventListener('transitionend', handler);
            }, { once: true });
        }

        // ==================== FUNGSI SORTABLE ====================

        function initSortable() {
            const pipelineStage = document.getElementById('pos-stage');
            if (!pipelineStage) return;

            // Hapus atau komentari baris berikut untuk menonaktifkan SortableJS
            // if (sortableInstances['pos-stage']) {
            //     sortableInstances['pos-stage'].destroy();
            // }

            // sortableInstances['pos-stage'] = new Sortable(pipelineStage, {
            //     animation: 150,
            //     ghostClass: 'sortable-ghost',
            //     chosenClass: 'sortable-chosen',
            //     dragClass: 'sortable-drag',
            //     disabled: true, // Selalu nonaktifkan drag
            //     onEnd: function(evt) {
            //         // Logika jika ada perubahan urutan (opsional, tidak diminta di sini)
            //     }
            // });
            console.log("SortableJS is disabled."); // Tambahkan log untuk konfirmasi
        }

        // ==================== FUNGSI PERMISSIONS ====================

        function applyUserPermissions() {
            try {
                const isAdmin = currentUserRole === 'admin';
                
                console.log("Applying permissions for Role:", currentUserRole);
                
                const newPOBtn = document.getElementById('newPOBtn');
                const searchInput = document.getElementById('searchPOs');
                const openFilterPanelBtn = document.getElementById('openFilterPanelBtn');
                const backButton = document.getElementById('backButton');
                const authButton = document.getElementById('authButton');

                if (newPOBtn) newPOBtn.classList.remove('hidden');
                if (backButton) backButton.classList.remove('hidden');
                if (authButton) authButton.classList.remove('hidden');

                if (searchInput) searchInput.classList.remove('hidden');
                if (openFilterPanelBtn) openFilterPanelBtn.classList.remove('hidden');

                // Karena drag and drop dinonaktifkan secara global di initSortable,
                // baris ini tidak lagi diperlukan untuk mengontrol disabled state berdasarkan role.
                // if (sortableInstances['pos-stage']) {
                //     sortableInstances['pos-stage'].option('disabled', !isAdmin);
                // }
                
            } catch (error) {
                console.error("Error in applyUserPermissions:", error);
                showToast("Gagal menerapkan permissions", 3000);
            }
        }

        // ==================== FUNGSI EVENT LISTENERS ====================

        function initEventListeners() {
            console.log("Initializing event listeners...");
            
            try {
                const poForm = document.getElementById('poForm');
                if (poForm) {
                    poForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                        savePO();
                    });
                }

                const buttons = [
                    { id: 'newPOBtn', func: openPOModal },
                    { id: 'backButton', func: goToIndex },
                    { id: 'authButton', func: logout },
                    { id: 'openFilterPanelBtn', func: openFilterPanel }
                ];
                
                buttons.forEach(btn => {
                    const element = document.getElementById(btn.id);
                    if (element) {
                        element.removeEventListener('click', btn.func); 
                        element.addEventListener('click', btn.func);
                        console.log(`Event listener added for ${btn.id}`);
                    }
                });

                const searchInput = document.getElementById('searchPOs');
                if (searchInput) {
                    searchInput.removeEventListener('keyup', filterPOs);
                    searchInput.addEventListener('keyup', filterPOs);
                }
            } catch (error) {
                console.error("Error initializing event listeners:", error);
                showToast("Gagal memuat beberapa fungsi", 3000);
            }
        }

        // ==================== FUNGSI LAINNYA ====================

        function filterPOs() {
            try {
                const searchTerm = document.getElementById('searchPOs').value.toLowerCase();
                const statusFilter = document.getElementById('filterStatus').value;
                const supplierFilter = document.getElementById('filterSupplier').value;
                const itemNameFilter = document.getElementById('filterItemName').value;
                const allocationFilter = document.getElementById('filterAllocation').value;
                const yearFilter = document.getElementById('filterYear').value;
                
                let basePOs = pos;

                if (searchTerm === '' && statusFilter === 'all' && supplierFilter === 'all' && itemNameFilter === 'all' &&
                    allocationFilter === 'all' && yearFilter === 'all') {
                    
                    // Jika tidak ada filter yang diterapkan, dan user adalah admin, tampilkan semua PO
                    if (currentUserRole === 'admin') {
                        renderFilteredPOs(basePOs);
                    } else {
                        // Jika bukan admin dan tidak ada filter, tampilkan pesan kosong
                        const pipelineStage = document.getElementById('pos-stage');
                        if (pipelineStage) {
                            pipelineStage.innerHTML = `
                                <div class="empty-state">
                                    <i class="fas fa-search"></i>
                                    <p>Gunakan kolom pencarian atau filter di atas untuk menemukan PO.</p>
                                </div>
                            `;
                        }
                    }
                    return;
                }

                const filteredPOs = basePOs.filter(po => {
                    const matchesSearch = 
                        (po.noPO && po.noPO.toLowerCase().includes(searchTerm)) ||
                        (po.supplierName && po.supplierName.toLowerCase().includes(searchTerm)) ||
                        (po.items && Array.isArray(po.items) && po.items.some(item => item.itemName && item.itemName.toLowerCase().includes(searchTerm)));
                    
                    const matchesStatus = 
                        statusFilter === 'all' || 
                        (po.status && po.status === statusFilter);
                    
                    const matchesSupplier = 
                        supplierFilter === 'all' || 
                        (po.supplierName && po.supplierName === supplierFilter);

                    const matchesItemName = 
                        itemNameFilter === 'all' || 
                        (po.items && Array.isArray(po.items) && po.items.some(item => item.itemName && item.itemName === itemNameFilter));

                    const matchesAllocation = 
                        allocationFilter === 'all' || 
                        (po.allocation && po.allocation === allocationFilter);

                    const matchesYear = yearFilter === 'all' || 
                                        (po.createdAt instanceof Date && po.createdAt.getFullYear().toString() === yearFilter);
                    
                    return matchesSearch && matchesStatus && matchesSupplier && matchesItemName && matchesAllocation && matchesYear;
                });
                
                renderFilteredPOs(filteredPOs);
            } catch (error) {
                console.error("Error filtering POs:", error);
            }
        }

        function renderFilteredPOs(filteredPOs) {
            const pipelineStage = document.getElementById('pos-stage');
            if (!pipelineStage) return;
            
            pipelineStage.innerHTML = '';
            
            if (filteredPOs.length === 0) {
                pipelineStage.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-search"></i>
                        <p>Tidak ada PO yang sesuai dengan filter.</p>
                    </div>
                `;
                return;
            }
            
            filteredPOs.forEach((po, index) => { // Teruskan index di sini
                const poCard = renderPO(po, index); // Panggil renderPO dengan index
                pipelineStage.appendChild(poCard);
                // Animate cards on filter result
                setTimeout(() => {
                    poCard.classList.add('show');
                }, 50 * index);
            });
        }

        function logout() {
            auth.signOut()
                .then(() => {
                    console.log("User logged out successfully");
                    pos = [];
                    window.location.href = 'login.html';
                })
                .catch((error) => {
                    console.error("Error logging out:", error);
                    showToast("Gagal logout. Silakan coba lagi.", 5000);
                });
        }

        function goToIndex() {
            window.location.href = 'index.html';
        }

        function openFilterPanel() {
            const filterPanel = document.getElementById('filterPanel');
            const filterPanelContent = document.getElementById('filterPanelContent');

            if (!filterPanel || !filterPanelContent) {
                console.error("Elemen panel filter tidak ditemukan.");
                showToast("Gagal membuka filter: Elemen tidak lengkap.", 3000);
                return;
            }

            populateYearDropdown();
            populateFilterDropdowns();

            filterPanel.classList.remove('hidden');
            filterPanelContent.classList.remove('modal-content-leave-active');
            filterPanelContent.classList.add('modal-content-enter-active');
        }

        function closeFilterPanel() {
            const filterPanelContent = document.getElementById('filterPanelContent');
            if (!filterPanelContent) {
                console.error("Elemen filterPanelContent tidak ditemukan saat menutup modal.");
                return;
            }

            filterPanelContent.classList.remove('modal-content-enter-active');
            filterPanelContent.classList.add('modal-content-leave-active');
            
            filterPanelContent.addEventListener('transitionend', function handler() {
                document.getElementById('filterPanel').classList.add('hidden');
                filterPanelContent.classList.remove('modal-content-leave-active');
                filterPanelContent.removeEventListener('transitionend', handler);
            }, { once: true });
        }

        function applyFiltersAndClosePanel() {
            filterPOs();
            closeFilterPanel();
        }

        function resetFilters() {
            document.getElementById('filterStatus').value = 'all';
            document.getElementById('filterSupplier').value = 'all';
            document.getElementById('filterItemName').value = 'all';
            document.getElementById('filterAllocation').value = 'all';
            document.getElementById('filterYear').value = 'all';
            document.getElementById('searchPOs').value = '';
            filterPOs();
        }

        // Fungsi closeDeleteModal yang sudah ada
        function closeDeleteModal() {
            const deleteModalContent = document.getElementById('deleteModalContent');
            if (!deleteModalContent) return;

            deleteModalContent.classList.remove('modal-content-enter-active');
            deleteModalContent.classList.add('modal-content-leave-active');
            
            deleteModalContent.addEventListener('transitionend', function handler() {
                document.getElementById('deleteModal').classList.add('hidden');
                deleteModalContent.classList.remove('modal-content-leave-active');
                deleteModalContent.removeEventListener('transitionend', handler);
            }, { once: true });
        }

        // ==================== INISIALISASI ====================

        document.addEventListener('DOMContentLoaded', function() {
            initSortable();
            setupSearchableField(); // Panggil fungsi setup pencarian
            // Initial load will be handled by auth.onAuthStateChanged
        });
    </script>
</body>
</html>
