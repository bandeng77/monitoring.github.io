<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PO Monitoring - Genetek</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>


    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .pipeline-stage {
            min-height: 480px;
            max-height: 600px;
            transition: all 0.3s ease;
            border-radius: 0.75rem;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            background-color: #ffffff;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            box-sizing: border-box;
        }
        .pipeline-stage-header {
            padding: 1.25rem;
            border-bottom: 1px solid #e2e8f0;
            background-color: #f1f5f9;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 0.25rem;
        }
        .pipeline-stage-header h3 {
            font-size: 1rem;
            font-weight: 700;
            color: #1f2937;
            flex-shrink: 0;
        }
        .pipeline-stage-header span {
            font-size: 0.75rem;
            font-weight: 600;
            white-space: nowrap;
        }
        .pipeline-stage-content {
            flex-grow: 1;
            padding: 1rem;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            min-height: 100px;
            height: 100%;
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-content: flex-start;
        }
        .deal-card {
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: grab;
            position: relative;
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            font-size: 0.875rem;
            width: calc(33.333% - 0.666rem);
            min-width: 250px;
            box-sizing: border-box;
            opacity: 0; /* Initial state for animation */
            transform: translateY(20px); /* Initial state for animation */
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        }
        .deal-card.show {
            opacity: 1;
            transform: translateY(0);
        }
        .deal-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
        }
        .deal-card:active {
            cursor: grabbing;
        }
        .sortable-ghost {
            opacity: 0.4;
            background-color: #e0f2fe;
            border: 1px dashed #90cdf4;
        }
        .sortable-chosen {
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            transform: scale(1.02);
        }
        .sortable-drag {
            opacity: 0.9;
        }
        .stage-main-pipeline { border-left: 5px solid #3B82F6; }
        .pipeline-stage-content::-webkit-scrollbar {
            width: 8px;
        }
        .pipeline-stage-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .pipeline-stage-content::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        .pipeline-stage-content::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        .modal-content-enter {
            opacity: 0;
            transform: scale(0.95);
        }
        .modal-content-enter-active {
            opacity: 1;
            transform: scale(1);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        }
        .modal-content-leave {
            opacity: 1;
            transform: scale(1);
        }
        .modal-content-leave-active {
            opacity: 0;
            transform: scale(0.95);
            transition: opacity 0.3s ease-in, transform 0.3s ease-in;
        }
        #toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .toast {
            background-color: #333;
            color: white;
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transform: translateX(100%);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        }
        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }
        #activityModalContent {
            max-height: 80vh;
            overflow-y: auto;
        }
        .activity-item {
            padding: 0.75rem;
            background-color: #f9fafb;
            border-radius: 0.375rem;
            border: 1px solid #e5e7eb;
            margin-bottom: 0.5rem;
        }
        .activity-item:last-child {
            margin-bottom: 0;
        }
        .activity-item p {
            font-size: 0.875rem;
            color: #374151;
        }
        .activity-item .activity-date {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }

        /* Penyesuaian CSS untuk deal card yang lebih ringkas */
        .deal-card h3 {
            font-size: 0.95rem;
            font-weight: 700;
            color: #1f2937;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: calc(100% - 60px);
        }

        .priority-badge {
            font-size: 0.65rem;
            padding: 0.15rem 0.4rem;
            line-height: 1;
        }

        .deal-details p {
            font-size: 0.75rem;
            margin-top: 0.15rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .deal-details p i {
            font-size: 0.7rem;
        }

        .deal-actions button {
            padding: 0.1rem 0.25rem;
            font-size: 0.7rem;
        }
        .deal-actions button i {
            font-size: 0.7rem;
        }

        .deal-footer {
            margin-top: 0.5rem;
        }

        /* Media Queries untuk responsivitas */
        @media (max-width: 1024px) {
            .deal-card {
                width: calc(50% - 0.5rem);
            }
        }

        @media (max-width: 768px) {
            .deal-card {
                width: 100%;
            }
        }

        /* CSS untuk membuat canvas melebar */
        .chart-container {
            width: 100%; /* Membuat container chart mengambil lebar penuh */
            height: 400px; /* Tinggi default untuk chart */
            margin-bottom: 1rem; /* Tambahkan sedikit margin bawah */
        }
        .chart-container canvas {
            width: 100% !important; /* Memastikan canvas mengambil lebar penuh dari containernya */
            height: 100% !important; /* Memastikan canvas mengambil tinggi penuh dari containernya */
        }

        /* Penyesuaian untuk modal Tambah/Edit Deal */
        #poModalContent {
            max-height: 100vh; /* Disesuaikan menjadi 100% tinggi viewport */
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            border-radius: 0; /* Menghilangkan border-radius agar terlihat full screen */
            width: 100%; /* Mengambil lebar penuh */
            max-width: 100%; /* Menghilangkan batasan lebar maksimum */
            box-sizing: border-box;
            padding: 1.5rem; /* Disesuaikan */
        }

        /* Menyamakan tinggi input dan select */
        #poForm input[type="text"],
        #poForm input[type="number"],
        #poForm input[type="date"],
        #poForm select {
            height: 40px; /* Disesuaikan */
            padding: 0.5rem 0.75rem; /* Disesuaikan */
            box-sizing: border-box;
            font-size: 0.8rem; /* Disesuaikan */
            border-width: 1px; /* Disesuaikan */
        }

        /* Menyesuaikan tinggi textarea remarks */
        #note {
            height: 100px; /* Disesuaikan */
            resize: vertical;
            font-size: 0.8rem; /* Disesuaikan */
            padding: 0.5rem 0.75rem; /* Disesuaikan */
        }

        /* Menghilangkan scrollbar jika konten pas */
        #poModalContent::-webkit-scrollbar {
            width: 0px;
            background: transparent;
        }

        #poModalContent {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Menyesuaikan ukuran font label */
        #poForm label {
            font-size: 0.75rem; /* Disesuaikan */
            margin-bottom: 0.15rem; /* Disesuaikan */
        }

        /* Menyesuaikan ukuran font judul modal */
        #poModalContent h2 {
            font-size: 1.5rem; /* Disesuaikan */
            margin-bottom: 1rem; /* Disesuaikan */
        }

        /* CSS untuk modal detail deal 2 kolom */
        #poDetailModalContent .detail-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem; /* Jarak antar kolom dan baris */
        }
        #poDetailModalContent .detail-item {
            /* Gaya untuk setiap item detail jika diperlukan */
        }

        /* Styles for search suggestions */
        .suggestions-list {
            border: 1px solid #e2e8f0;
            border-top: none;
            max-height: 150px;
            overflow-y: auto;
            background-color: #ffffff;
            position: absolute; /* Make it absolute to overlay other elements */
            width: calc(100% - 0px); /* Adjust width to match input */
            z-index: 10; /* Ensure it's above other elements */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border-radius: 0 0 0.5rem 0.5rem;
        }
        .suggestions-list.hidden {
            display: none;
        }
        .suggestions-list div { /* suggestion-item */
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            font-size: 0.8rem;
        }
        .suggestions-list div:hover {
            background-color: #f1f5f9;
        }
        .autocomplete-active { /* Untuk item yang aktif saat navigasi keyboard */
            background-color: #e0f2fe !important;
            color: #1f2937;
        }

        /* Global Loading Overlay */
        #global-loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        #global-loading-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3B82F6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Custom Alert Modal */
        #successAlertModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        #successAlertModalContent {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* Status Dropdown Styling */
        .status-dropdown {
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
            border: 1px solid transparent;
            appearance: none; /* Remove default arrow */
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='none'%3e%3cpath d='M7 7l3-3 3 3m0 6l-3 3-3-3' stroke='%236B7280' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1em;
            cursor: pointer;
        }
        .status-dropdown:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(66, 153, 225, 0.5); /* blue-500 with opacity */
        }

        /* Specific status colors */
        .status-on-order { background-color: #BFDBFE; color: #1E40AF; border-color: #60A5FA; } /* Blue-200 / Blue-800 */
        .status-waiting { background-color: #FEF3C7; color: #92400E; border-color: #FCD34D; } /* Yellow-100 / Yellow-800 */
        .status-picked-up { background-color: #D1FAE5; color: #065F46; border-color: #6EE7B7; } /* Green-100 / Green-800 */
        .status-on-delivery { background-color: #DBEAFE; color: #1E40AF; border-color: #93C5FD; } /* Blue-100 / Blue-800 */
        .status-delivered { background-color: #D1FAE5; color: #065F46; border-color: #34D399; } /* Green-100 / Green-800 */
        .status-partial-delivered { background-color: #FEE2E2; color: #991B1B; border-color: #FCA5A5; } /* Red-100 / Red-800 */
        .status-delayed { background-color: #FEE2E2; color: #991B1B; border-color: #EF4444; } /* Red-100 / Red-800 */
        .status-on-hold { background-color: #F3E8FF; color: #5B21B6; border-color: #C4B5FD; } /* Purple-100 / Purple-800 */

        /* PO Card Number */
        .po-card-number {
            position: absolute;
            top: 0.5rem;
            left: 0.5rem;
            font-size: 0.7rem;
            font-weight: bold;
            color: #6B7280;
            background-color: #E5E7EB;
            padding: 0.1rem 0.4rem;
            border-radius: 0.25rem;
        }

        /* Empty State Styling */
        .empty-state {
            text-align: center;
            padding: 2rem;
            color: #9CA3AF;
            font-size: 1rem;
            width: 100%;
        }
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        /* Ripple Effect */
        .ripple {
            position: absolute;
            border-radius: 50%;
            transform: scale(0);
            animation: ripple 600ms linear;
            background-color: rgba(255, 255, 255, 0.7);
        }
        @keyframes ripple {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }
        button {
            position: relative;
            overflow: hidden;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <!-- Global Loading Overlay -->
    <div id="global-loading-overlay" class="hidden">
        <div class="spinner"></div>
    </div>

    <!-- Custom Alert Modal -->
    <div id="successAlertModal" class="hidden">
        <div id="successAlertModalContent" class="bg-white p-8 rounded-lg shadow-lg max-w-sm w-full">
            <div class="text-6xl mb-4">
                <i class="fas fa-check-circle text-green-500"></i>
            </div>
            <p id="successAlertMessage" class="text-lg font-semibold text-gray-800 mb-6"></p>
            <button onclick="closeSuccessAlertModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg shadow-md font-medium transition duration-200 ease-in-out transform hover:scale-105">
                OK
            </button>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 py-8">
        <!-- Header -->
        <header class="mb-8 bg-white p-6 rounded-lg shadow-md">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                <div class="flex items-center mb-4 sm:mb-0">
                    <button id="backButton" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-3 py-2 rounded-lg shadow-md transition duration-200 ease-in-out transform hover:scale-105 flex items-center text-sm mr-4">
                        <i class="fas fa-arrow-left mr-2"></i> Kembali
                    </button>
                    <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-900">PO Monitoring <i class="fas fa-truck-loading text-blue-600 ml-2"></i></h1>
                </div>
                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4 mt-4 sm:mt-0">
                    <button id="authButton" onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg shadow-md transition duration-200 ease-in-out transform hover:scale-105 flex items-center text-sm">
                        <i class="fas fa-sign-out-alt mr-2"></i> Logout
                    </button>

                    <button id="newPOBtn" onclick="openPOModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow-md transition duration-200 ease-in-out transform hover:scale-105 flex items-center text-sm">
                        <i class="fas fa-plus-circle mr-2"></i> PO Baru
                    </button>

                    <button id="exportExcelBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg shadow-md transition duration-200 ease-in-out transform hover:scale-105 flex items-center text-sm">
                        <i class="fas fa-file-excel mr-2"></i> Export Excel
                    </button>
                </div>
            </div>

            <!-- Combined Filter Section -->
            <div class="mt-6 flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4 items-center">
                <input type="text" id="searchPOs" onkeyup="filterPOs()" placeholder="Cari PO berdasarkan No. PO, Supplier, No ID, Barang..." class="w-full sm:w-1/2 p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">

                <button id="openFilterPanelBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg shadow-md transition duration-200 ease-in-out transform hover:scale-105 flex items-center text-sm">
                    <i class="fas fa-filter mr-2"></i> Filter
                </button>
            </div>
        </header>

        <!-- PO Visualization -->
        <div class="grid grid-cols-1 gap-6 mb-10">
            <div class="pipeline-stage stage-main-pipeline">
                <div class="pipeline-stage-header">
                    <h3>Purchase Orders</h3>
                </div>
                <div id="pos-stage" class="pipeline-stage-content">
                    <!-- POs will be displayed here -->
                    <div id="loading-spinner" class="absolute inset-0 flex items-center justify-center bg-white bg-opacity-75 z-10 hidden">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add/Edit PO Modal -->
        <div id="poModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
            <div class="bg-white rounded-none p-8 w-full h-full shadow-2xl modal-content-enter" id="poModalContent">
                <h2 class="text-xl sm:text-2xl font-bold mb-6 text-gray-900" id="modalTitle">Tambah PO Baru</h2>
                <form id="poForm">
                    <input type="hidden" id="poId">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
                        <!-- Kolom 1 -->
                        <div>
                            <div class="mb-3">
                                <label class="block text-gray-700 text-sm font-semibold mb-2" for="orderConfirmation">Order Confirmation</label>
                                <input type="text" id="orderConfirmation" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                            </div>
                            <div class="mb-3">
                                <label class="block text-gray-700 text-sm font-semibold mb-2" for="noPO">No. PO <span class="text-red-500">*</span></label>
                                <input type="text" id="noPO" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm" required>
                            </div>
                            <div class="mb-3">
                                <label class="block text-gray-700 text-sm font-semibold mb-2" for="supplierName">Nama Supplier</label>
                                <input type="text" id="supplierName" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                            </div>
                            <div class="mb-3 relative">
                                <label class="block text-gray-700 text-sm font-semibold mb-2" for="noIdSearch">No ID</label>
                                <input type="text" id="noIdSearch" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm" placeholder="Cari atau ketik No ID">
                                <input type="hidden" id="selectedNoId"> <!-- Hidden input to store the actual value -->
                                <div id="noIdSuggestions" class="suggestions-list absolute bg-white border border-gray-300 rounded-lg shadow-lg mt-1 w-full z-10 hidden"></div>
                            </div>
                        </div>
                        <!-- Kolom 2 -->
                        <div>
                            <div class="mb-3">
                                <label class="block text-gray-700 text-sm font-semibold mb-2">Nama Barang & Quantity</label>
                                <div id="items-container" class="space-y-2">
                                    <!-- Item rows will be added here by JavaScript -->
                                </div>
                                <button type="button" onclick="addItemField()" class="mt-2 bg-gray-200 hover:bg-gray-300 text-gray-800 px-3 py-2 rounded-lg shadow-md transition duration-200 ease-in-out transform hover:scale-105 flex items-center text-sm">
                                    <i class="fas fa-plus mr-1"></i> Tambah Barang
                                </button>
                            </div>
                            <div class="mb-3">
                                <label class="block text-gray-700 text-sm font-semibold mb-2" for="allocation">Allocation</label>
                                <input type="text" id="allocation" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                            </div>
                            <div class="mb-3">
                                <label class="block text-gray-700 text-sm font-semibold mb-2" for="invoice">Invoice</label>
                                <input type="text" id="invoice" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                            </div>
                            <div class="mb-3">
                                <label class="block text-gray-700 text-sm font-semibold mb-2" for="tracking">Tracking</label>
                                <input type="text" id="tracking" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                            </div>
                        </div>
                        <!-- Kolom 3 -->
                        <div>
                            <div class="mb-3">
                                <label class="block text-gray-700 text-sm font-semibold mb-2" for="seaForwarder">Sea Forwarder</label>
                                <input type="text" id="seaForwarder" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                            </div>
                            <div class="mb-3">
                                <label class="block text-gray-700 text-sm font-semibold mb-2" for="airForwarder">Air Forwarder</label>
                                <input type="text" id="airForwarder" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                            </div>
                            <div class="mb-3">
                                <label class="block text-gray-700 text-sm font-semibold mb-2" for="disrc">DISRC</label>
                                <input type="text" id="disrc" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                            </div>
                            <div class="mb-3">
                                <label class="block text-gray-700 text-sm font-semibold mb-2" for="planDelivery">Plan Delivery</label>
                                <input type="date" id="planDelivery" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                            </div>
                            <div class="mb-3">
                                <label class="block text-gray-700 text-sm font-semibold mb-2" for="eta">ETA</label>
                                <input type="date" id="eta" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                            </div>
                        </div>
                        <!-- Kolom 4 -->
                        <div>
                            <div class="mb-3">
                                <label class="block text-gray-700 text-sm font-semibold mb-2" for="actualDelivery">Actual Delivery</label>
                                <input type="date" id="actualDelivery" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                            </div>
                            <div class="mb-3">
                                <label class="block text-gray-700 text-sm font-semibold mb-2" for="coo">COO</label>
                                <input type="text" id="coo" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                            </div>
                            <div class="mb-3">
                                <label class="block text-gray-700 text-sm font-semibold mb-2" for="hsCode">HS Code</label>
                                <input type="text" id="hsCode" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                            </div>
                            <div class="mb-3">
                                <label class="block text-gray-700 text-sm font-semibold mb-2" for="revisiHS">Revisi HS</label>
                                <input type="text" id="revisiHS" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                            </div>
                            <div class="mb-3">
                                <label class="block text-gray-700 text-sm font-semibold mb-2" for="note">Note</label>
                                <textarea id="note" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm" rows="2"></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="block text-gray-700 text-sm font-semibold mb-2" for="status">Status</label>
                                <select id="status" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                                    <option value="On Order">On Order</option>
                                    <option value="Waiting">Waiting</option>
                                    <option value="Picked Up">Picked Up</option>
                                    <option value="On Delivery">On Delivery</option>
                                    <option value="Delivered">Delivered</option>
                                    <option value="Partial Delivered">Partial Delivered</option>
                                    <option value="Delayed">Delayed</option>
                                    <option value="On Hold">On Hold</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="closePOModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800 font-medium rounded-lg transition duration-200 text-sm">
                            Batal
                        </button>
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow-md font-medium transition duration-200 ease-in-out transform hover:scale-105 text-sm">
                            Simpan PO
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- PO Detail Modal -->
        <div id="poDetailModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
            <div class="bg-white rounded-xl p-8 w-full max-w-md shadow-2xl modal-content-enter" id="poDetailModalContent">
                <h2 class="text-xl sm:text-2xl font-bold mb-6 text-gray-900" id="poDetailTitle">Detail PO</h2>
                <div class="detail-grid">
                    <div class="detail-item">
                        <p class="text-gray-700 font-semibold">Order Confirmation:</p>
                        <p id="detailOrderConfirmation" class="text-gray-900"></p>
                    </div>
                    <div class="detail-item">
                        <p class="text-gray-700 font-semibold">No. PO:</p>
                        <p id="detailNoPO" class="text-gray-900"></p>
                    </div>
                    <div class="detail-item">
                        <p class="text-gray-700 font-semibold">Nama Supplier:</p>
                        <p id="detailSupplierName" class="text-gray-900"></p>
                    </div>
                    <div class="detail-item">
                        <p class="text-gray-700 font-semibold">No ID:</p>
                        <p id="detailNoId" class="text-gray-900"></p>
                    </div>
                    <div class="detail-item col-span-2">
                        <p class="text-gray-700 font-semibold">Nama Barang & Quantity:</p>
                        <ul id="detailItemsList" class="list-disc list-inside text-gray-900"></ul>
                    </div>
                    <div class="detail-item">
                        <p class="text-gray-700 font-semibold">Allocation:</p>
                        <p id="detailAllocation" class="text-gray-900"></p>
                    </div>
                    <div class="detail-item">
                        <p class="text-gray-700 font-semibold">Invoice:</p>
                        <p id="detailInvoice" class="text-gray-900"></p>
                    </div>
                    <div class="detail-item">
                        <p class="text-gray-700 font-semibold">Tracking:</p>
                        <p id="detailTracking" class="text-gray-900"></p>
                    </div>
                    <div class="detail-item">
                        <p class="text-gray-700 font-semibold">Sea Forwarder:</p>
                        <p id="detailSeaForwarder" class="text-gray-900"></p>
                    </div>
                    <div class="detail-item">
                        <p class="text-gray-700 font-semibold">Air Forwarder:</p>
                        <p id="detailAirForwarder" class="text-gray-900"></p>
                    </div>
                    <div class="detail-item">
                        <p class="text-gray-700 font-semibold">DISRC:</p>
                        <p id="detailDisrc" class="text-gray-900"></p>
                    </div>
                    <div class="detail-item">
                        <p class="text-gray-700 font-semibold">Plan Delivery:</p>
                        <p id="detailPlanDelivery" class="text-gray-900"></p>
                    </div>
                    <div class="detail-item">
                        <p class="text-gray-700 font-semibold">ETA:</p>
                        <p id="detailETA" class="text-gray-900"></p>
                    </div>
                    <div class="detail-item">
                        <p class="text-gray-700 font-semibold">Actual Delivery:</p>
                        <p id="detailActualDelivery" class="text-gray-900"></p>
                    </div>
                    <div class="detail-item">
                        <p class="text-gray-700 font-semibold">Status:</p>
                        <p id="detailStatus" class="text-gray-900"></p>
                    </div>
                    <div class="detail-item">
                        <p class="text-gray-700 font-semibold">COO:</p>
                        <p id="detailCOO" class="text-gray-900"></p>
                    </div>
                    <div class="detail-item">
                        <p class="text-gray-700 font-semibold">HS Code:</p>
                        <p id="detailHSCode" class="text-gray-900"></p>
                    </div>
                    <div class="detail-item">
                        <p class="text-gray-700 font-semibold">Revisi HS:</p>
                        <p id="detailRevisiHS" class="text-gray-900"></p>
                    </div>
                    <div class="detail-item col-span-2">
                        <p class="text-gray-700 font-semibold">Note:</p>
                        <p id="detailNote" class="text-gray-900"></p>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="closePODetailModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800 font-medium rounded-lg transition duration-200 text-sm">
                        Tutup
                    </button>
                </div>
            </div>
        </div>

        <!-- Delete Confirmation Modal -->
        <div id="deleteModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
            <div class="bg-white rounded-xl p-8 w-full max-w-sm shadow-2xl modal-content-enter" id="deleteModalContent">
                <h2 class="text-xl font-bold mb-4 text-gray-900">Konfirmasi Penghapusan</h2>
                <p class="text-gray-700 mb-6 text-sm">Apakah Anda yakin ingin menghapus PO "<span id="dealToDeleteName" class="font-semibold"></span>"? Aksi ini tidak dapat dibatalkan.</p>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeDeleteModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800 font-medium rounded-lg transition duration-200 text-sm">
                        Batal
                    </button>
                    <button type="button" id="confirmDeleteBtn" onclick="deletePO()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg shadow-md font-medium transition duration-200 ease-in-out transform hover:scale-105 text-sm">
                        Hapus
                    </button>
                </div>
            </div>
        </div>

        <!-- Filter Panel Modal -->
        <div id="filterPanel" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
            <div class="bg-white rounded-xl p-8 w-full max-w-2xl shadow-2xl modal-content-enter" id="filterPanelContent">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-900 flex items-center"><i class="fas fa-filter mr-3 text-gray-500"></i> Filter POs</h2>
                    <button onclick="closeFilterPanel()" class="text-gray-500 hover:text-gray-700 transition duration-200">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-semibold mb-2" for="filterSupplier">Supplier</label>
                        <select id="filterSupplier" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                            <option value="all">Semua Supplier</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-semibold mb-2" for="filterCOO">COO</label>
                        <select id="filterCOO" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                            <option value="all">Semua COO</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-semibold mb-2" for="filterHSCode">HS Code</label>
                        <select id="filterHSCode" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                            <option value="all">Semua HS Code</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-semibold mb-2" for="filterStatus">Status</label>
                        <select id="filterStatus" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                            <option value="all">Semua Status</option>
                            <option value="On Order">On Order</option>
                            <option value="Waiting">Waiting</option>
                            <option value="Picked Up">Picked Up</option>
                            <option value="On Delivery">On Delivery</option>
                            <option value="Delivered">Delivered</option>
                            <option value="Partial Delivered">Partial Delivered</option>
                            <option value="Delayed">Delayed</option>
                            <option value="On Hold">On Hold</option>
                        </select>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="resetFilters()" class="px-4 py-2 text-gray-600 hover:text-gray-800 font-medium rounded-lg transition duration-200 text-sm">
                        Reset Filter
                    </button>
                    <button type="button" onclick="applyFiltersAndClosePanel()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow-md font-medium transition duration-200 ease-in-out transform hover:scale-105 text-sm">
                        Terapkan Filter
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Konfigurasi Firebase (tetap ada untuk otentikasi dan PO, tapi tidak untuk productsCollection)
        const firebaseConfig = {
              apiKey: "AIzaSyB9s6k2K75vrbe1lWgiu42SAXV_lySHHNU",
              authDomain: "monitoring-efk.firebaseapp.com",
              projectId: "monitoring-efk",
              storageBucket: "monitoring-efk.firebasestorage.app",
              messagingSenderId: "1083858508151",
              appId: "1:1083858508151:web:3d505dec79d715f9cd6972"
        };

        // Inisialisasi Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const dealsCollection = db.collection('purchaseOrders');
        const usersCollection = db.collection('users');

        let pos = [];
        const DEFAULT_STATUS = 'On Order';
        let currentUserRole = 'user';
        let sortableInstances = {};
        let authInitialized = false;
        let unsubscribeFromPOs = null;

        // Data untuk search No ID dan Nama Barang
        let noIdData = []; // Akan berisi array string dari no_id
        let productsData = []; // Akan berisi array string dari nama_barang

        // Hanya menyimpan Set untuk filter yang diinginkan
        let uniqueSuppliers = new Set();
        let uniqueCOOs = new Set();
        let uniqueHSCodes = new Set();
        let uniqueStatuses = new Set();

        const ADMIN_EMAIL = 'maida@genetek.co.id';

        // Deklarasi variabel elemen DOM di scope global agar tidak dideklarasikan ulang
        let noIdSearchInput, selectedNoIdHiddenInput, noIdSuggestionsDiv;

        // ==================== FUNGSI UTAMA ====================

        auth.onAuthStateChanged(async (user) => {
            if (authInitialized) return;
            authInitialized = true;

            console.log("Auth state changed:", user ? user.email : "no user");

            if (!user && window.location.pathname.includes('app.html')) {
                console.log("No user, redirecting to login");
                window.location.href = 'login.html';
                return;
            }

            if (user && window.location.pathname.includes('login.html')) {
                console.log("User already logged in, redirecting to app");
                window.location.href = 'app.html';
                return;
            }

            if (user && window.location.pathname.includes('app.html')) {
                try {
                    showGlobalLoading();
                    if (user.email === ADMIN_EMAIL) {
                        currentUserRole = 'admin';
                        await usersCollection.doc(user.uid).set({
                            role: 'admin',
                            email: user.email
                        }, { merge: true });
                    } else {
                        console.log("Unauthorized user, logging out and redirecting to login.");
                        await auth.signOut();
                        window.location.href = 'login.html';
                        return;
                    }

                    console.log("Current role:", currentUserRole);
                    // Pastikan data di-fetch sebelum inisialisasi lainnya
                    await fetchNoIdData();
                    await fetchProductsData();
                    listenForPOs();
                    initEventListeners();
                    hideGlobalLoading();
                } catch (error) {
                    console.error("Error checking user role or loading data:", error);
                    showCustomAlert("Gagal memuat data pengguna atau aplikasi. Silakan refresh halaman.", "error");
                    hideGlobalLoading();
                }
            }
        });

        // Fungsi untuk mengambil data No ID dari JSON eksternal
        async function fetchNoIdData() {
            try {
                const response = await fetch('https://raw.githubusercontent.com/bandeng77/monitoring.github.io/main/noid.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const rawData = await response.json();
                // Filter out any null/undefined values and ensure they are strings
                noIdData = rawData.map(item => item.no_id).filter(item => typeof item === 'string' && item.trim() !== '');
                console.log("No ID data loaded:", noIdData.length, "items. Data:", noIdData);
            } catch (error) {
                console.error("Error fetching No ID data:", error);
                showCustomAlert("Gagal memuat data No ID. Fitur autocomplete No ID mungkin tidak berfungsi.", "error");
                noIdData = [];
            }
        }

        // Fungsi untuk mengambil data produk dari JSON eksternal
        async function fetchProductsData() {
            try {
                const response = await fetch('https://raw.githubusercontent.com/bandeng77/monitoring.github.io/main/products.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const rawData = await response.json();
                // Filter out any null/undefined values and ensure they are strings
                productsData = rawData.map(item => item.nama_barang).filter(item => typeof item === 'string' && item.trim() !== '');
                console.log("Products data loaded:", productsData.length, "items. Data:", productsData);
            } catch (error) {
                console.error("Error fetching products data:", error);
                showCustomAlert("Gagal memuat data produk. Fitur autocomplete Nama Barang mungkin tidak berfungsi.", "error");
                productsData = [];
            }
        }

        // ==================== FUNGSI UTILITAS ====================

        function formatDateTime(timestamp) {
            if (!timestamp) return '-';
            try {
                const date = timestamp instanceof Date ? timestamp : (timestamp && typeof timestamp.toDate === 'function' ? timestamp.toDate() : null);
                if (!date) return '-';

                return date.toLocaleString('id-ID', {
                    day: 'numeric',
                    month: 'short',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                console.error("Error formatting date time:", e);
                return '-';
            }
        }

        function formatNumber(num) {
            if (num === null || num === undefined || isNaN(num)) {
                return '0';
            }
            return new Intl.NumberFormat('id-ID').format(num);
        }

        function formatDate(timestamp) {
            if (!timestamp) return '-';
            try {
                const date = timestamp instanceof Date ? timestamp : (timestamp && typeof timestamp.toDate === 'function' ? timestamp.toDate() : null);
                if (!date) return '-';

                return date.toLocaleDateString('id-ID');
            } catch (e) {
                console.error("Error formatting date:", e);
                return '-';
            }
        }

        function showCustomAlert(message, type = 'success') {
            const modal = document.getElementById('successAlertModal');
            const modalContent = document.getElementById('successAlertModalContent');
            const alertMessage = document.getElementById('successAlertMessage');
            const alertIcon = modalContent.querySelector('.text-6xl i');

            alertMessage.textContent = message;

            if (type === 'success') {
                alertIcon.className = 'fas fa-check-circle text-green-500';
            } else if (type === 'error') {
                alertIcon.className = 'fas fa-times-circle text-red-500';
            } else if (type === 'info') {
                alertIcon.className = 'fas fa-info-circle text-blue-500';
            } else if (type === 'warning') {
                alertIcon.className = 'fas fa-exclamation-triangle text-yellow-500';
            }

            modal.classList.remove('hidden');
        }

        function closeSuccessAlertModal() {
            const modal = document.getElementById('successAlertModal');
            if (!modal) return;
            modal.classList.add('hidden');
        }

        function showGlobalLoading() {
            document.getElementById('global-loading-overlay').classList.add('show');
        }

        function hideGlobalLoading() {
            document.getElementById('global-loading-overlay').classList.remove('show');
        }

        // ==================== FUNGSI PO ====================

        function listenForPOs() {
            console.log("Listening for POs from Firebase (onSnapshot)...");
            const pipelineStage = document.getElementById('pos-stage');
            const loadingSpinner = document.getElementById('loading-spinner');
            if (pipelineStage && loadingSpinner) {
                pipelineStage.innerHTML = '';
                loadingSpinner.classList.remove('hidden');
            }

            if (unsubscribeFromPOs) {
                unsubscribeFromPOs();
            }

            dealsCollection.orderBy("createdAt", "asc").onSnapshot(snapshot => {
                pos = [];
                uniqueSuppliers.clear();
                uniqueCOOs.clear();
                uniqueHSCodes.clear();
                uniqueStatuses.clear();

                snapshot.forEach((doc) => {
                    const poData = doc.data();
                    poData.createdAt = poData.createdAt && typeof poData.createdAt.toDate === 'function' ? poData.createdAt.toDate() : null;
                    poData.planDelivery = poData.planDelivery && typeof poData.planDelivery.toDate === 'function' ? poData.planDelivery.toDate() : null;
                    poData.eta = poData.eta && typeof poData.eta.toDate === 'function' ? poData.eta.toDate() : null;
                    poData.actualDelivery = poData.actualDelivery && typeof poData.actualDelivery.toDate === 'function' ? poData.actualDelivery.toDate() : null;

                    pos.push({ id: doc.id, ...poData });

                    if (poData.supplierName) uniqueSuppliers.add(poData.supplierName);
                    if (poData.coo) uniqueCOOs.add(poData.coo);
                    if (poData.hsCode) uniqueHSCodes.add(poData.hsCode);
                    if (poData.status) uniqueStatuses.add(poData.status);
                });
                console.log("Total POs updated by onSnapshot:", pos.length);
                populateFilterDropdowns();
                filterPOs();
                if (loadingSpinner) {
                    loadingSpinner.classList.add('hidden');
                }
            }, (error) => {
                console.error("Error listening to POs:", error);
                showCustomAlert("Gagal memuat data PO secara realtime.", "error");
                if (loadingSpinner) {
                    loadingSpinner.classList.add('hidden');
                }
            });
        }

        function renderPO(po, index) {
            const poCard = document.createElement('div');
            poCard.className = 'deal-card';
            poCard.dataset.id = po.id;

            function getStatusClass(status) {
                switch (status) {
                    case 'On Order': return 'status-on-order';
                    case 'Waiting': return 'status-waiting';
                    case 'Picked Up': return 'status-picked-up';
                    case 'On Delivery': return 'status-on-delivery';
                    case 'Delivered': return 'status-delivered';
                    case 'Partial Delivered': return 'status-partial-delivered';
                    case 'Delayed': return 'status-delayed';
                    case 'On Hold': return 'status-on-hold';
                    default: return 'bg-gray-400 text-white';
                }
            }

            poCard.innerHTML = `
                <span class="po-card-number">${index + 1}</span>
                <div class="flex justify-between items-start">
                    <h3 class="font-bold text-gray-800">No. PO: ${po.noPO || 'No PO'}</h3>
                </div>
                <div class="mt-1 text-sm text-gray-600 deal-details">
                    <p><i class="fas fa-building"></i> Supplier: ${po.supplierName || '-'}</p>
                    <p><i class="fas fa-id-card"></i> No ID: ${po.selectedNoId || '-'}</p>
                    <p><i class="fas fa-calendar-alt"></i> Plan Delivery: ${po.planDelivery ? formatDate(po.planDelivery) : '-'}</p>
                </div>
                <div class="mt-2 flex justify-between items-center deal-footer">
                    <div class="relative">
                        <select onchange="updatePOStatus('${po.id}', this.value)" class="status-dropdown ${getStatusClass(po.status)}">
                            <option value="On Order" ${po.status === 'On Order' ? 'selected' : ''}>On Order</option>
                            <option value="Waiting" ${po.status === 'Waiting' ? 'selected' : ''}>Waiting</option>
                            <option value="Picked Up" ${po.status === 'Picked Up' ? 'selected' : ''}>Picked Up</option>
                            <option value="On Delivery" ${po.status === 'On Delivery' ? 'selected' : ''}>On Delivery</option>
                            <option value="Delivered" ${po.status === 'Delivered' ? 'selected' : ''}>Delivered</option>
                            <option value="Partial Delivered" ${po.status === 'Partial Delivered' ? 'selected' : ''}>Partial Delivered</option>
                            <option value="Delayed" ${po.status === 'Delayed' ? 'selected' : ''}>Delayed</option>
                            <option value="On Hold" ${po.status === 'On Hold' ? 'selected' : ''}>On Hold</option>
                        </select>
                    </div>
                    <div class="flex space-x-1 deal-actions">
                        <button onclick="openPODetailModal('${po.id}')" class="text-blue-600 hover:text-blue-800" title="Lihat Detail">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button onclick="prepareEditPO('${po.id}')" class="text-green-600 hover:text-green-800" title="Edit PO">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="confirmDeletePO('${po.id}', '${po.noPO}')" class="text-red-600 hover:text-red-800" title="Hapus PO">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </div>
            `;

            return poCard;
        }

        function populateDropdown(selectElementId, uniqueValues, selectedValue = 'all') {
            const selectElement = document.getElementById(selectElementId);
            if (!selectElement) {
                console.warn(`Element with ID '${selectElementId}' not found.`);
                return;
            }

            const currentSelectedValue = selectElement.value;

            selectElement.innerHTML = '';

            const defaultOption = document.createElement('option');
            defaultOption.value = 'all';
            const labelElement = selectElement.previousElementSibling;
            const labelText = labelElement ? labelElement.textContent.replace(':', '').replace('*', '').trim() : '';
            defaultOption.textContent = `Semua ${labelText}`;
            selectElement.appendChild(defaultOption);

            const sortedValues = Array.from(uniqueValues).sort();
            sortedValues.forEach(value => {
                if (value) {
                    const option = document.createElement('option');
                    option.value = value;
                    option.textContent = value;
                    selectElement.appendChild(option);
                }
            });

            if (Array.from(selectElement.options).some(option => option.value === currentSelectedValue)) {
                selectElement.value = currentSelectedValue;
            } else {
                selectElement.value = 'all';
            }
        }

        function populateFilterDropdowns() {
            populateDropdown('filterSupplier', uniqueSuppliers, document.getElementById('filterSupplier').value);
            populateDropdown('filterCOO', uniqueCOOs, document.getElementById('filterCOO').value);
            populateDropdown('filterHSCode', uniqueHSCodes, document.getElementById('filterHSCode').value);
            populateDropdown('filterStatus', uniqueStatuses, document.getElementById('filterStatus').value);
        }

        // ==================== FUNGSI UNTUK FORM TAMBAHAN DENGAN SEARCH ====================

        /**
         * Fungsi autocomplete yang lebih generik, mendukung hidden input untuk menyimpan nilai yang dipilih.
         * @param {HTMLInputElement} searchInput - Elemen input teks yang digunakan untuk pencarian.
         * @param {HTMLInputElement} hiddenInput - Elemen input hidden untuk menyimpan nilai yang dipilih.
         * @param {HTMLDivElement} suggestionsDiv - Elemen div untuk menampilkan saran.
         * @param {Array<string>} dataList - Array string dari nilai yang mungkin.
         * @param {Set<string>} uniqueDataSet - Set untuk menambahkan nilai baru yang diketik pengguna.
         */
        function setupSearchWithSuggestions(searchInput, hiddenInput, suggestionsDiv, dataList, uniqueDataSet) {
            let currentFocus = -1;

            const handleInput = () => {
                const val = searchInput.value;
                closeAllSuggestionLists(suggestionsDiv);
                if (!val) {
                    hiddenInput.value = ''; // Clear hidden input if search input is empty
                    return false;
                }
                currentFocus = -1;

                // PERBAIKAN UTAMA DI SINI: Tambahkan pemeriksaan `item`
                const filteredSuggestions = dataList
                    .filter(item => item && item.toLowerCase().includes(val.toLowerCase()))
                    .sort();

                if (filteredSuggestions.length > 0) {
                    filteredSuggestions.forEach(item => {
                        const b = document.createElement("DIV");
                        const startIdx = item.toLowerCase().indexOf(val.toLowerCase());
                        b.innerHTML = item.substring(0, startIdx) + "<strong>" + item.substring(startIdx, startIdx + val.length) + "</strong>" + item.substring(startIdx + val.length);
                        b.innerHTML += "<input type='hidden' value='" + item + "'>";

                        b.addEventListener("click", function(e) {
                            e.stopPropagation();
                            searchInput.value = this.getElementsByTagName("input")[0].value;
                            hiddenInput.value = searchInput.value; // Update hidden input
                            closeAllSuggestionLists(suggestionsDiv);
                            // Add to unique set if it's a new value
                            if (!uniqueDataSet.has(searchInput.value)) {
                                uniqueDataSet.add(searchInput.value);
                            }
                        });
                        suggestionsDiv.appendChild(b);
                    });
                    suggestionsDiv.classList.remove('hidden');
                } else {
                    suggestionsDiv.classList.add('hidden');
                }
                // If no suggestions, the typed value is considered the selected value
                hiddenInput.value = val;
            };

            const handleKeydown = (e) => {
                let x = suggestionsDiv.getElementsByTagName("div");
                if (e.keyCode == 40) { // Panah Bawah
                    currentFocus++;
                    addActive(x);
                } else if (e.keyCode == 38) { // Panah Atas
                    currentFocus--;
                    addActive(x);
                } else if (e.keyCode == 13) { // Enter
                    e.preventDefault();
                    if (currentFocus > -1) {
                        if (x && x[currentFocus]) x[currentFocus].click();
                    } else {
                        // If Enter is pressed and no suggestion is selected, use the typed value
                        hiddenInput.value = searchInput.value;
                        closeAllSuggestionLists(suggestionsDiv);
                        if (!uniqueDataSet.has(searchInput.value)) {
                            uniqueDataSet.add(searchInput.value);
                        }
                    }
                }
            };

            const handleBlur = () => {
                // Ensure the hidden input always reflects the search input's value on blur
                // This handles cases where user types a new value and clicks away
                hiddenInput.value = searchInput.value;
                if (searchInput.value && !uniqueDataSet.has(searchInput.value)) {
                    uniqueDataSet.add(searchInput.value);
                }
                setTimeout(() => closeAllSuggestionLists(suggestionsDiv), 100); // Delay to allow click event on suggestion
            };

            const handleFocus = () => {
                // Re-trigger input event on focus if there's text, to show suggestions again
                if (searchInput.value.length > 0) {
                    handleInput();
                }
            };

            searchInput.removeEventListener('input', handleInput);
            searchInput.removeEventListener('keydown', handleKeydown);
            searchInput.removeEventListener('blur', handleBlur);
            searchInput.removeEventListener('focus', handleFocus);

            searchInput.addEventListener('input', handleInput);
            searchInput.addEventListener('keydown', handleKeydown);
            searchInput.addEventListener('blur', handleBlur);
            searchInput.addEventListener('focus', handleFocus);

            function addActive(x) {
                if (!x) return false;
                removeActive(x);
                if (currentFocus >= x.length) currentFocus = 0;
                if (currentFocus < 0) currentFocus = (x.length - 1);
                x[currentFocus].classList.add("autocomplete-active");
            }

            function removeActive(x) {
                for (let i = 0; i < x.length; i++) {
                    x[i].classList.remove("autocomplete-active");
                }
            }

            function closeAllSuggestionLists(exceptThisOne = null) {
                const items = document.querySelectorAll(".suggestions-list");
                items.forEach(item => {
                    if (item !== exceptThisOne) {
                        item.classList.add('hidden');
                        item.innerHTML = ''; // Clear content
                    }
                });
            }

            // Global click listener to close all suggestion lists if clicked outside
            document.removeEventListener("click", handleDocumentClick); // Remove previous listener
            document.addEventListener("click", handleDocumentClick);

            function handleDocumentClick(e) {
                // Check if the clicked element is inside the searchInput or suggestionsDiv
                // or if it's a child of the suggestionsDiv (a suggestion item)
                if (!searchInput.contains(e.target) && !suggestionsDiv.contains(e.target) && !e.target.closest('.suggestions-list')) {
                    closeAllSuggestionLists();
                }
            }
        }

        // Setup autocomplete untuk input No ID
        function setupNoIdSearch() {
            noIdSearchInput = document.getElementById('noIdSearch');
            selectedNoIdHiddenInput = document.getElementById('selectedNoId');
            noIdSuggestionsDiv = document.getElementById('noIdSuggestions');

            console.log("setupNoIdSearch called.");
            console.log("noIdSearchInput:", noIdSearchInput);
            console.log("selectedNoIdHiddenInput:", selectedNoIdHiddenInput);
            console.log("noIdSuggestionsDiv:", noIdSuggestionsDiv);
            console.log("noIdData for autocomplete:", noIdData);

            if (noIdSearchInput && selectedNoIdHiddenInput && noIdSuggestionsDiv && noIdData.length > 0) {
                setupSearchWithSuggestions(noIdSearchInput, selectedNoIdHiddenInput, noIdSuggestionsDiv, noIdData, new Set(noIdData));
                console.log("setupSearchWithSuggestions for No ID initialized.");
            } else if (noIdSearchInput) {
                console.warn("No ID data not available or empty. Autocomplete for No ID disabled.");
            }
        }

        // Setup autocomplete untuk input Nama Barang
        function setupItemSearch(inputElement, hiddenInputElement, suggestionsDivElement) {
            console.log("setupItemSearch called for:", inputElement.id);
            console.log("inputElement:", inputElement);
            console.log("hiddenInputElement:", hiddenInputElement);
            console.log("suggestionsDivElement:", suggestionsDivElement);
            console.log("productsData for autocomplete:", productsData);

            if (inputElement && hiddenInputElement && suggestionsDivElement && productsData.length > 0) {
                setupSearchWithSuggestions(inputElement, hiddenInputElement, suggestionsDivElement, productsData, new Set(productsData));
                console.log("setupSearchWithSuggestions for item initialized.");
            } else if (inputElement) {
                console.warn("Products data not available or empty. Autocomplete for item name disabled.");
            }
        }

        // Fungsi untuk menambah field Nama Barang & Quantity baru
        function addItemField(itemName = '', itemQuantity = '') {
            const itemsContainer = document.getElementById('items-container');
            const itemRow = document.createElement('div');
            itemRow.className = 'flex items-center mb-2 item-row relative'; // Added relative for positioning suggestions

            const uniqueId = `item-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;

            itemRow.innerHTML = `
                <div class="relative flex-grow mr-2">
                    <input type="text" id="${uniqueId}-search" class="item-name-search w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm" placeholder="Cari atau ketik Nama Barang..." value="${itemName}">
                    <input type="hidden" id="${uniqueId}-hidden" class="item-name-hidden" value="${itemName}">
                    <div id="${uniqueId}-suggestions" class="suggestions-list absolute bg-white border border-gray-300 rounded-lg shadow-lg mt-1 w-full z-10 hidden"></div>
                </div>
                <input type="number" class="item-quantity w-24 p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm" placeholder="Qty" min="1" value="${itemQuantity}">
                <button type="button" onclick="removeItemField(this)" class="ml-2 text-red-500 hover:text-red-700"><i class="fas fa-times-circle"></i></button>
            `;
            itemsContainer.appendChild(itemRow);

            const newItemSearchInput = document.getElementById(`${uniqueId}-search`);
            const newItemHiddenInput = document.getElementById(`${uniqueId}-hidden`);
            const newItemSuggestionsDiv = document.getElementById(`${uniqueId}-suggestions`);
            setupItemSearch(newItemSearchInput, newItemHiddenInput, newItemSuggestionsDiv);
        }

        // Fungsi untuk menghapus field Nama Barang & Quantity
        function removeItemField(button) {
            button.closest('.item-row').remove();
        }

        // Membuka modal PO (untuk tambah atau edit)
        async function openPOModal(poId = null) {
            const poModal = document.getElementById('poModal');
            const modalTitle = document.getElementById('modalTitle');
            const poForm = document.getElementById('poForm');

            poForm.reset();
            document.getElementById('poId').value = '';
            document.getElementById('items-container').innerHTML = `
                <label class="block text-gray-700 text-sm font-semibold mb-2">Nama Barang & Quantity</label>
            `;

            document.getElementById('status').value = DEFAULT_STATUS;

            // Clear hidden inputs for No ID
            if (noIdSearchInput) noIdSearchInput.value = '';
            if (selectedNoIdHiddenInput) selectedNoIdHiddenInput.value = '';
            if (noIdSuggestionsDiv) {
                noIdSuggestionsDiv.classList.add('hidden');
                noIdSuggestionsDiv.innerHTML = '';
            }


            if (poId) {
                modalTitle.textContent = 'Edit PO';
                const po = pos.find(p => p.id === poId);
                if (po) {
                    document.getElementById('poId').value = po.id;
                    document.getElementById('orderConfirmation').value = po.orderConfirmation || '';
                    document.getElementById('noPO').value = po.noPO || '';
                    document.getElementById('supplierName').value = po.supplierName || '';

                    // Set value for No ID search input and hidden input
                    if (noIdSearchInput) noIdSearchInput.value = po.selectedNoId || '';
                    if (selectedNoIdHiddenInput) selectedNoIdHiddenInput.value = po.selectedNoId || '';

                    if (po.items && po.items.length > 0) {
                        po.items.forEach(item => addItemField(item.name, item.quantity));
                    } else {
                        addItemField();
                    }

                    document.getElementById('allocation').value = po.allocation || '';
                    document.getElementById('invoice').value = po.invoice || '';
                    document.getElementById('tracking').value = po.tracking || '';
                    document.getElementById('seaForwarder').value = po.seaForwarder || '';
                    document.getElementById('airForwarder').value = po.airForwarder || '';
                    document.getElementById('disrc').value = po.disrc || '';

                    document.getElementById('planDelivery').value = po.planDelivery instanceof Date ? po.planDelivery.toISOString().split('T')[0] : '';
                    document.getElementById('eta').value = po.eta instanceof Date ? po.eta.toISOString().split('T')[0] : '';
                    document.getElementById('actualDelivery').value = po.actualDelivery instanceof Date ? po.actualDelivery.toISOString().split('T')[0] : '';

                    document.getElementById('coo').value = po.coo || '';
                    document.getElementById('hsCode').value = po.hsCode || '';
                    document.getElementById('revisiHS').value = po.revisiHS || '';
                    document.getElementById('note').value = po.note || '';
                    document.getElementById('status').value = po.status || DEFAULT_STATUS;
                }
            } else {
                modalTitle.textContent = 'Tambah PO Baru';
                addItemField();
            }

            poModal.classList.remove('hidden');
            console.log("openPOModal called. Initializing No ID search.");
            setupNoIdSearch(); // Inisialisasi autocomplete untuk No ID
        }

        function closePOModal() {
            const poModal = document.getElementById('poModal');
            if (!poModal) return;
            poModal.classList.add('hidden');
            // Tutup semua daftar autocomplete yang mungkin terbuka saat modal ditutup
            document.querySelectorAll(".suggestions-list").forEach(item => {
                if (item.parentNode) {
                    item.classList.add('hidden');
                    item.innerHTML = '';
                }
            });
        }

        // Menyimpan data PO ke Firestore
        async function savePO() {
            const poId = document.getElementById('poId').value;
            const noPO = document.getElementById('noPO').value;

            if (!noPO) {
                showCustomAlert("No. PO harus diisi.", "error");
                return;
            }

            closePOModal();
            showGlobalLoading();

            const orderConfirmation = document.getElementById('orderConfirmation').value;
            const supplierName = document.getElementById('supplierName').value;
            const selectedNoId = document.getElementById('selectedNoId').value; // Ambil dari hidden input

            const itemsToSave = [];
            document.querySelectorAll('.item-row').forEach(row => {
                const itemName = row.querySelector('.item-name-hidden').value; // Ambil dari hidden input
                const itemQuantity = row.querySelector('.item-quantity').value;
                if (itemName && itemQuantity && parseInt(itemQuantity) > 0) {
                    itemsToSave.push({ name: itemName, quantity: parseInt(itemQuantity) });
                }
            });

            const allocation = document.getElementById('allocation').value;
            const invoice = document.getElementById('invoice').value;
            const tracking = document.getElementById('tracking').value;
            const seaForwarder = document.getElementById('seaForwarder').value;
            const airForwarder = document.getElementById('airForwarder').value;
            const disrc = document.getElementById('disrc').value;

            const planDelivery = document.getElementById('planDelivery').value ? firebase.firestore.Timestamp.fromDate(new Date(document.getElementById('planDelivery').value)) : null;
            const eta = document.getElementById('eta').value ? firebase.firestore.Timestamp.fromDate(new Date(document.getElementById('eta').value)) : null;
            const actualDelivery = document.getElementById('actualDelivery').value ? firebase.firestore.Timestamp.fromDate(new Date(document.getElementById('actualDelivery').value)) : null;

            const coo = document.getElementById('coo').value;
            const hsCode = document.getElementById('hsCode').value;
            const revisiHS = document.getElementById('revisiHS').value;
            const note = document.getElementById('note').value;
            const status = document.getElementById('status').value;

            const poData = {
                orderConfirmation: orderConfirmation,
                noPO: noPO,
                supplierName: supplierName,
                selectedNoId: selectedNoId,
                items: itemsToSave,
                allocation: allocation,
                invoice: invoice,
                tracking: tracking,
                seaForwarder: seaForwarder,
                airForwarder: airForwarder,
                disrc: disrc,
                planDelivery: planDelivery,
                eta: eta,
                actualDelivery: actualDelivery,
                coo: coo,
                hsCode: hsCode,
                revisiHS: revisiHS,
                note: note,
                status: status,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                if (poId) {
                    await dealsCollection.doc(poId).update(poData);
                    showCustomAlert("PO berhasil diperbarui!", "success");
                } else {
                    poData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    poData.createdBy = auth.currentUser.email;
                    await dealsCollection.add(poData);
                    showCustomAlert("PO baru berhasil ditambahkan!", "success");
                }
            } catch (error) {
                console.error("Error saving PO:", error);
                showCustomAlert("Gagal menyimpan PO. Silakan coba lagi.", "error");
            } finally {
                hideGlobalLoading();
            }
        }

        function prepareEditPO(poId) {
            openPOModal(poId);
        }

        let poToDeleteId = null;
        let poToDeleteNo = '';

        function confirmDeletePO(poId, poNo) {
            poToDeleteId = poId;
            poToDeleteNo = poNo;
            document.getElementById('dealToDeleteName').textContent = poNo;
            document.getElementById('deleteModal').classList.remove('hidden');
        }

        async function deletePO() {
            if (!poToDeleteId) return;

            closeDeleteModal();
            showGlobalLoading();

            try {
                await dealsCollection.doc(poToDeleteId).delete();
                showCustomAlert(`PO "${poToDeleteNo}" berhasil dihapus!`, "success");
            } catch (error) {
                console.error("Error deleting PO:", error);
                showCustomAlert("Gagal menghapus PO. Silakan coba lagi.", "error");
            } finally {
                hideGlobalLoading();
            }
        }

        async function updatePOStatus(poId, newStatus) {
            showGlobalLoading();
            try {
                await dealsCollection.doc(poId).update({
                    status: newStatus,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                showCustomAlert(`Status PO berhasil diperbarui menjadi "${newStatus}"!`, "success");
            } catch (error) {
                console.error("Error updating PO status:", error);
                showCustomAlert("Gagal memperbarui status PO. Silakan coba lagi.", "error");
            } finally {
                hideGlobalLoading();
            }
        }

        // Membuka modal detail PO
        function openPODetailModal(poId) {
            const po = pos.find(p => p.id === poId);
            if (!po) {
                showCustomAlert("Detail PO tidak ditemukan.", "error");
                return;
            }

            document.getElementById('poDetailTitle').textContent = po.noPO || 'Detail PO';
            document.getElementById('detailOrderConfirmation').textContent = po.orderConfirmation || '-';
            document.getElementById('detailNoPO').textContent = po.noPO || '-';
            document.getElementById('detailSupplierName').textContent = po.supplierName || '-';
            document.getElementById('detailNoId').textContent = po.selectedNoId || '-';

            const detailItemsList = document.getElementById('detailItemsList');
            detailItemsList.innerHTML = '';
            if (po.items && po.items.length > 0) {
                po.items.forEach(item => {
                    const listItem = document.createElement('li');
                    listItem.textContent = `${item.name} (Qty: ${item.quantity})`;
                    detailItemsList.appendChild(listItem);
                });
            } else {
                const listItem = document.createElement('li');
                listItem.textContent = '-';
                detailItemsList.appendChild(listItem);
            }

            document.getElementById('detailAllocation').textContent = po.allocation || '-';
            document.getElementById('detailInvoice').textContent = po.invoice || '-';
            document.getElementById('detailTracking').textContent = po.tracking || '-';
            document.getElementById('detailSeaForwarder').textContent = po.seaForwarder || '-';
            document.getElementById('detailAirForwarder').textContent = po.airForwarder || '-';
            document.getElementById('detailDisrc').textContent = po.disrc || '-';

            document.getElementById('detailPlanDelivery').textContent = po.planDelivery ? formatDate(po.planDelivery) : '-';
            document.getElementById('detailETA').textContent = po.eta ? formatDate(po.eta) : '-';
            document.getElementById('detailActualDelivery').textContent = po.actualDelivery ? formatDate(po.actualDelivery) : '-';
            document.getElementById('detailStatus').textContent = po.status || '-';

            document.getElementById('detailCOO').textContent = po.coo || '-';
            document.getElementById('detailHSCode').textContent = po.hsCode || '-';
            document.getElementById('detailRevisiHS').textContent = po.revisiHS || '-';
            document.getElementById('detailNote').textContent = po.note || '-';

            document.getElementById('poDetailModal').classList.remove('hidden');
        }

        function closePODetailModal() {
            const poDetailModal = document.getElementById('poDetailModal');
            if (!poDetailModal) return;
            poDetailModal.classList.add('hidden');
        }

        // ==================== FUNGSI SORTABLE ====================

        function initSortable() {
            const pipelineStage = document.getElementById('pos-stage');
            if (!pipelineStage) return;
            console.log("SortableJS is disabled.");
        }

        // ==================== FUNGSI PERMISSIONS ====================

        function applyUserPermissions() {
            try {
                const isAdmin = currentUserRole === 'admin';

                console.log("Applying permissions for Role:", currentUserRole);

                const newPOBtn = document.getElementById('newPOBtn');
                const exportExcelBtn = document.getElementById('exportExcelBtn');
                const searchInput = document.getElementById('searchPOs');
                const openFilterPanelBtn = document.getElementById('openFilterPanelBtn');
                const backButton = document.getElementById('backButton');
                const authButton = document.getElementById('authButton');

                if (newPOBtn) newPOBtn.classList.remove('hidden');
                if (exportExcelBtn) exportExcelBtn.classList.remove('hidden');
                if (backButton) backButton.classList.remove('hidden');
                if (authButton) authButton.classList.remove('hidden');

                if (searchInput) searchInput.classList.remove('hidden');
                if (openFilterPanelBtn) openFilterPanelBtn.classList.remove('hidden');

            } catch (error) {
                console.error("Error in applyUserPermissions:", error);
                showCustomAlert("Gagal menerapkan permissions", "error");
            }
        }

        // ==================== FUNGSI EVENT LISTENERS ====================

        function initEventListeners() {
            console.log("Initializing event listeners...");

            try {
                const poForm = document.getElementById('poForm');
                if (poForm) {
                    poForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                        savePO();
                    });
                }

                const buttons = [
                    { id: 'newPOBtn', func: openPOModal },
                    { id: 'exportExcelBtn', func: exportToExcel },
                    { id: 'backButton', func: goToIndex },
                    { id: 'authButton', func: logout },
                    { id: 'openFilterPanelBtn', func: openFilterPanel }
                ];

                buttons.forEach(btn => {
                    const element = document.getElementById(btn.id);
                    if (element) {
                        element.removeEventListener('click', btn.func);
                        element.addEventListener('click', btn.func);
                        element.addEventListener('click', createRipple);
                        console.log(`Event listener added for ${btn.id}`);
                    }
                });

                const searchInput = document.getElementById('searchPOs');
                if (searchInput) {
                    searchInput.removeEventListener('keyup', filterPOs);
                    searchInput.addEventListener('keyup', filterPOs);
                }
            } catch (error) {
                console.error("Error initializing event listeners:", error);
                showCustomAlert("Gagal memuat beberapa fungsi", "error");
            }
        }

        function createRipple(event) {
            const button = event.currentTarget;
            const circle = document.createElement('span');
            const diameter = Math.max(button.clientWidth, button.clientHeight);
            const radius = diameter / 2;

            circle.style.width = circle.style.height = `${diameter}px`;
            circle.style.left = `${event.clientX - (button.getBoundingClientRect().left + radius)}px`;
            circle.style.top = `${event.clientY - (button.getBoundingClientRect().top + radius)}px`;
            circle.classList.add('ripple');

            const ripple = button.getElementsByClassName('ripple')[0];

            if (ripple) {
                ripple.remove();
            }

            button.appendChild(circle);
        }

        // ==================== FUNGSI LAINNYA ====================

        function filterPOs() {
            try {
                const searchTerm = document.getElementById('searchPOs').value.toLowerCase();
                const supplierFilter = document.getElementById('filterSupplier').value;
                const cooFilter = document.getElementById('filterCOO').value;
                const hsCodeFilter = document.getElementById('filterHSCode').value;
                const statusFilter = document.getElementById('filterStatus').value;

                let basePOs = pos;

                const filteredPOs = basePOs.filter(po => {
                    const matchesSearch =
                        (po.noPO && po.noPO.toLowerCase().includes(searchTerm)) ||
                        (po.supplierName && po.supplierName.toLowerCase().includes(searchTerm)) ||
                        (po.selectedNoId && po.selectedNoId.toLowerCase().includes(searchTerm)) ||
                        (po.items && po.items.some(item => item.name.toLowerCase().includes(searchTerm)));

                    const matchesSupplier =
                        supplierFilter === 'all' ||
                        (po.supplierName && po.supplierName === supplierFilter);

                    const matchesCOO =
                        cooFilter === 'all' ||
                        (po.coo && po.coo === cooFilter);

                    const matchesHSCode =
                        hsCodeFilter === 'all' ||
                        (po.hsCode && po.hsCode === hsCodeFilter);

                    const matchesStatus =
                        statusFilter === 'all' ||
                        (po.status && po.status === statusFilter);

                    return matchesSearch && matchesSupplier && matchesCOO && matchesHSCode && matchesStatus;
                });

                renderFilteredPOs(filteredPOs);
            } catch (error) {
                console.error("Error filtering POs:", error);
            }
        }

        function renderFilteredPOs(filteredPOs) {
            const pipelineStage = document.getElementById('pos-stage');
            if (!pipelineStage) return;

            pipelineStage.innerHTML = '';

            if (filteredPOs.length === 0) {
                pipelineStage.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-search"></i>
                        <p>Tidak ada PO yang sesuai dengan filter.</p>
                    </div>
                `;
                return;
            }

            filteredPOs.forEach((po, index) => {
                const poCard = renderPO(po, index);
                pipelineStage.appendChild(poCard);
                setTimeout(() => {
                    poCard.classList.add('show');
                }, 50 * index);
            });
        }

        function logout() {
            if (unsubscribeFromPOs) {
                unsubscribeFromPOs();
                unsubscribeFromPOs = null;
            }
            auth.signOut()
                .then(() => {
                    console.log("User logged out successfully");
                    pos = [];
                    window.location.href = 'login.html';
                })
                .catch((error) => {
                    console.error("Error logging out:", error);
                    showCustomAlert("Gagal logout. Silakan coba lagi.", "error");
                });
        }

        function goToIndex() {
            window.location.href = 'index.html';
        }

        function openFilterPanel() {
            const filterPanel = document.getElementById('filterPanel');
            if (!filterPanel) {
                console.error("Elemen panel filter tidak ditemukan.");
                showCustomAlert("Gagal membuka filter: Elemen tidak lengkap.", "error");
                return;
            }

            populateFilterDropdowns();

            filterPanel.classList.remove('hidden');
        }

        function closeFilterPanel() {
            const filterPanel = document.getElementById('filterPanel');
            if (!filterPanel) {
                console.error("Elemen filterPanelContent tidak ditemukan saat menutup modal.");
                return;
            }
            filterPanel.classList.add('hidden');
        }

        function applyFiltersAndClosePanel() {
            filterPOs();
            closeFilterPanel();
        }

        function resetFilters() {
            document.getElementById('filterSupplier').value = 'all';
            document.getElementById('filterCOO').value = 'all';
            document.getElementById('filterHSCode').value = 'all';
            document.getElementById('filterStatus').value = 'all';
            document.getElementById('searchPOs').value = '';
            filterPOs();
        }

        function closeDeleteModal() {
            const deleteModal = document.getElementById('deleteModal');
            if (!deleteModal) return;
            deleteModal.classList.add('hidden');
        }

        // ==================== FUNGSI EXPORT TO EXCEL ====================
        function exportToExcel() {
            showGlobalLoading();
            try {
                const data = [];
                const headers = [
                    "No. Urut", "Order Confirmation", "No. PO", "Nama Supplier", "No ID", "Nama Barang & Quantity",
                    "Allocation", "Invoice", "Tracking", "Sea Forwarder",
                    "Air Forwarder", "DISRC", "Plan Delivery", "ETA", "Actual Delivery",
                    "COO", "HS Code", "Revisi HS", "Note", "Status", "Dibuat Oleh", "Tanggal Dibuat"
                ];
                data.push(headers);

                const currentPOs = pos.filter(po => {
                    const searchTerm = document.getElementById('searchPOs').value.toLowerCase();
                    const supplierFilter = document.getElementById('filterSupplier').value;
                    const cooFilter = document.getElementById('filterCOO').value;
                    const hsCodeFilter = document.getElementById('filterHSCode').value;
                    const statusFilter = document.getElementById('filterStatus').value;

                    const matchesSearch =
                        (po.noPO && po.noPO.toLowerCase().includes(searchTerm)) ||
                        (po.supplierName && po.supplierName.toLowerCase().includes(searchTerm)) ||
                        (po.selectedNoId && po.selectedNoId.toLowerCase().includes(searchTerm)) ||
                        (po.items && po.items.some(item => item.name.toLowerCase().includes(searchTerm)));

                    const matchesSupplier =
                        supplierFilter === 'all' ||
                        (po.supplierName && po.supplierName === supplierFilter);

                    const matchesCOO =
                        cooFilter === 'all' ||
                        (po.coo && po.coo === cooFilter);

                    const matchesHSCode =
                        hsCodeFilter === 'all' ||
                        (po.hsCode && po.hsCode === hsCodeFilter);

                    const matchesStatus =
                        statusFilter === 'all' ||
                        (po.status && po.status === statusFilter);

                    return matchesSearch && matchesSupplier && matchesCOO && matchesHSCode && matchesStatus;
                });

                currentPOs.forEach((po, index) => {
                    const itemsString = po.items && po.items.length > 0
                        ? po.items.map(item => `${item.name} (Qty: ${item.quantity})`).join(', ')
                        : '';

                    const row = [
                        index + 1,
                        po.orderConfirmation || '',
                        po.noPO || '',
                        po.supplierName || '',
                        po.selectedNoId || '',
                        itemsString,
                        po.allocation || '',
                        po.invoice || '',
                        po.tracking || '',
                        po.seaForwarder || '',
                        po.airForwarder || '',
                        po.disrc || '',
                        po.planDelivery ? formatDate(po.planDelivery) : '',
                        po.eta ? formatDate(po.eta) : '',
                        po.actualDelivery ? formatDate(po.actualDelivery) : '',
                        po.coo || '',
                        po.hsCode || '',
                        po.revisiHS || '',
                        po.note || '',
                        po.status ? po.status.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : '',
                        po.createdBy || '',
                        po.createdAt ? formatDateTime(po.createdAt) : ''
                    ];
                    data.push(row);
                });

                const ws = XLSX.utils.aoa_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Purchase Orders");

                const fileName = `Purchase_Orders_${new Date().toISOString().slice(0,10)}.xlsx`;
                XLSX.writeFile(wb, fileName);
                showCustomAlert("Data PO berhasil diekspor ke Excel!", "success");

            } catch (error) {
                console.error("Error exporting to Excel:", error);
                showCustomAlert("Gagal mengekspor data ke Excel.", "error");
            } finally {
                hideGlobalLoading();
            }
        }

        // ==================== INISIALISASI ====================

        document.addEventListener('DOMContentLoaded', function() {
            // Inisialisasi variabel DOM global
            noIdSearchInput = document.getElementById('noIdSearch');
            selectedNoIdHiddenInput = document.getElementById('selectedNoId');
            noIdSuggestionsDiv = document.getElementById('noIdSuggestions');

            console.log("DOMContentLoaded fired. Global DOM elements initialized.");
            console.log("Global noIdSearchInput:", noIdSearchInput);

            initSortable();
        });
    </script>
</body>
</html>
