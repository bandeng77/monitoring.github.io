<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoring Perubahan Accurate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <!-- Library for Export Excel -->
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <!-- Google API Loader (Removed as upload document is removed) -->
    <!-- <script src="https://apis.google.com/js/api.js"></script> -->
    <!-- <script src="https://apis.google.com/js/platform.js" async defer></script> -->

    <style>
        /* New Color Palette */
        :root {
            --primary-blue: #3b82f6; /* Primary blue */
            --primary-dark-blue: #2563eb; /* Dark blue */
            --accent-teal: #14b8a6; /* Accent teal */
            --accent-green: #22c55e; /* Accent green */
            --text-dark: #1e293b; /* Dark text */
            --text-medium: #475569; /* Medium text */
            --text-light: #64748b; /* Light text */
            --bg-light: #f8fafc; /* Light background */
            --bg-medium: #e2e8f0; /* Medium background */
            --bg-soft: #f0f2f5; /* Very soft background */
            --border-color: #cbd5e1; /* Border color */
            --shadow-light: rgba(0, 0, 0, 0.05);
            --shadow-medium: rgba(0, 0, 0, 0.1);
            --shadow-strong: rgba(0, 0, 0, 0.2);
        }

        html, body {
            height: 100%; /* Important for fullscreen modal */
            width: 100%; /* Important for fullscreen modal */
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-soft);
            color: var(--text-medium);
            line-height: 1.6;
        }

        /* Header Styling */
        .header {
            background-color: #ffffff;
            border-radius: 1rem; /* More rounded */
            box-shadow: 0 8px 20px var(--shadow-light); /* Softer shadow */
            padding: 1.75rem 2rem;
            position: relative; /* For logout button placement */
        }
        .header h1 {
            color: var(--text-dark);
            font-size: 2.25rem; /* Larger */
            font-weight: 800;
        }
        .header .logout-btn-container {
            position: absolute;
            top: 1.75rem;
            right: 2rem;
        }
        .header button {
            font-weight: 600;
            border-radius: 0.65rem;
            padding: 0.75rem 1.25rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .header button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px var(--shadow-medium);
        }
        .header button.bg-blue-600 { background-color: var(--primary-blue); }
        .header button.bg-blue-600:hover { background-color: var(--primary-dark-blue); }
        .header button.bg-green-500 { background-color: var(--accent-green); } /* Using accent-green */
        .header button.bg-green-500:hover { background-color: #16a34a; } /* Darker green */
        .header button.bg-red-500 { background-color: #ef4444; }
        .header button.bg-red-500:hover { background-color: #dc2626; }
        .header button.bg-gray-500 { background-color: #6b7280; }
        .header button.bg-gray-500:hover { background-color: #4b5563; }
        .header button.bg-gray-200 { background-color: var(--bg-medium); color: var(--text-dark); }
        .header button.bg-gray-200:hover { background-color: var(--border-color); }

        /* Ripple Effect */
        .ripple {
            position: absolute;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.7);
            animation: ripple-animation 0.6s linear forwards;
            transform: scale(0);
            pointer-events: none;
        }
        @keyframes ripple-animation {
            from { transform: scale(0); opacity: 1; }
            to { transform: scale(4); opacity: 0; }
        }

        /* Input & Select Styling */
        input[type="text"], input[type="date"], input[type="number"], select, textarea {
            border: 1px solid var(--border-color);
            border-radius: 0.65rem;
            padding: 0.75rem 1rem;
            font-size: 0.95rem;
            color: var(--text-dark);
            transition: all 0.2s ease;
        }
        input:focus, select:focus, textarea:focus {
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
            outline: none;
        }

        /* Pipeline Stage */
        .pipeline-stage {
            min-height: 480px;
            max-height: 600px;
            transition: all 0.4s ease-out;
            border-radius: 1rem; /* More rounded */
            overflow: hidden;
            display: flex;
            flex-direction: column;
            background-color: #ffffff;
            box-shadow: 0 12px 30px var(--shadow-light); /* Deeper shadow */
            box-sizing: border-box;
        }
        .pipeline-stage-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--bg-medium);
            background-image: linear-gradient(to right, var(--primary-blue), var(--accent-teal)); /* Animation: Gradient on header */
            color: white; /* Animation: Text color for gradient contrast */
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); /* Animation: Shadow on header */
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
        }
        .pipeline-stage-header h3 {
            font-size: 1.2rem; /* Larger */
            font-weight: 700;
            color: white; /* Animation: Ensure title text remains white */
            flex-shrink: 0;
            text-align: center;
            width: 100%;
        }
        .pipeline-stage-content {
            flex-grow: 1;
            padding: 1.25rem; /* Larger padding */
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            min-height: 100px;
            height: 100%;
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-content: flex-start;
            background-image: linear-gradient(to bottom right, var(--bg-light), var(--bg-soft)); /* Animation: Soft gradient on content */
        }

        /* Deal Card */
        .deal-card {
            transition: transform 0.4s ease-out, opacity 0.4s ease-out, box-shadow 0.3s ease-out; /* Animation: Smoother transition */
            cursor: grab;
            position: relative;
            background-color: #ffffff;
            border: 1px solid var(--bg-medium);
            border-radius: 0.85rem; /* More rounded */
            padding: 1.1rem; /* Larger padding */
            margin-bottom: 0;
            box-shadow: 0 6px 15px var(--shadow-light); /* Clearer shadow */
            font-size: 0.875rem;
            width: calc(25% - 0.75rem); /* Adjusted for 4 columns */
            min-width: 220px; /* Slightly smaller min-width to fit 4 columns */
            box-sizing: border-box;
            opacity: 0; /* Animation: Start invisible */
            transform: translateY(20px); /* Animation: Start slightly below */
            display: flex; /* Using flexbox for internal layout */
            flex-direction: column;
            justify-content: space-between;
        }
        .deal-card.show {
            opacity: 1;
            transform: translateY(0);
        }
        .deal-card:hover {
            transform: translateY(-7px) scale(1.02); /* Animation: More dramatic hover effect (lift and enlarge) */
            box-shadow: 0 15px 35px var(--shadow-medium); /* Stronger hover shadow */
        }
        .deal-card:active {
            cursor: grabbing;
        }
        .deal-card h3 {
            font-size: 1.05rem; /* Slightly larger font size */
            font-weight: 700;
            color: var(--text-dark);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: calc(100% - 60px);
            margin-bottom: 0.5rem; /* Space below title */
        }
        .deal-details {
            flex-grow: 1; /* Allow details to fill space */
            margin-bottom: 1rem; /* Space below details */
        }
        .deal-details p {
            font-size: 0.85rem; /* Slightly larger font size */
            margin-top: 0.3rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--text-medium);
            display: flex;
            align-items: center;
        }
        .deal-details p i {
            font-size: 0.8rem;
            color: var(--text-light);
            margin-right: 0.5rem; /* Space between icon and text */
            width: 1rem; /* Fixed width for icon */
            text-align: center;
        }
        .deal-actions {
            display: flex;
            justify-content: flex-end; /* Action buttons to the right */
            gap: 0.5rem; /* Space between action buttons */
        }
        .deal-actions button {
            padding: 0.3rem 0.6rem;
            font-size: 0.8rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease-out, transform 0.2s ease-out;
            color: var(--text-medium); /* Default icon color */
            background-color: var(--bg-light); /* Action button background */
            border: 1px solid var(--border-color);
        }
        .deal-actions button:hover {
            transform: translateY(-2px);
            background-color: var(--bg-medium);
        }
        .deal-actions button.text-blue-600:hover { color: var(--primary-blue); }
        .deal-actions button.text-green-600:hover { color: #22c55e; } /* Using accent-green */
        .deal-actions button.text-red-600:hover { color: #ef4444; }

        .deal-footer {
            margin-top: 1rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--bg-medium);
            display: flex; /* Add this for flexbox */
            justify-content: space-between; /* To place status on the left and actions on the right */
            align-items: center; /* To align vertically */
        }

        /* Scrollbar */
        .pipeline-stage-content::-webkit-scrollbar {
            width: 8px; /* Animation: Scrollbar width */
        }
        .pipeline-stage-content::-webkit-scrollbar-track {
            background: var(--bg-soft); /* Animation: Track color */
            border-radius: 10px;
        }
        .pipeline-stage-content::-webkit-scrollbar-thumb {
            background: var(--primary-blue); /* Animation: Thumb color */
            border-radius: 10px;
            border: 2px solid var(--bg-soft); /* Animation: Border for better appearance */
        }
        .pipeline-stage-content::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark-blue); /* Animation: Thumb color on hover */
        }

        /* Modals */
        /* Remove transition property to remove animation */
        .modal-content-enter-active, .modal-content-leave-active {
            /* transition: opacity 0.15s cubic-bezier(0.25, 0.8, 0.25, 1), transform 0.15s cubic-bezier(0.25, 0.8, 0.25, 1); */
        }
        #poModalContent, #poDetailModalContent, #deleteModalContent, #filterPanelContent, #successAlertModalContent {
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 20px 50px var(--shadow-strong);
            padding: 2.5rem;
        }

        /* Fullscreen PO Modal */
        #poModalContent {
            width: 98vw; /* Almost fullscreen */
            height: 98vh; /* Almost fullscreen */
            max-width: 98vw; /* Ensure it doesn't exceed viewport */
            max-height: 98vh; /* Ensure it doesn't exceed viewport */
            border-radius: 1rem;
            box-shadow: 0 20px 50px var(--shadow-strong);
            display: flex;
            flex-direction: column;
            padding: 1rem; /* Adjust padding to not be too large */
        }
        #poModalContent .po-form-container {
            flex-grow: 1;
            overflow-y: auto; /* Scrollbar only inside the form if content is too long */
            padding-right: 0.5rem; /* Space for scrollbar */
        }
        #poModalContent .po-form-container::-webkit-scrollbar {
            width: 8px;
        }
        #poModalContent .po-form-container::-webkit-scrollbar-track {
            background: var(--bg-soft);
            border-radius: 10px;
        }
        #poModalContent .po-form-container::-webkit-scrollbar-thumb {
            background: var(--primary-blue);
            border-radius: 10px;
            border: 2px solid var(--bg-soft);
        }
        #poModalContent .po-form-container::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark-blue);
        }


        #poModalContent h2, #poDetailModalContent h2, #deleteModalContent h2, #filterPanelContent h2, #successAlertModalContent h2 {
            color: var(--text-dark);
            font-weight: 800;
            font-size: 1.75rem; /* Smaller */
            margin-bottom: 1rem; /* Smaller */
        }
        #poForm label {
            color: var(--text-dark);
            font-weight: 600;
            font-size: 0.75rem; /* Smaller */
            margin-bottom: 0.25rem; /* Smaller */
        }
        #poForm input, #poForm select, #poForm textarea {
            border-radius: 0.5rem;
            padding: 0.5rem 0.75rem; /* Smaller */
            font-size: 0.85rem; /* Smaller */
        }
        #poForm textarea { height: 80px; } /* Slightly shorter */

        /* Detail Grid */
        #poDetailModalContent .detail-grid {
            display: grid; /* Ensure this is a grid */
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); /* Tighter */
            gap: 1rem;
        }
        /* Modification for 3 columns on PO details */
        @media (min-width: 768px) { /* For tablets and desktops */
            #poDetailModalContent .detail-grid {
                grid-template-columns: repeat(3, 1fr); /* 3 columns */
            }
        }
        /* Modification for 4 columns on PO details */
        @media (min-width: 1024px) { /* For desktops */
            #poDetailModalContent .detail-grid {
                grid-template-columns: repeat(4, 1fr); /* 4 columns */
            }
        }
        #poDetailModalContent .detail-item p { /* Combine these two rules */
            color: #000000; /* Set to black */
            font-size: 0.9rem; /* Desired font size */
            font-weight: 500;
        }
        #poDetailModalContent .detail-item p:first-child {
            color: #000000; /* Set to black for labels as well */
            font-weight: 600; /* Make labels slightly bolder */
        }
        #poDetailModalContent .detail-item ul,
        #poDetailModalContent .detail-item li {
            font-size: 0.9rem; /* Match other detail font sizes */
            color: #000000; /* Set to black */
            font-weight: 500; /* Match other detail text weight */
        }

        /* Additional rules for dynamic content within the detail modal */
        #detailDocumentChecklist p,
        #detailDocumentChecklist span,
        #detailItemsList p,
        #detailItemsList span {
            color: #000000 !important; /* Ensure black for these sections, use !important if needed to override Tailwind */
        }

        /* Loading Spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--primary-blue);
            border-radius: 50%;
            width: 40px; /* Larger */
            height: 40px;
            animation: spin 1s linear infinite;
        }
        /* Global Loading Overlay */
        #global-loading-overlay.show {
            display: flex; /* Ensure overlay is visible when 'show' */
        }

        /* Empty State */
        .empty-state {
            color: var(--text-light);
            text-align: center;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
        }
        .empty-state i {
            font-size: 3rem;
            color: var(--bg-medium);
            margin-bottom: 1rem;
        }
        .empty-state p {
            font-size: 1rem;
            color: var(--text-light);
        }

        /* PO Card Number */
        .po-card-number {
            position: absolute;
            top: 0.6rem;
            right: 0.6rem; /* Move to top right */
            left: unset; /* Ensure no conflicting left property */
            font-size: 0.8rem; /* Slightly larger */
            font-weight: 700;
            color: var(--text-dark); /* Darker text color */
            background-color: var(--bg-medium);
            padding: 0.15rem 0.5rem;
            border-radius: 0.35rem;
            z-index: 10; /* Ensure on top of other content */
        }

        /* Status Colors - Adjusted to match button colors */
        .status-on-order { background-color: var(--primary-blue); color: white; } /* Primary blue */
        .status-waiting { background-color: #facc15; color: #333; } /* Yellow */
        .status-picked-up { background-color: var(--accent-green); color: white; } /* Accent green */
        .status-on-delivery { background-color: #a78bfa; color: white; } /* Purple */
        .status-delivered { background-color: #10b981; color: white; } /* Emerald green */
        .status-partial-delivered { background-color: #fbbf24; color: #333; } /* Amber */
        .status-delayed { background-color: #ef4444; color: white; } /* Red */
        .status-on-hold { background-color: #9ca3af; color: white; } /* Gray */

        /* Styling for status dropdown in deal-card */
        .status-dropdown {
            appearance: none; /* Remove default browser styling */
            background-color: var(--primary-blue);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            min-width: 100px; /* To prevent it from being too small */
            max-width: 120px;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            position: relative;
            padding-right: 1.5rem; /* Space for arrow icon */
        }
        .status-dropdown:hover {
            background-color: var(--primary-blue);
        }
        .status-dropdown:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        /* Custom arrow for dropdown */
        .status-dropdown::after {
            content: '\f078'; /* FontAwesome chevron-down icon */
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: var(--text-medium);
        }

        /* Media Queries for responsiveness */
        @media (max-width: 1280px) { /* For large laptop screens, 3 columns */
            .deal-card {
                width: calc(33.333% - 0.666rem);
                min-width: 280px;
            }
        }

        @media (max-width: 1024px) { /* For tablets, 2 columns */
            .deal-card {
                width: calc(50% - 0.5rem);
                min-width: 280px;
            }
            /* Adjust main PO form grid columns for tablets */
            #poModalContent .grid.grid-cols-1.sm\:grid-cols-2.md\:grid-cols-3.lg\:grid-cols-4 > div {
                grid-column: span 1; /* Default 1 column */
            }
            @media (min-width: 640px) { /* sm breakpoint */
                #poModalContent .grid.grid-cols-1.sm\:grid-cols-2.md\:grid-cols-3.lg\:grid-cols-4 > div {
                    grid-column: span 1; /* 2 columns */
                }
            }
            @media (min-width: 768px) { /* md breakpoint */
                #poModalContent .grid.grid-cols-1.sm\:grid-cols-2.md\:grid-cols-3.lg\:grid-cols-4 > div {
                    grid-column: span 1; /* 3 columns */
                }
            }
        }

        @media (max-width: 768px) { /* For mobile, 1 column */
            .deal-card {
                width: 100%;
                min-width: unset;
            }
            .max-w-7xl {
                padding-left: 1rem;
                padding-right: 1rem;
            }
            .header {
                flex-direction: column;
                align-items: flex-start;
                padding: 1.25rem 1.5rem;
            }
            .header h1 {
                font-size: 1.75rem;
            }
            .header .logout-btn-container {
                position: static; /* Revert to normal position on mobile */
                margin-top: 1rem;
                width: 100%;
            }
            .header > div:last-child { /* This is the div containing buttons below the title */
                margin-top: 1rem;
                width: 100%;
                flex-direction: column;
                align-items: stretch;
                gap: 0.75rem;
            }
            .header button {
                width: 100%;
                justify-content: center;
                padding: 0.65rem 1rem;
                font-size: 0.9rem;
            }
            .header .flex-col.sm\:flex-row {
                flex-direction: column;
            }
            .header .sm\:w-1\/2 {
                width: 100%;
            }
            #poModalContent {
                padding: 1rem; /* Smaller padding for mobile */
            }
            #poModalContent h2 {
                font-size: 1.5rem;
            }
            /* Adjust main PO form grid columns for mobile */
            #poModalContent .grid.grid-cols-1.sm\:grid-cols-2.md\:grid-cols-3.lg\:grid-cols-4 > div {
                grid-column: span 1; /* 1 column */
            }
        }

        /* Styling for search dropdown */
        .autocomplete-items {
            position: absolute;
            border: 1px solid #d4d4d4;
            border-bottom: none;
            border-top: none;
            z-index: 99;
            /*position the autocomplete items to be the same width as the container:*/
            top: 100%;
            left: 0;
            right: 0;
            max-height: 200px; /* Limit dropdown height */
            overflow-y: auto; /* Add scroll if too many items */
            background-color: #fff; /* Ensure white background */
        }

        .autocomplete-items div {
            padding: 10px;
            cursor: pointer;
            background-color: #fff;
            border-bottom: 1px solid #d4d4d4;
        }

        .autocomplete-items div:hover {
            /*when hovering an item:*/
            background-color: #e9e9e9;
        }

        .autocomplete-active {
            /*when navigating through the items using the arrow keys:*/
            background-color: DodgerBlue !important;
            color: #ffffff;
        }

        /* Custom styles for item rows */
        .item-row-container {
            display: flex;
            flex-direction: column;
            gap: 0.75rem; /* Space between item rows, tighter */
            margin-top: 1rem; /* Add top margin to prevent being too close */
            padding-top: 1rem; /* Add top padding */
            border-top: 1px solid var(--border-color); /* Add separator line */
        }

        .item-row {
            display: grid;
            /* Default for mobile: 1 column */
            grid-template-columns: 1fr;
            gap: 0.4rem; /* Space between inputs in a row, tighter */
            align-items: end; /* Align items at the bottom */
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 0.6rem; /* Smaller */
            background-color: var(--bg-light);
        }

        /* For larger screens, adjust item-row columns */
        @media (min-width: 640px) { /* sm breakpoint */
            .item-row {
                /* PID (1.5fr), Description (3fr), Qty (0.8fr), COO (1.2fr), HS Code (1.5fr), Revised HS Code (1.5fr), Actions (0.5fr) */
                grid-template-columns: 1.5fr 3fr 0.8fr 1.2fr 1.5fr 1.5fr 0.5fr;
            }
        }
        @media (min-width: 1024px) { /* lg breakpoint */
            .item-row {
                /* PID (1.5fr), Description (3fr), Qty (0.8fr), COO (1.2fr), HS Code (1.5fr), Revised HS Code (1.5fr), Actions (0.5fr) */
                grid-template-columns: 1.5fr 3fr 0.8fr 1.2fr 1.5fr 1.5fr 0.5fr;
            }
        }


        .item-row > div {
            display: flex;
            flex-direction: column;
        }

        .item-row .item-action-buttons {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 0.5rem;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <div class="max-w-7xl mx-auto px-4 py-8">
        <!-- Header -->
        <header class="mb-8 bg-white p-6 rounded-lg shadow-md header">
            <div class="flex justify-between items-start">
                <div>
                    <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-900">Monitoring Perubahan Accurate <i class="fas fa-box-open text-blue-600 ml-2"></i></h1>
                </div>
                <div class="logout-btn-container">
                    <button id="authButton" onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg shadow-md transition duration-200 ease-in-out transform hover:scale-105 flex items-center text-sm">
                        <i class="fas fa-sign-out-alt mr-2"></i> Logout
                    </button>
                </div>
            </div>

            <!-- Buttons below title -->
            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4 mt-4">
                <button id="newPOBtn" onclick="openPOModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow-md transition duration-200 ease-in-out transform hover:scale-105 flex items-center text-sm">
                    <i class="fas fa-plus-circle mr-2"></i> New
                </button>

                <!-- Removed Upload Dokumen Button -->
                <!--
                <button id="documentUploadBtn" onclick="openDocumentUploadModal()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg shadow-md transition duration-200 ease-in-out transform hover:scale-105 flex items-center text-sm">
                    <i class="fas fa-upload mr-2"></i> Upload Dokumen
                </button>
                -->

                <button id="exportExcelBtn" onclick="exportToExcel()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg shadow-md transition duration-200 ease-in-out transform hover:scale-105 flex items-center text-sm">
                    <i class="fas fa-file-excel mr-2"></i> Export Excel
                </button>

                <button id="backButton" onclick="goToIndex()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg shadow-md transition duration-200 ease-in-out transform hover:scale-105 flex items-center text-sm">
                    <i class="fas fa-arrow-left mr-2"></i> Back
                </button>
            </div>

            <!-- Combined Filter Section -->
            <div class="mt-6 flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4 items-center">
                <input type="text" id="searchPOs" onkeyup="filterPOs()" placeholder="Search by document number, description..." class="w-full sm:w-1/2 p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">

                <button id="openFilterPanelBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg shadow-md transition duration-200 ease-in-out transform hover:scale-105 flex items-center text-sm">
                    <i class="fas fa-filter mr-2"></i> Filter
                </button>
            </div>
        </header>

        <!-- Pipeline Visualization -->
        <div class="grid grid-cols-1 gap-6 mb-10">
            <div class="pipeline-stage stage-main-pipeline">
                <div class="pipeline-stage-header">
                    <h3>Monitoring List</h3>
                </div>
                <div id="pos-stage" class="pipeline-stage-content">
                    <!-- POs will be displayed here -->
                    <div id="loading-spinner" class="flex justify-center items-center w-full h-full hidden">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add/Edit PO Modal -->
        <div id="poModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
            <div class="bg-white rounded-none p-8 w-full h-full shadow-2xl modal-content-enter" id="poModalContent">
                <h2 class="text-xl sm:text-2xl font-bold mb-4 text-gray-900" id="modalTitle">Add New Perubahan</h2>
                <form id="poForm" class="po-form-container">
                    <input type="hidden" id="poId">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-3 gap-y-2"> <!-- Changed to 2 columns -->
                        <!-- Column 1 -->
                        <div>
                            <div class="mb-2">
                                <label class="block text-gray-700 text-sm font-semibold mb-1" for="documentType">Tipe Dokumen <span class="text-red-500">*</span></label>
                                <input type="text" id="documentType" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm" required>
                            </div>
                            <div class="mb-2">
                                <label class="block text-gray-700 text-sm font-semibold mb-1" for="documentNumber">Nomor Dokumen <span class="text-red-500">*</span></label>
                                <input type="text" id="documentNumber" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm" required>
                            </div>
                            <div class="mb-2">
                                <label class="block text-gray-700 text-sm font-semibold mb-1" for="documentDate">Tanggal Dokumen</label>
                                <input type="date" id="documentDate" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                            </div>
                            <div class="mb-2">
                                <label class="block text-gray-700 text-sm font-semibold mb-1" for="description">Deskripsi</label>
                                <textarea id="description" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm" rows="4" placeholder="Deskripsi dokumen..."></textarea>
                            </div>
                        </div>
                        <!-- Column 2 -->
                        <div>
                            <div class="mb-2">
                                <label class="block text-gray-700 text-sm font-semibold mb-1" for="initialPriceValue">Nilai Harga Awal Perubahan</label>
                                <input type="text" id="initialPriceValue" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm" inputmode="numeric">
                            </div>
                            <div class="mb-2">
                                <label class="block text-gray-700 text-sm font-semibold mb-1" for="changeDate">Tanggal Perubahan</label>
                                <input type="date" id="changeDate" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                            </div>
                            <div class="mb-2">
                                <label class="block text-gray-700 text-sm font-semibold mb-1" for="changeType">Tipe Perubahan</label>
                                <input type="text" id="changeType" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                            </div>
                            <div class="mb-2">
                                <label class="block text-gray-700 text-sm font-semibold mb-1" for="changeDescription">Deskripsi Perubahan</label>
                                <textarea id="changeDescription" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm" rows="4" placeholder="Deskripsi perubahan..."></textarea>
                            </div>
                            <div class="mb-2">
                                <label class="block text-gray-700 text-sm font-semibold mb-1" for="changedPriceValue">Perubahan Nilai Harga</label>
                                <input type="text" id="changedPriceValue" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm" inputmode="numeric">
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-end space-x-3 mt-4">
                        <button type="button" onclick="closePOModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800 font-medium rounded-lg transition duration-200 text-sm">
                            Cancel
                        </button>
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow-md font-medium transition duration-200 ease-in-out transform hover:scale-105 text-sm">
                            Save Perubahan
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- PO Detail Modal -->
        <div id="poDetailModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
            <div class="bg-white rounded-xl p-8 w-full max-w-5xl shadow-2xl modal-content-enter overflow-y-auto" id="poDetailModalContent">
                <h2 class="text-xl sm:text-2xl font-bold mb-6 text-gray-900" id="poDetailTitle">Detail Perubahan</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Left Column: Main PO Details -->
                    <div>
                        <h3 class="text-lg font-bold text-gray-900 mb-4">Informasi Dokumen</h3>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <p class="font-semibold">Tipe Dokumen:</p>
                                <p id="detailDocumentType"></p>
                            </div>
                            <div class="detail-item">
                                <p class="font-semibold">Nomor Dokumen:</p>
                                <p id="detailDocumentNumber"></p>
                            </div>
                            <div class="detail-item">
                                <p class="font-semibold">Tanggal Dokumen:</p>
                                <p id="detailDocumentDate"></p>
                            </div>
                            <div class="detail-item col-span-full">
                                <p class="font-semibold">Deskripsi:</p>
                                <p id="detailDescription"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Document Checklist -->
                    <div>
                        <h3 class="text-lg font-bold text-gray-900 mb-4">Informasi Perubahan</h3>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <p class="font-semibold">Nilai Harga Awal Perubahan:</p>
                                <p id="detailInitialPriceValue"></p>
                            </div>
                            <div class="detail-item">
                                <p class="font-semibold">Tanggal Perubahan:</p>
                                <p id="detailChangeDate"></p>
                            </div>
                            <div class="detail-item">
                                <p class="font-semibold">Tipe Perubahan:</p>
                                <p id="detailChangeType"></p>
                            </div>
                            <div class="detail-item col-span-full">
                                <p class="font-semibold">Deskripsi Perubahan:</p>
                                <p id="detailChangeDescription"></p>
                            </div>
                            <div class="detail-item">
                                <p class="font-semibold">Perubahan Nilai Harga:</p>
                                <p id="detailChangedPriceValue"></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Document Upload Links Section (Removed as upload document is removed) -->
                <!--
                <div class="detail-item col-span-full border-t pt-4 mt-4 border-gray-200">
                    <h3 class="text-lg font-bold text-gray-900 mb-2">Dokumen Terkait</h3>
                    <div id="detailDocumentLinks" class="flex flex-col gap-2">
                        <p><span class="font-semibold">PDF Dokumen Sebelum Perubahan:</span> <a id="linkPdfBefore" href="#" target="_blank" class="text-blue-600 hover:underline">Lihat Dokumen</a></p>
                        <p><span class="font-semibold">PDF Dokumen Setelah Perubahan:</span> <a id="linkPdfAfter" href="#" target="_blank" class="text-blue-600 hover:underline">Lihat Dokumen</a></p>
                    </div>
                </div>
                -->

                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="closePODetailModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800 font-medium rounded-lg transition duration-200 text-sm">
                        Close
                    </button>
                </div>
            </div>
        </div>

        <!-- Delete Confirmation Modal -->
        <div id="deleteModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
            <div class="bg-white rounded-xl p-8 w-full max-w-sm shadow-2xl modal-content-enter" id="deleteModalContent">
                <h2 class="text-xl font-bold mb-4 text-gray-900">Delete Confirmation</h2>
                <p class="text-gray-700 mb-6 text-sm">Are you sure you want to delete "<span id="dealToDeleteName" class="font-semibold"></span>"? This action cannot be undone.</p>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeDeleteModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800 font-medium rounded-lg transition duration-200 text-sm">
                        Cancel
                    </button>
                    <button type="button" id="confirmDeleteBtn" onclick="deletePO()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg shadow-md font-medium transition duration-200 ease-in-out transform hover:scale-105 text-sm">
                        Delete
                    </button>
                </div>
            </div>
        </div>

        <!-- Filter Panel Modal -->
        <div id="filterPanel" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
            <div class="bg-white rounded-xl p-8 w-full max-w-2xl shadow-2xl modal-content-enter" id="filterPanelContent">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-900 flex items-center"><i class="fas fa-filter mr-3 text-gray-500"></i> Filter Perubahan</h2>
                    <button onclick="closeFilterPanel()" class="text-gray-500 hover:text-gray-700 transition duration-200">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Filter: Tipe Dokumen -->
                    <div>
                        <label class="block text-gray-700 text-sm font-semibold mb-2" for="filterDocumentType">Tipe Dokumen</label>
                        <select id="filterDocumentType" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                            <option value="all">Semua Tipe Dokumen</option>
                            <!-- Options will be dynamically populated by JavaScript -->
                        </select>
                    </div>
                    <!-- Filter: Tipe Perubahan -->
                    <div>
                        <label class="block text-gray-700 text-sm font-semibold mb-2" for="filterChangeType">Tipe Perubahan</label>
                        <select id="filterChangeType" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                            <option value="all">Semua Tipe Perubahan</option>
                            <option value="Penambahan">Penambahan</option>
                            <option value="Pengurangan">Pengurangan</option>
                            <option value="Koreksi">Koreksi</option>
                        </select>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="resetFilters()" class="px-4 py-2 text-gray-600 hover:text-gray-800 font-medium rounded-lg transition duration-200 text-sm">
                        Reset Filters
                    </button>
                    <button type="button" onclick="applyFiltersAndClosePanel()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow-md font-medium transition duration-200 ease-in-out transform hover:scale-105 text-sm">
                        Apply Filters
                    </button>
                </div>
            </div>
        </div>

        <!-- Success Alert Modal (NEW) -->
        <div id="successAlertModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
            <div class="bg-white rounded-xl p-8 w-full max-w-sm text-center shadow-2xl modal-content-enter" id="successAlertModalContent">
                <div class="text-green-500 text-6xl mb-4">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h2 class="text-2xl font-bold mb-4 text-gray-900">Success!</h2>
                <p class="text-gray-700 mb-6" id="successAlertMessage">Perubahan saved successfully.</p>
                <button type="button" onclick="closeSuccessAlertModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg shadow-md font-medium transition duration-200 ease-in-out transform hover:scale-105">
                    OK
                </button>
            </div>
        </div>

        <!-- Global Loading Overlay -->
        <div id="global-loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-[9999] hidden">
            <div class="spinner"></div>
        </div>

    </div>

<script>
    // Firebase configuration
    const firebaseConfig = {
          apiKey: "AIzaSyDWgxJfYKksEoeUF2rK67rAH-arejKawJM",
          authDomain: "monitoring-acc.firebaseapp.com",
          projectId: "monitoring-acc",
          storageBucket: "monitoring-acc.firebasestorage.app",
          messagingSenderId: "898707897888",
          appId: "1:898707897888:web:8cfe6f77cd784d8c1ec645"
    };

    // Google API configuration (Removed as upload document is removed)
    // const GOOGLE_API_CONFIG = {
    //     clientId: "484546392348-f0spk1eghjepp9eiafs7n54gs1abqv6v.apps.googleusercontent.com",
    //     scope: "https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/userinfo.email", // drive.file for specific file access, userinfo.email for email
    // };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const changesCollection = db.collection('accurateChanges');
    const usersCollection = db.collection('users');
    // Removed documentTypesCollection and changeTypesCollection as dropdowns are removed
    // const documentTypesCollection = db.collection('documentTypes');
    // const changeTypesCollection = db.collection('changeTypes');

    let changes = [];
    const DEFAULT_CHANGE_TYPE = 'Koreksi';
    let currentUserRole = 'user';
    let sortableInstances = {};
    let authInitialized = false;
    let unsubscribeFromChanges = null;
    // Removed unsubscribeFromDocumentTypes and unsubscribeFromChangeTypes
    // let unsubscribeFromDocumentTypes = null;
    // let unsubscribeFromChangeTypes = null;

    // Removed documentCatalog, documentTypesCatalog, changeTypesCatalog
    // let documentCatalog = [];
    // let documentTypesCatalog = [];
    // let changeTypesCatalog = [];

    let uniqueDocumentTypes = new Set();
    let uniqueChangeTypes = new Set();

    const ADMIN_EMAIL = 'maida@genetek.co.id';

    // Google API related variables (Removed as upload document is removed)
    // let gapiInited = false;
    // let gisInited = false;
    // let tokenClient;
    let googleAccessToken = null; // Keep this for potential future use or if other Google integrations exist

    // ==================== GOOGLE API INITIALIZATION (Removed as upload document is removed) ====================

    // function gapiLoaded() {
    //     gapi.load('client', initializeGapiClient);
    // }

    // async function initializeGapiClient() {
    //     await gapi.client.init({
    //         // No API key needed if using OAuth for Drive
    //     });
    //     gapiInited = true;
    //     maybeInitGoogleAuth();
    // }

    // function gisLoaded() {
    //     tokenClient = google.accounts.oauth2.initTokenClient({
    //         client_id: GOOGLE_API_CONFIG.clientId,
    //         scope: GOOGLE_API_CONFIG.scope,
    //         callback: (tokenResponse) => {
    //             if (tokenResponse && tokenResponse.access_token) {
    //                 googleAccessToken = tokenResponse.access_token;
    //                 console.log("Google Access Token obtained:", googleAccessToken);
    //                 // You can now use googleAccessToken for Drive API calls
    //             } else {
    //                 console.error("Failed to obtain Google Access Token.");
    //                 showCustomAlert("Failed to connect to Google Drive. Please try again.", "error");
    //             }
    //         },
    //     });
    //     gisInited = true;
    //     maybeInitGoogleAuth();
    // }

    // function maybeInitGoogleAuth() {
    //     if (gapiInited && gisInited && authInitialized) {
    //         // Check if user is logged in via Google and has necessary scopes
    //         const user = auth.currentUser;
    //         if (user && user.providerData.some(p => p.providerId === 'google.com')) {
    //             // Attempt to get a token silently if possible, or prompt if needed
    //             // For simplicity, we'll prompt on first Drive action
    //             console.log("Google API client and GIS loaded, ready for Drive operations.");
    //         } else if (user) {
    //             console.warn("User is logged in but not via Google. Drive features may require re-authentication.");
    //         }
    //     }
    // }

    // Function to handle Google Sign-in for Drive access (Removed as upload document is removed)
    // async function handleGoogleSignInForDrive() {
    //     return new Promise((resolve, reject) => {
    //         if (googleAccessToken) {
    //             resolve(googleAccessToken);
    //             return;
    //         }

    //         // Check if user is already signed in with Google via Firebase
    //         const user = auth.currentUser;
    //         if (user && user.providerData.some(p => p.providerId === 'google.com')) {
    //             // Request token from Google Identity Services
    //             tokenClient.requestAccessToken({ prompt: 'consent' }); // 'consent' ensures user is prompted for permissions
    //             // The callback in initTokenClient will handle setting googleAccessToken
    //             // We need to wait for that callback to complete.
    //             // This is a simplified approach; a more robust solution would use a promise wrapper around tokenClient.requestAccessToken
    //             // For now, we'll rely on the global googleAccessToken being set.
    //             // A small delay or a custom event listener could be used here.
    //             setTimeout(() => {
    //                 if (googleAccessToken) {
    //                     resolve(googleAccessToken);
    //                 } else {
    //                     reject("Google Drive access token not obtained after prompt.");
    //                 }
    //             }, 3000); // Give some time for the tokenClient callback
    //         } else {
    //             // If not signed in with Google via Firebase, prompt for Google login first
    //             const provider = new firebase.auth.GoogleAuthProvider();
    //             provider.addScope(GOOGLE_API_CONFIG.scope); // Request Drive scope during Firebase Google login
    //             auth.signInWithPopup(provider)
    //                 .then((result) => {
    //                     // This gives you a Google Access Token. You can use it to access the Google API.
    //                     googleAccessToken = result.credential.accessToken;
    //                     console.log("Firebase Google login successful, Drive Access Token:", googleAccessToken);
    //                     resolve(googleAccessToken);
    //                 })
    //                 .catch((error) => {
    //                     console.error("Firebase Google login failed for Drive access:", error);
    //                     showCustomAlert("Failed to sign in with Google for Drive access.", "error");
    //                     reject(error);
    //                 });
    //         }
    //     });
    // }


    // ==================== MAIN FUNCTIONS ====================

    auth.onAuthStateChanged(async (user) => {
        if (authInitialized) return;
        authInitialized = true;

        console.log("Auth state changed:", user ? user.email : "no user");

        if (!user && window.location.pathname.includes('app.html')) {
            console.log("No user, redirecting to login");
            window.location.href = 'login.html';
            return;
        }

        if (user && window.location.pathname.includes('login.html')) {
            console.log("User already logged in, redirecting to app");
            window.location.href = 'app.html';
            return;
        }

        if (user && window.location.pathname.includes('app.html')) {
            try {
                showGlobalLoading();
                if (user.email === ADMIN_EMAIL) {
                    currentUserRole = 'admin';
                    await usersCollection.doc(user.uid).set({
                        role: 'admin',
                        email: user.email
                    }, { merge: true });
                } else {
                    console.log("Unauthorized user, logging out and redirecting to login.");
                    await auth.signOut();
                    window.location.href = 'login.html';
                    return;
                }

                console.log("Current role:", currentUserRole);
                fetchDocumentCatalog();
                // Removed listenForDocumentTypes and listenForChangeTypes
                // listenForDocumentTypes();
                // listenForChangeTypes();
                listenForChanges();
                initEventListeners();
                // Removed maybeInitGoogleAuth
                // maybeInitGoogleAuth(); // Check if Google APIs are ready
                hideGlobalLoading();
            } catch (error) {
                console.error("Error checking user role or loading data:", error);
                showCustomAlert("Failed to load user data or application. Please refresh the page.", "error");
                hideGlobalLoading();
            }
        }
    });

    async function fetchDocumentCatalog() {
        console.log("Document catalog will be built from existing changes.");
    }

    // Removed listenForDocumentTypes
    // function listenForDocumentTypes() {
    //     console.log("Listening for Document Types list from Firestore (onSnapshot)...");
    //     if (unsubscribeFromDocumentTypes) {
    //         unsubscribeFromDocumentTypes();
    //     }

    //     unsubscribeFromDocumentTypes = documentTypesCollection.orderBy("name", "asc").onSnapshot(snapshot => {
    //         documentTypesCatalog = [];
    //         snapshot.forEach(doc => {
    //             documentTypesCatalog.push({ id: doc.id, name: doc.data().name });
    //         });
    //         console.log("Document Types Catalog updated:", documentTypesCatalog.length, "items");
    //         populateFilterDropdowns();
    //         populateDocumentTypeDropdown();
    //     }, (error) => {
    //         console.error("Error listening to Document Types list:", error);
    //         showCustomAlert("Failed to load Document Types list in real-time.", "error");
    //     });
    // }

    // Removed listenForChangeTypes
    // function listenForChangeTypes() {
    //     console.log("Listening for Change Types list from Firestore (onSnapshot)...");
    //     if (unsubscribeFromChangeTypes) {
    //         unsubscribeFromChangeTypes();
    //     }

    //     unsubscribeFromChangeTypes = changeTypesCollection.orderBy("name", "asc").onSnapshot(snapshot => {
    //         changeTypesCatalog = [];
    //         snapshot.forEach(doc => {
    //             changeTypesCatalog.push({ id: doc.id, name: doc.data().name });
    //         });
    //         console.log("Change Types Catalog updated:", changeTypesCatalog.length, "items");
    //         populateFilterDropdowns();
    //         populateChangeTypeDropdown();
    //     }, (error) => {
    //         console.error("Error listening to Change Types list:", error);
    //         showCustomAlert("Failed to load Change Types list in real-time.", "error");
    //     });
    // }

    // ==================== UTILITY FUNCTIONS ====================

    function formatDateTime(timestamp) {
        if (!timestamp) return '-';
        try {
            const date = timestamp instanceof Date ? timestamp : (timestamp && typeof timestamp.toDate === 'function' ? timestamp.toDate() : null);
            if (!date) return '-';

            return date.toLocaleString('en-US', {
                day: 'numeric',
                month: 'short',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        } catch (e) {
            console.error("Error formatting date time:", e);
            return '-';
        }
    }

    function formatRupiah(num) {
        if (num === null || num === undefined || isNaN(num)) {
            return 'Rp 0';
        }
        // Ensure num is a number before formatting
        const number = parseFloat(num);
        if (isNaN(number)) {
            return 'Rp 0';
        }
        // Use id-ID for dot as thousands separator and 'Rp' currency symbol
        return 'Rp ' + new Intl.NumberFormat('id-ID').format(number);
    }

    // Function to parse Rupiah string back to a number
    function parseRupiah(rupiahString) {
        if (!rupiahString) return 0;
        // Remove "Rp", dots, and commas, then parse as float
        const cleanedString = rupiahString.replace(/Rp|\./g, '').replace(/,/g, '.').trim();
        return parseFloat(cleanedString) || 0;
    }

    function formatDate(timestamp) {
        if (!timestamp) return '-';
        try {
            const date = timestamp instanceof Date ? timestamp : (timestamp && typeof timestamp.toDate === 'function' ? timestamp.toDate() : null);
            if (!date) return '-';

            return date.toLocaleDateString('en-US');
        } catch (e) {
            console.error("Error formatting date:", e);
            return '-';
        }
    }

    function showCustomAlert(message, type = 'success') {
        const modal = document.getElementById('successAlertModal');
        const modalContent = document.getElementById('successAlertModalContent');
        const alertMessage = document.getElementById('successAlertMessage');
        const alertIcon = modalContent.querySelector('.text-6xl i');

        alertMessage.textContent = message;

        if (type === 'success') {
            alertIcon.className = 'fas fa-check-circle text-green-500';
        } else if (type === 'error') {
            alertIcon.className = 'fas fa-times-circle text-red-500';
        } else if (type === 'info') {
            alertIcon.className = 'fas fa-info-circle text-blue-500';
        } else if (type === 'warning') {
            alertIcon.className = 'fas fa-exclamation-triangle text-yellow-500';
        }

        modal.classList.remove('hidden');
    }

    function closeSuccessAlertModal() {
        const modal = document.getElementById('successAlertModal');
        if (!modal) return;
        modal.classList.add('hidden');
    }

    function showGlobalLoading() {
        document.getElementById('global-loading-overlay').classList.add('show');
    }

    function hideGlobalLoading() {
        document.getElementById('global-loading-overlay').classList.remove('show');
    }

    // ==================== CHANGES FUNCTIONS ====================

    function listenForChanges() {
        console.log("Listening for Accurate Changes from Firebase (onSnapshot)...");
        const pipelineStage = document.getElementById('pos-stage');
        const loadingSpinner = document.getElementById('loading-spinner');
        if (pipelineStage && loadingSpinner) {
            pipelineStage.innerHTML = '';
            loadingSpinner.classList.remove('hidden');
        }

        if (unsubscribeFromChanges) {
            unsubscribeFromChanges();
        }

        changesCollection.orderBy("createdAt", "asc").onSnapshot(snapshot => {
            changes = [];
            uniqueDocumentTypes.clear();
            uniqueChangeTypes.clear();

            snapshot.forEach((doc) => {
                const changeData = doc.data();
                changeData.createdAt = changeData.createdAt && typeof changeData.createdAt.toDate === 'function' ? changeData.createdAt.toDate() : null;
                changeData.documentDate = changeData.documentDate && typeof changeData.documentDate.toDate === 'function' ? changeData.documentDate.toDate() : null;
                changeData.changeDate = changeData.changeDate && typeof changeData.changeDate.toDate === 'function' ? changeData.changeDate.toDate() : null;

                changes.push({ id: doc.id, ...changeData });

                if (changeData.documentType) uniqueDocumentTypes.add(changeData.documentType);
                if (changeData.changeType) uniqueChangeTypes.add(changeData.changeType);
            });
            console.log("Total Accurate Changes updated by onSnapshot:", changes.length);
            populateFilterDropdowns();
            filterPOs();
            if (loadingSpinner) {
                loadingSpinner.classList.add('hidden');
            }
        }, (error) => {
            console.error("Error listening to Accurate Changes:", error);
            showCustomAlert("Failed to load Accurate Changes data in real-time.", "error");
            if (loadingSpinner) {
                loadingSpinner.classList.add('hidden');
            }
        });
    }

    function renderChangeCard(change, index) {
        const changeCard = document.createElement('div');
        changeCard.className = 'deal-card';
        changeCard.dataset.id = change.id;

        function getChangeTypeClass(changeType) {
            switch (changeType) {
                case 'Penambahan': return 'status-picked-up';
                case 'Pengurangan': return 'status-delayed';
                case 'Koreksi': return 'status-waiting';
                default: return 'bg-gray-400 text-white';
            }
        }

        changeCard.innerHTML = `
            <span class="po-card-number">${index + 1}</span>
            <div class="flex justify-between items-start">
                <h3 class="font-bold text-gray-800">Nomor Dokumen: ${change.documentNumber || 'No Dokumen'}</h3>
            </div>
            <div class="mt-1 text-sm text-gray-600 deal-details">
                <p><i class="fas fa-file-alt"></i> Tipe Dokumen: ${change.documentType || '-'}</p>
                <p><i class="fas fa-calendar-alt"></i> Tanggal Dokumen: ${change.documentDate ? formatDate(change.documentDate) : '-'}</p>
                <p><i class="fas fa-tag"></i> Tipe Perubahan: ${change.changeType || '-'}</p>
            </div>
            <div class="mt-2 flex justify-between items-center deal-footer">
                <div class="relative">
                    <select onchange="updateChangeType('${change.id}', this.value)" class="status-dropdown ${getChangeTypeClass(change.changeType)}">
                        <option value="Penambahan" ${change.changeType === 'Penambahan' ? 'selected' : ''}>Penambahan</option>
                        <option value="Pengurangan" ${change.changeType === 'Pengurangan' ? 'selected' : ''}>Pengurangan</option>
                        <option value="Koreksi" ${change.changeType === 'Koreksi' ? 'selected' : ''}>Koreksi</option>
                    </select>
                </div>
                <div class="flex space-x-1 deal-actions">
                    <button onclick="openChangeDetailModal('${change.id}')" class="text-blue-600 hover:text-blue-800" title="View Details">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button onclick="prepareEditChange('${change.id}')" class="text-green-600 hover:text-green-800" title="Edit Perubahan">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="confirmDeleteChange('${change.id}', '${change.documentNumber}')" class="text-red-600 hover:text-red-800" title="Delete Perubahan">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            </div>
        `;

        return changeCard;
    }

    function populateDropdown(selectElementId, uniqueValues, selectedValue = 'all') {
        const selectElement = document.getElementById(selectElementId);
        if (!selectElement) {
            console.warn(`Element with ID '${selectElementId}' not found.`);
            return;
        }

        const currentSelectedValue = selectElement.value;

        selectElement.innerHTML = '';

        const defaultOption = document.createElement('option');
        defaultOption.value = 'all';
        const labelElement = selectElement.previousElementSibling;
        const labelText = labelElement ? labelElement.textContent.replace(':', '').replace('*', '').trim() : '';
        defaultOption.textContent = `Semua ${labelText}`;
        selectElement.appendChild(defaultOption);

        const sortedValues = Array.from(uniqueValues).sort();
        sortedValues.forEach(value => {
            if (value) {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = value;
                selectElement.appendChild(option);
            }
        });

        if (Array.from(selectElement.options).some(option => option.value === currentSelectedValue)) {
            selectElement.value = currentSelectedValue;
        } else {
            selectElement.value = 'all';
        }
    }

    function populateFilterDropdowns() {
        populateDropdown('filterDocumentType', uniqueDocumentTypes, document.getElementById('filterDocumentType').value);
        populateDropdown('filterChangeType', uniqueChangeTypes, document.getElementById('filterChangeType').value);
    }

    // Removed populateDocumentTypeDropdown
    // function populateDocumentTypeDropdown() {
    //     const selectElement = document.getElementById('documentType');
    //     if (!selectElement) return;

    //     const currentSelectedValue = selectElement.value;
    //     selectElement.innerHTML = '<option value="">Pilih Tipe Dokumen</option>';
    //     documentTypesCatalog.forEach(type => {
    //         const option = document.createElement('option');
    //         option.value = type.name;
    //         option.textContent = type.name;
    //         selectElement.appendChild(option);
    //     });
    //     selectElement.value = currentSelectedValue;
    // }

    // Removed populateChangeTypeDropdown
    // function populateChangeTypeDropdown() {
    //     const selectElement = document.getElementById('changeType');
    //     if (!selectElement) return;

    //     const currentSelectedValue = selectElement.value;
    //     selectElement.innerHTML = '<option value="">Pilih Tipe Perubahan</option>';
    //     changeTypesCatalog.forEach(type => {
    //         const option = document.createElement('option');
    //         option.value = type.name;
    //         option.textContent = type.name;
    //         selectElement.appendChild(option);
    //     });
    //     selectElement.value = currentSelectedValue;
    // }

    // ==================== FUNCTIONS FOR ADDITIONAL FORMS WITH SEARCH (Generic Autocomplete) ====================

    function debounce(func, delay) {
        let timeout;
        return function(...args) {
            const context = this;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), delay);
        };
    }

    // Removed setupSearchWithSuggestions and related autocomplete functions as upload document is removed
    // function setupSearchWithSuggestions(searchInput, hiddenInput, suggestionsDiv, dataList, displayProperty, onSelectCallback = null) {
    //     const MAX_SUGGESTIONS = 20;
    //     let currentFocus = -1;

    //     const processInput = () => {
    //         const val = searchInput.value.trim();
    //         suggestionsDiv.innerHTML = '';
    //         suggestionsDiv.classList.add('hidden');

    //         if (!val) {
    //             hiddenInput.value = '';
    //             if (onSelectCallback) onSelectCallback(null); // Indicate no selection
    //             return false;
    //         }
    //         currentFocus = -1;

    //         const filteredSuggestions = dataList
    //             .filter(item => {
    //                 const itemValue = item[displayProperty];
    //                 return itemValue && itemValue.toLowerCase().includes(val.toLowerCase());
    //             })
    //             .sort((a, b) => {
    //                 const valA = a[displayProperty];
    //                 const valB = b[displayProperty];
    //                 return valA.localeCompare(valB);
    //             })
    //             .slice(0, MAX_SUGGESTIONS);

    //         if (filteredSuggestions.length > 0) {
    //             filteredSuggestions.forEach(item => {
    //                 const itemValue = item[displayProperty];
    //                 const b = document.createElement("DIV");
    //                 b.classList.add("autocomplete-item");
    //                 const startIdx = itemValue.toLowerCase().indexOf(val.toLowerCase());
    //                 b.innerHTML = itemValue.substring(0, startIdx) + "<strong>" + itemValue.substring(startIdx, startIdx + val.length) + "</strong>" + itemValue.substring(startIdx + val.length);

    //                 b.addEventListener("click", function(e) {
    //                     e.stopPropagation();
    //                     searchInput.value = itemValue;
    //                     hiddenInput.value = item.id; // Store the ID of the selected item
    //                     suggestionsDiv.classList.add('hidden');
    //                     if (onSelectCallback) {
    //                         onSelectCallback(item);
    //                     }
    //                 });
    //                 suggestionsDiv.appendChild(b);
    //             });
    //             suggestionsDiv.classList.remove('hidden');
    //         } else {
    //             suggestionsDiv.classList.add('hidden');
    //         }
    //     };

    //     const debouncedProcessInput = debounce(processInput, 300);

    //     const handleKeydown = (e) => {
    //         let x = suggestionsDiv.getElementsByClassName("autocomplete-item");
    //         if (e.keyCode == 40) {
    //             currentFocus++;
    //             addActive(x);
    //         } else if (e.keyCode == 38) {
    //             currentFocus--;
    //             addActive(x);
    //         } else if (e.keyCode == 13) {
    //             e.preventDefault();
    //             if (currentFocus > -1) {
    //                 if (x && x[currentFocus]) x[currentFocus].click();
    //             } else {
    //                 // If Enter is pressed and no suggestion is selected, use the typed value
    //                 // For this specific autocomplete, we want to ensure a valid selection.
    //                 // If no item is selected, clear the hidden input and show a warning.
    //                 hiddenInput.value = '';
    //                 suggestionsDiv.classList.add('hidden');
    //                 // showCustomAlert("Please select a valid document from the suggestions.", "warning"); // Removed to avoid excessive alerts
    //                 if (onSelectCallback) onSelectCallback(null); // Indicate no selection
    //             }
    //         }
    //     };

    //     const handleBlur = () => {
    //         setTimeout(() => {
    //             const currentInputValue = searchInput.value.trim();
    //             const selectedId = hiddenInput.value;
    //             const selectedItem = dataList.find(item => item.id === selectedId);

    //             if (currentInputValue === '' || (selectedItem && selectedItem[displayProperty] === currentInputValue)) {
    //                 // Input is empty or matches a selected item, do nothing
    //             } else {
    //                 // Input does not match a selected item, clear it
    //                 searchInput.value = '';
    //                 hiddenInput.value = '';
    //                 if (onSelectCallback) {
    //                     onSelectCallback(null); // Indicate no item selected
    //                 }
    //             }
    //             suggestionsDiv.classList.add('hidden');
    //         }, 100);
    //     };

    //     const handleFocus = () => {
    //         if (searchInput.value.length > 0) {
    //             processInput();
    //         }
    //     };

    //     searchInput.removeEventListener('input', debouncedProcessInput);
    //     searchInput.removeEventListener('keydown', handleKeydown);
    //     searchInput.removeEventListener('blur', handleBlur);
    //     searchInput.removeEventListener('focus', handleFocus);

    //     searchInput.addEventListener('input', debouncedProcessInput);
    //     searchInput.addEventListener('keydown', handleKeydown);
    //     searchInput.addEventListener('blur', handleBlur);
    //     searchInput.addEventListener('focus', handleFocus);

    //     function addActive(x) {
    //         if (!x || x.length === 0) return false;
    //         removeActive(x);
    //         currentFocus = (currentFocus + x.length) % x.length;
    //         x[currentFocus].classList.add("autocomplete-active");
    //         x[currentFocus].scrollIntoView({ block: "nearest", inline: "nearest" });
    //     }

    //     function removeActive(x) {
    //         for (let i = 0; i < x.length; i++) {
    //             x[i].classList.remove("autocomplete-active");
    //         }
    //     }
    // }

    function closeAllAutocompleteSuggestions() {
        document.querySelectorAll(".suggestions-list").forEach(item => {
            item.classList.add('hidden');
            item.innerHTML = '';
        });
    }

    document.addEventListener("click", function(e) {
        let isAutocompleteClick = false;
        let target = e.target;
        while (target && target !== document.body) {
            // Removed conditions related to docUpload_documentNumberSearch and loadDocumentForUploadBtn
            if (target.classList.contains('autocomplete-items')) {
                isAutocompleteClick = true;
                break;
            }
            target = target.parentNode;
        }
        if (!isAutocompleteClick) {
            closeAllAutocompleteSuggestions();
        }
    });

    async function openPOModal(changeId = null) {
        const poModal = document.getElementById('poModal');
        const modalTitle = document.getElementById('modalTitle');
        const poForm = document.getElementById('poForm');

        poForm.reset();
        document.getElementById('poId').value = '';

        // Reset Rupiah inputs
        document.getElementById('initialPriceValue').value = '';
        document.getElementById('changedPriceValue').value = '';

        // Removed populateDocumentTypeDropdown and populateChangeTypeDropdown
        // populateDocumentTypeDropdown();
        // populateChangeTypeDropdown();

        document.getElementById('changeType').value = DEFAULT_CHANGE_TYPE;

        closeAllAutocompleteSuggestions();

        if (changeId) {
            modalTitle.textContent = 'Edit Perubahan';
            const change = changes.find(c => c.id === changeId);
            if (change) {
                document.getElementById('poId').value = change.id;
                document.getElementById('documentType').value = change.documentType || '';
                document.getElementById('documentNumber').value = change.documentNumber || '';
                document.getElementById('documentDate').value = change.documentDate instanceof Date ? change.documentDate.toISOString().split('T')[0] : '';
                document.getElementById('description').value = change.description || '';
                // Format existing values to Rupiah for display
                document.getElementById('initialPriceValue').value = formatRupiah(change.initialPriceValue);
                document.getElementById('changeDate').value = change.changeDate instanceof Date ? change.changeDate.toISOString().split('T')[0] : '';
                document.getElementById('changeType').value = change.changeType || DEFAULT_CHANGE_TYPE;
                document.getElementById('changeDescription').value = change.changeDescription || '';
                document.getElementById('changedPriceValue').value = formatRupiah(change.changedPriceValue);
            }
        } else {
            modalTitle.textContent = 'Add New Perubahan';
        }

        poModal.classList.remove('hidden');
    }

    function closePOModal() {
        const poModal = document.getElementById('poModal');
        if (!poModal) return;
        poModal.classList.add('hidden');
        closeAllAutocompleteSuggestions();
    }

    async function savePO() {
        const changeId = document.getElementById('poId').value;
        const documentNumber = document.getElementById('documentNumber').value;

        if (!documentNumber) {
            showCustomAlert("Nomor Dokumen is required.", "error");
            return;
        }

        // Parse Rupiah values back to numbers before saving
        const initialPriceValueRaw = document.getElementById('initialPriceValue').value;
        const changedPriceValueRaw = document.getElementById('changedPriceValue').value;

        const initialPriceValue = parseRupiah(initialPriceValueRaw);
        const changedPriceValue = parseRupiah(changedPriceValueRaw);

        closePOModal();
        showGlobalLoading();

        const documentType = document.getElementById('documentType').value;
        const documentDate = document.getElementById('documentDate').value ? firebase.firestore.Timestamp.fromDate(new Date(document.getElementById('documentDate').value)) : null;
        const description = document.getElementById('description').value;
        const changeDate = document.getElementById('changeDate').value ? firebase.firestore.Timestamp.fromDate(new Date(document.getElementById('changeDate').value)) : null;
        const changeType = document.getElementById('changeType').value;
        const changeDescription = document.getElementById('changeDescription').value;

        const changeData = {
            documentType: documentType,
            documentNumber: documentNumber,
            documentDate: documentDate,
            description: description,
            initialPriceValue: initialPriceValue, // Use parsed number
            changeDate: changeDate,
            changeType: changeType,
            changeDescription: changeDescription,
            changedPriceValue: changedPriceValue, // Use parsed number
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        try {
            if (changeId) {
                await changesCollection.doc(changeId).update(changeData);
                showCustomAlert("Perubahan updated successfully!", "success");
            } else {
                changeData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                changeData.createdBy = auth.currentUser.email;
                await changesCollection.add(changeData);
                showCustomAlert("New Perubahan added successfully!", "success");
            }
            
            // Panggil filterPOs untuk me-refresh tampilan setelah data disimpan
            filterPOs(); // <--- Tambahkan baris ini

        } catch (error) {
            console.error("Error saving Perubahan:", error);
            showCustomAlert("Failed to save Perubahan. Please try again.", "error");
        } finally {
            hideGlobalLoading();
        }
    }

    function prepareEditChange(changeId) {
        openPOModal(changeId);
    }

    let changeToDeleteId = null;
    let changeToDeleteNumber = '';

    function confirmDeleteChange(changeId, documentNumber) {
        changeToDeleteId = changeId;
        changeToDeleteNumber = documentNumber;
        document.getElementById('dealToDeleteName').textContent = documentNumber;
        document.getElementById('deleteModal').classList.remove('hidden');
    }

    async function deletePO() {
        if (!changeToDeleteId) return;

        closeDeleteModal();
        showGlobalLoading();

        try {
            await changesCollection.doc(changeToDeleteId).delete();
            showCustomAlert(`Perubahan "${changeToDeleteNumber}" deleted successfully!`, "success");
        } catch (error) {
            console.error("Error deleting Perubahan:", error);
            showCustomAlert("Failed to delete Perubahan. Please try again.", "error");
        } finally {
            hideGlobalLoading();
        }
    }

    async function updateChangeType(changeId, newChangeType) {
        showGlobalLoading();
        try {
            await changesCollection.doc(changeId).update({
                changeType: newChangeType,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            showCustomAlert(`Tipe Perubahan updated to "${newChangeType}" successfully!`, "success");
        } catch (error) {
            console.error("Error updating Tipe Perubahan:", error);
            showCustomAlert("Failed to update Tipe Perubahan. Please try again.", "error");
        } finally {
            hideGlobalLoading();
        }
    }

    function openChangeDetailModal(changeId) {
        const change = changes.find(c => c.id === changeId);
        if (!change) {
            showCustomAlert("Detail perubahan tidak ditemukan.", "error");
            return;
        }

        document.getElementById('poDetailTitle').textContent = change.documentNumber || 'Detail Perubahan';
        document.getElementById('detailDocumentType').textContent = change.documentType || '-';
        document.getElementById('detailDocumentNumber').textContent = change.documentNumber || '-';
        document.getElementById('detailDocumentDate').textContent = change.documentDate ? formatDate(change.documentDate) : '-';
        document.getElementById('detailDescription').textContent = change.description || '-';
        document.getElementById('detailInitialPriceValue').textContent = formatRupiah(change.initialPriceValue);
        document.getElementById('detailChangeDate').textContent = change.changeDate ? formatDate(change.changeDate) : '-';
        document.getElementById('detailChangeType').textContent = change.changeType || '-';
        document.getElementById('detailChangeDescription').textContent = change.changeDescription || '-';
        document.getElementById('detailChangedPriceValue').textContent = formatRupiah(change.changedPriceValue);

        // Document Upload Links Section (Removed as upload document is removed)
        // const linkPdfBefore = document.getElementById('linkPdfBefore');
        // const linkPdfAfter = document.getElementById('linkPdfAfter');

        // if (change.pdfBeforeChangeLink) {
        //     linkPdfBefore.href = change.pdfBeforeChangeLink;
        //     linkPdfBefore.classList.remove('hidden');
        //     linkPdfBefore.textContent = 'Lihat Dokumen';
        // } else {
        //     linkPdfBefore.href = '#';
        //     linkPdfBefore.classList.add('hidden');
        //     linkPdfBefore.textContent = 'Tidak ada dokumen';
        // }

        // if (change.pdfAfterChangeLink) {
        //     linkPdfAfter.href = change.pdfAfterChangeLink;
        //     linkPdfAfter.classList.remove('hidden');
        //     linkPdfAfter.textContent = 'Lihat Dokumen';
        // } else {
        //     linkPdfAfter.href = '#';
        //     linkPdfAfter.classList.add('hidden');
        //     linkPdfAfter.textContent = 'Tidak ada dokumen';
        // }

        document.getElementById('poDetailModal').classList.remove('hidden');
    }

    function closePODetailModal() {
        const poDetailModal = document.getElementById('poDetailModal');
        if (!poDetailModal) return;
        poDetailModal.classList.add('hidden');
    }

    // ==================== SORTABLE FUNCTIONS ====================

    function initSortable() {
        const pipelineStage = document.getElementById('pos-stage');
        if (!pipelineStage) return;
        console.log("SortableJS is disabled.");
    }

    // ==================== PERMISSIONS FUNCTIONS ====================

    function applyUserPermissions() {
        try {
            const isAdmin = currentUserRole === 'admin';

            console.log("Applying permissions for Role:", currentUserRole);

            const newPOBtn = document.getElementById('newPOBtn');
            // Removed documentUploadBtn
            // const documentUploadBtn = document.getElementById('documentUploadBtn');
            const exportExcelBtn = document.getElementById('exportExcelBtn');
            const searchInput = document.getElementById('searchPOs');
            const openFilterPanelBtn = document.getElementById('openFilterPanelBtn');
            const backButton = document.getElementById('backButton');
            const authButton = document.getElementById('authButton');

            if (newPOBtn) newPOBtn.classList.remove('hidden');
            // if (documentUploadBtn) documentUploadBtn.classList.remove('hidden'); // Removed
            if (exportExcelBtn) exportExcelBtn.classList.remove('hidden');
            if (backButton) backButton.classList.remove('hidden');
            if (authButton) authButton.classList.remove('hidden');

            if (searchInput) searchInput.classList.remove('hidden');
            if (openFilterPanelBtn) openFilterPanelBtn.classList.remove('hidden');

        } catch (error) {
            console.error("Error in applyUserPermissions:", error);
            showCustomAlert("Failed to apply permissions", "error");
        }
    }

    // ==================== EVENT LISTENERS FUNCTIONS ====================

    function initEventListeners() {
        console.log("Initializing event listeners...");

        try {
            const poForm = document.getElementById('poForm');
            if (poForm) {
                poForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    savePO();
                });
            }

            // Removed documentUploadForm and related event listeners
            // const documentUploadForm = document.getElementById('documentUploadForm');
            // if (documentUploadForm) {
            //     documentUploadForm.addEventListener('submit', function(e) {
            //         e.preventDefault();
            //         uploadDocuments();
            //     });
            // }

            const buttons = [
                { id: 'newPOBtn', func: openPOModal },
                // Removed documentUploadBtn
                // { id: 'documentUploadBtn', func: openDocumentUploadModal },
                { id: 'exportExcelBtn', func: exportToExcel },
                { id: 'backButton', func: goToIndex },
                { id: 'authButton', func: logout },
                { id: 'openFilterPanelBtn', func: openFilterPanel }
            ];

            buttons.forEach(btn => {
                const element = document.getElementById(btn.id);
                if (element) {
                    element.removeEventListener('click', btn.func);
                    element.addEventListener('click', btn.func);
                    element.addEventListener('click', createRipple);
                    console.log(`Event listener added for ${btn.id}`);
                }
            });

            const searchInput = document.getElementById('searchPOs');
            if (searchInput) {
                searchInput.removeEventListener('keyup', filterPOs);
                searchInput.addEventListener('keyup', filterPOs);
            }

            // Removed loadDocumentForUploadBtn and related event listeners
            // const loadDocumentForUploadBtn = document.getElementById('loadDocumentForUploadBtn');
            // if (loadDocumentForUploadBtn) {
            //     loadDocumentForUploadBtn.addEventListener('click', function() {
            //         const changeId = document.getElementById('docUpload_changeId').value;
            //         if (changeId) {
            //             loadDocumentForUpload(changeId);
            //         } else {
            //             showCustomAlert("Please select a Document Number first.", "warning");
            //         }
            //     });
            // }

            // Removed File input change listeners
            // document.getElementById('pdfBeforeChange').addEventListener('change', function() {
            //     const fileName = this.files.length > 0 ? this.files[0].name : 'Tidak ada file dipilih';
            //     document.getElementById('pdfBeforeFileName').textContent = fileName;
            // });
            // document.getElementById('pdfAfterChange').addEventListener('change', function() {
            //     const fileName = this.files.length > 0 ? this.files[0].name : 'Tidak ada file dipilih';
            //     document.getElementById('pdfAfterFileName').textContent = fileName;
            // });

            // Add event listeners for Rupiah formatting on input fields
            const initialPriceValueInput = document.getElementById('initialPriceValue');
            const changedPriceValueInput = document.getElementById('changedPriceValue');

            if (initialPriceValueInput) {
                initialPriceValueInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/[^0-9]/g, ''); // Remove non-numeric characters
                    e.target.value = formatRupiah(value).replace('Rp ', ''); // Format and remove 'Rp ' for input display
                });
                initialPriceValueInput.addEventListener('focus', function(e) {
                    // On focus, remove formatting to allow easier editing
                    e.target.value = parseRupiah(e.target.value);
                });
                initialPriceValueInput.addEventListener('blur', function(e) {
                    // On blur, apply formatting
                    e.target.value = formatRupiah(e.target.value);
                });
            }

            if (changedPriceValueInput) {
                changedPriceValueInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/[^0-9]/g, ''); // Remove non-numeric characters
                    e.target.value = formatRupiah(value).replace('Rp ', ''); // Format and remove 'Rp ' for input display
                });
                changedPriceValueInput.addEventListener('focus', function(e) {
                    // On focus, remove formatting to allow easier editing
                    e.target.value = parseRupiah(e.target.value);
                });
                changedPriceValueInput.addEventListener('blur', function(e) {
                    // On blur, apply formatting
                    e.target.value = formatRupiah(e.target.value);
                });
            }


        } catch (error) {
            console.error("Error initializing event listeners:", error);
            showCustomAlert("Failed to load some functions", "error");
        }
    }

    function createRipple(event) {
        const button = event.currentTarget;
        const circle = document.createElement('span');
        const diameter = Math.max(button.clientWidth, button.clientHeight);
        const radius = diameter / 2;

        circle.style.width = circle.style.height = `${diameter}px`;
        circle.style.left = `${event.clientX - (button.getBoundingClientRect().left + radius)}px`;
        circle.style.top = `${event.clientY - (button.getBoundingClientRect().top + radius)}px`;
        circle.classList.add('ripple');

        const ripple = button.getElementsByClassName('ripple')[0];

        if (ripple) {
            ripple.remove();
        }

        button.appendChild(circle);
    }

    // ==================== OTHER FUNCTIONS ====================

    function filterPOs() {
        try {
            const searchTerm = document.getElementById('searchPOs').value.toLowerCase();
            const documentTypeFilter = document.getElementById('filterDocumentType').value;
            const changeTypeFilter = document.getElementById('filterChangeType').value;

            let baseChanges = changes;

            const filteredChanges = baseChanges.filter(change => {
                const matchesSearch =
                    (change.documentNumber && change.documentNumber.toLowerCase().includes(searchTerm)) ||
                    (change.description && change.description.toLowerCase().includes(searchTerm)) ||
                    (change.changeDescription && change.changeDescription.toLowerCase().includes(searchTerm));

                const matchesDocumentType =
                    documentTypeFilter === 'all' ||
                    (change.documentType && change.documentType === documentTypeFilter);

                const matchesChangeType =
                    changeTypeFilter === 'all' ||
                    (change.changeType && change.changeType === changeTypeFilter);

                return matchesSearch && matchesDocumentType && matchesChangeType;
            });

            renderFilteredChanges(filteredChanges);
        } catch (error) {
            console.error("Error filtering Changes:", error);
        }
    }

    function renderFilteredChanges(filteredChanges) {
        const pipelineStage = document.getElementById('pos-stage');
        if (!pipelineStage) return;

        pipelineStage.innerHTML = '';

        if (filteredChanges.length === 0) {
            pipelineStage.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-search"></i>
                    <p>No changes match the filter.</p>
                </div>
            `;
            return;
        }

        filteredChanges.forEach((change, index) => {
            const changeCard = renderChangeCard(change, index);
            pipelineStage.appendChild(changeCard);
            setTimeout(() => {
                changeCard.classList.add('show');
            }, 50 * index);
        });
    }

    function logout() {
        if (unsubscribeFromChanges) {
            unsubscribeFromChanges();
            unsubscribeFromChanges = null;
        }
        // Removed unsubscribeFromDocumentTypes and unsubscribeFromChangeTypes
        // if (unsubscribeFromDocumentTypes) {
        //     unsubscribeFromDocumentTypes();
        //     unsubscribeFromDocumentTypes = null;
        // }
        // if (unsubscribeFromChangeTypes) {
        //     unsubscribeFromChangeTypes();
        //     unsubscribeFromChangeTypes = null;
        // }
        auth.signOut()
            .then(() => {
                console.log("User logged out successfully");
                changes = [];
                // Removed documentTypesCatalog and changeTypesCatalog
                // documentTypesCatalog = [];
                // changeTypesCatalog = [];
                googleAccessToken = null; // Clear Google token on logout
                window.location.href = 'login.html';
            })
            .catch((error) => {
                console.error("Error logging out:", error);
                showCustomAlert("Failed to log out. Please try again.", "error");
            });
    }

    function goToIndex() {
        window.location.href = 'index.html';
    }

    function openFilterPanel() {
        const filterPanel = document.getElementById('filterPanel');
        if (!filterPanel) {
            console.error("Filter panel element not found.");
            showCustomAlert("Failed to open filter: Incomplete elements.", "error");
            return;
        }

        populateFilterDropdowns();

        filterPanel.classList.remove('hidden');
    }

    function closeFilterPanel() {
        const filterPanel = document.getElementById('filterPanel');
        if (!filterPanel) {
            console.error("filterPanelContent element not found when closing modal.");
            return;
        }
        filterPanel.classList.add('hidden');
    }

    function applyFiltersAndClosePanel() {
        filterPOs();
        closeFilterPanel();
    }

    function resetFilters() {
        document.getElementById('filterDocumentType').value = 'all';
        document.getElementById('filterChangeType').value = 'all';
        document.getElementById('searchPOs').value = '';
        filterPOs();
    }

    function closeDeleteModal() {
        const deleteModal = document.getElementById('deleteModal');
        if (!deleteModal) return;
        deleteModal.classList.add('hidden');
    }

    // ==================== DOCUMENT UPLOAD FUNCTIONS (Removed as upload document is removed) ====================

    // async function openDocumentUploadModal() {
    //     const documentUploadModal = document.getElementById('documentUploadModal');
    //     if (documentUploadModal) {
    //         document.getElementById('documentUploadForm').reset();
    //         document.getElementById('docUpload_documentNumberSearch').value = '';
    //         document.getElementById('docUpload_changeId').value = '';
    //         document.getElementById('selectedDocumentUploadInfo').classList.add('hidden');
    //         document.getElementById('selectedDocumentUploadNumberDisplay').textContent = '';
    //         document.getElementById('uploadFieldsContainer').classList.add('hidden'); // Hide upload fields initially

    //         // Reset file input displays
    //         document.getElementById('pdfBeforeChange').value = ''; // Clear actual file input
    //         document.getElementById('pdfAfterChange').value = ''; // Clear actual file input
    //         document.getElementById('pdfBeforeFileName').textContent = 'Tidak ada file dipilih';
    //         document.getElementById('pdfAfterFileName').textContent = 'Tidak ada file dipilih';
    //         document.getElementById('pdfBeforeLink').classList.add('hidden');
    //         document.getElementById('pdfAfterLink').classList.add('hidden');
    //         document.getElementById('pdfBeforeLink').href = '#';
    //         document.getElementById('pdfAfterLink').href = '#';

    //         const documentNumberSearchInput = document.getElementById('docUpload_documentNumberSearch');
    //         const changeIdHiddenInput = document.getElementById('docUpload_changeId');
    //         const documentNumberSuggestionsDiv = document.getElementById('docUpload_documentNumberSuggestions');

    //         const documentNumberData = changes.map(c => ({ documentNumber: c.documentNumber, id: c.id }));

    //         setupSearchWithSuggestions(documentNumberSearchInput, changeIdHiddenInput, documentNumberSuggestionsDiv, documentNumberData, 'documentNumber', (selectedChange) => {
    //             if (selectedChange) {
    //                 changeIdHiddenInput.value = selectedChange.id;
    //                 document.getElementById('selectedDocumentUploadNumberDisplay').textContent = selectedChange.documentNumber;
    //                 document.getElementById('selectedDocumentUploadInfo').classList.remove('hidden');
    //                 document.getElementById('uploadFieldsContainer').classList.remove('hidden'); // Show upload fields
    //                 loadDocumentForUpload(selectedChange.id); // Load existing links
    //             } else {
    //                 changeIdHiddenInput.value = '';
    //                 document.getElementById('selectedDocumentUploadInfo').classList.add('hidden');
    //                 document.getElementById('uploadFieldsContainer').classList.add('hidden'); // Hide upload fields
    //                 // Clear file input displays if no document is selected
    //                 document.getElementById('pdfBeforeChange').value = '';
    //                 document.getElementById('pdfAfterChange').value = '';
    //                 document.getElementById('pdfBeforeFileName').textContent = 'Tidak ada file dipilih';
    //                 document.getElementById('pdfAfterFileName').textContent = 'Tidak ada file dipilih';
    //                 document.getElementById('pdfBeforeLink').classList.add('hidden');
    //                 document.getElementById('pdfAfterLink').classList.add('hidden');
    //             }
    //         });

    //         documentUploadModal.classList.remove('hidden');
    //     }
    // }

    // function closeDocumentUploadModal() {
    //     const documentUploadModal = document.getElementById('documentUploadModal');
    //     if (documentUploadModal) {
    //         documentUploadModal.classList.add('hidden');
    //         closeAllAutocompleteSuggestions();
    //     }
    // }

    // async function loadDocumentForUpload(changeId) {
    //     showGlobalLoading();
    //     try {
    //         const changeDoc = await changesCollection.doc(changeId).get();
    //         if (changeDoc.exists) {
    //             const changeData = changeDoc.data();
    //             // Display existing links
    //             const pdfBeforeLink = document.getElementById('pdfBeforeLink');
    //             const pdfAfterLink = document.getElementById('pdfAfterLink');

    //             if (changeData.pdfBeforeChangeLink) {
    //                 pdfBeforeLink.href = changeData.pdfBeforeChangeLink;
    //                 pdfBeforeLink.classList.remove('hidden');
    //                 document.getElementById('pdfBeforeFileName').textContent = 'Dokumen sudah diunggah';
    //             } else {
    //                 pdfBeforeLink.classList.add('hidden');
    //                 document.getElementById('pdfBeforeFileName').textContent = 'Tidak ada file dipilih';
    //             }

    //             if (changeData.pdfAfterChangeLink) {
    //                 pdfAfterLink.href = changeData.pdfAfterChangeLink;
    //                 pdfAfterLink.classList.remove('hidden');
    //                 document.getElementById('pdfAfterFileName').textContent = 'Dokumen sudah diunggah';
    //             } else {
    //                 pdfAfterLink.classList.add('hidden');
    //                 document.getElementById('pdfAfterFileName').textContent = 'Tidak ada file dipilih';
    //             }

    //             document.getElementById('selectedDocumentUploadNumberDisplay').textContent = changeData.documentNumber;
    //             document.getElementById('selectedDocumentUploadInfo').classList.remove('hidden');
    //             document.getElementById('docUpload_changeId').value = changeId;
    //             document.getElementById('docUpload_documentNumberSearch').value = changeData.documentNumber;
    //             document.getElementById('uploadFieldsContainer').classList.remove('hidden');

    //             showCustomAlert(`Dokumen untuk Nomor Dokumen ${changeData.documentNumber} dimuat.`, "info");
    //         } else {
    //             document.getElementById('documentUploadForm').reset();
    //             document.getElementById('selectedDocumentUploadInfo').classList.add('hidden');
    //             document.getElementById('uploadFieldsContainer').classList.add('hidden');
    //             showCustomAlert("Dokumen tidak ditemukan untuk Nomor Dokumen ini.", "warning");
    //         }
    //     } catch (error) {
    //         console.error("Error loading document for upload:", error);
    //         showCustomAlert("Gagal memuat dokumen untuk upload. Silakan coba lagi.", "error");
    //     } finally {
    //         hideGlobalLoading();
    //     }
    // }

    // async function uploadDocuments() {
    //     const changeId = document.getElementById('docUpload_changeId').value;
    //     const documentNumber = document.getElementById('selectedDocumentUploadNumberDisplay').textContent;

    //     if (!changeId) {
    //         showCustomAlert("Harap pilih Nomor Dokumen terlebih dahulu untuk mengunggah dokumen.", "error");
    //         return;
    //     }

    //     const pdfBeforeFile = document.getElementById('pdfBeforeChange').files[0];
    //     const pdfAfterFile = document.getElementById('pdfAfterChange').files[0];

    //     if (!pdfBeforeFile && !pdfAfterFile) {
    //         showCustomAlert("Harap pilih setidaknya satu file PDF untuk diunggah.", "warning");
    //         return;
    //     }

    //     showGlobalLoading();
    //     try {
    //         const accessToken = await handleGoogleSignInForDrive();
    //         if (!accessToken) {
    //             throw new Error("Google Drive access not granted.");
    //         }

    //         const drive = gapi.client.drive;
    //         const updateData = {};

    //         // Find or create a dedicated folder for uploads
    //         const folderName = "Accurate Changes Documents";
    //         let folderId = await findOrCreateDriveFolder(folderName, accessToken);
    //         if (!folderId) {
    //             throw new Error("Failed to find or create Google Drive folder.");
    //         }

    //         if (pdfBeforeFile) {
    //             const fileName = `Sebelum Perubahan - ${documentNumber} - ${pdfBeforeFile.name}`;
    //             const fileLink = await uploadFileToDrive(pdfBeforeFile, fileName, folderId, accessToken);
    //             if (fileLink) {
    //                 updateData.pdfBeforeChangeLink = fileLink;
    //             }
    //         }

    //         if (pdfAfterFile) {
    //             const fileName = `Setelah Perubahan - ${documentNumber} - ${pdfAfterFile.name}`;
    //             const fileLink = await uploadFileToDrive(pdfAfterFile, fileName, folderId, accessToken);
    //             if (fileLink) {
    //                 updateData.pdfAfterChangeLink = fileLink;
    //             }
    //         }

    //         if (Object.keys(updateData).length > 0) {
    //             updateData.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
    //             await changesCollection.doc(changeId).update(updateData);
    //             showCustomAlert(`Dokumen untuk Nomor Dokumen ${documentNumber} berhasil diunggah!`, "success");
    //             closeDocumentUploadModal();
    //         } else {
    //             showCustomAlert("Tidak ada dokumen yang berhasil diunggah.", "warning");
    //         }

    //     } catch (error) {
    //         console.error("Error during document upload:", error);
    //         showCustomAlert(`Gagal mengunggah dokumen: ${error.message || 'Terjadi kesalahan.'}`, "error");
    //     } finally {
    //         hideGlobalLoading();
    //     }
    // }

    // async function findOrCreateDriveFolder(folderName, accessToken) {
    //     const drive = gapi.client.drive;

    //     // Search for the folder
    //     const response = await drive.files.list({
    //         q: `name='${folderName}' and mimeType='application/vnd.google-apps.folder' and trashed=false`,
    //         fields: 'files(id, name)',
    //         spaces: 'drive',
    //         access_token: accessToken
    //     });

    //     if (response.result.files.length > 0) {
    //         return response.result.files[0].id; // Folder found
    //     } else {
    //         // Create the folder if not found
    //         const fileMetadata = {
    //             'name': folderName,
    //             'mimeType': 'application/vnd.google-apps.folder'
    //         };
    //         const createResponse = await drive.files.create({
    //             resource: fileMetadata,
    //             fields: 'id',
    //             access_token: accessToken
    //         });
    //         return createResponse.result.id;
    //     }
    // }

    // async function uploadFileToDrive(file, fileName, parentFolderId, accessToken) {
    //     const drive = gapi.client.drive;

    //     const metadata = {
    //         name: fileName,
    //         mimeType: file.type,
    //         parents: [parentFolderId]
    //     };

    //     const form = new FormData();
    //     form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
    //     form.append('file', file);

    //     try {
    //         const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
    //             method: 'POST',
    //             headers: {
    //                 'Authorization': `Bearer ${accessToken}`
    //             },
    //             body: form
    //         });

    //         if (!response.ok) {
    //             const errorText = await response.text();
    //             throw new Error(`Google Drive API error: ${response.status} - ${errorText}`);
    //         }

    //         const result = await response.json();
    //         console.log('File uploaded:', result);

    //         // Get webViewLink for the uploaded file
    //         const fileDetails = await drive.files.get({
    //             fileId: result.id,
    //             fields: 'webViewLink',
    //             access_token: accessToken
    //         });
    //         return fileDetails.result.webViewLink;

    //     } catch (error) {
    //         console.error("Error uploading file to Google Drive:", error);
    //         throw error;
    //     }
    // }


    // ==================== EXPORT TO EXCEL FUNCTION ====================
    function exportToExcel() {
        showGlobalLoading();
        try {
            const data = [];
            const headers = [
                "No. Urut", "Tipe Dokumen", "Nomor Dokumen", "Tanggal Dokumen", "Deskripsi",
                "Nilai Harga Awal Perubahan", "Tanggal Perubahan", "Tipe Perubahan", "Deskripsi Perubahan", "Perubahan Nilai Harga",
                // Removed PDF Document Links headers
                // "PDF Dokumen Sebelum Perubahan Link", "PDF Dokumen Setelah Perubahan Link",
                "Created By", "Created At"
            ];
            data.push(headers);

            const currentChanges = changes.filter(change => {
                const searchTerm = document.getElementById('searchPOs').value.toLowerCase();
                const documentTypeFilter = document.getElementById('filterDocumentType').value;
                const changeTypeFilter = document.getElementById('filterChangeType').value;

                const matchesSearch =
                    (change.documentNumber && change.documentNumber.toLowerCase().includes(searchTerm)) ||
                    (change.description && change.description.toLowerCase().includes(searchTerm)) ||
                    (change.changeDescription && change.changeDescription.toLowerCase().includes(searchTerm));

                const matchesDocumentType =
                    documentTypeFilter === 'all' ||
                    (change.documentType && change.documentType === documentTypeFilter);

                const matchesChangeType =
                    changeTypeFilter === 'all' ||
                    (change.changeType && change.changeType === changeTypeFilter);

                return matchesSearch && matchesDocumentType && matchesChangeType;
            });

            currentChanges.forEach((change, index) => {
                const row = [
                    index + 1,
                    change.documentType || '',
                    change.documentNumber || '',
                    change.documentDate ? formatDate(change.documentDate) : '',
                    change.description || '',
                    change.initialPriceValue || '', // Raw number for Excel
                    change.changeDate ? formatDate(change.changeDate) : '',
                    change.changeType || '',
                    change.changeDescription || '',
                    change.changedPriceValue || '', // Raw number for Excel
                    // Removed PDF Document Links data
                    // change.pdfBeforeChangeLink || '',
                    // change.pdfAfterChangeLink || '',
                    change.createdBy || '',
                    change.createdAt ? formatDateTime(change.createdAt) : ''
                ];
                data.push(row);
            });

            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Monitoring Perubahan Accurate");

            const fileName = `Monitoring_Perubahan_Accurate_${new Date().toISOString().slice(0,10)}.xlsx`;
            XLSX.writeFile(wb, fileName);
            showCustomAlert("Data perubahan Accurate diekspor ke Excel berhasil!", "success");

        } catch (error) {
            console.error("Error exporting to Excel:", error);
            showCustomAlert("Gagal mengekspor data ke Excel.", "error");
        } finally {
            hideGlobalLoading();
        }
    }

    // ==================== INITIALIZATION ====================

    document.addEventListener('DOMContentLoaded', function() {
        initSortable();
        // Removed Google API client libraries loading
        // gapi.load('client', gapiLoaded);
        // google.accounts.oauth2.loadScript(gisLoaded);
    });
</script>
</body>
</html>
