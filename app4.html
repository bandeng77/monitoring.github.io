<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Monitoring - Genetek</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Library for Export Excel -->
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <!-- Appwrite SDK -->
    <script src="https://cdn.jsdelivr.net/npm/appwrite@11.0.0"></script>

    <style>
        /* New Color Palette */
        :root {
            --primary-blue: #3b82f6; /* Primary blue */
            --primary-dark-blue: #2563eb; /* Dark blue */
            --accent-teal: #14b8a6; /* Accent teal */
            --accent-green: #22c55e; /* Accent green */
            --text-dark: #1e293b; /* Dark text */
            --text-medium: #475569; /* Medium text */
            --text-light: #64748b; /* Light text */
            --bg-light: #f8fafc; /* Light background */
            --bg-medium: #e2e8f0; /* Medium background */
            --bg-soft: #f0f2f5; /* Very soft background */
            --border-color: #cbd5e1; /* Border color */
            --shadow-light: rgba(0, 0, 0, 0.05);
            --shadow-medium: rgba(0, 0, 0, 0.1);
            --shadow-strong: rgba(0, 0, 0, 0.2);
        }

        html, body {
            height: 100%; /* Important for fullscreen modal */
            width: 100%; /* Important for fullscreen modal */
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-soft);
            color: var(--text-medium);
            line-height: 1.6;
        }

        /* Header Styling */
        .header {
            background-color: #ffffff;
            border-radius: 1rem; /* More rounded */
            box-shadow: 0 8px 20px var(--shadow-light); /* Softer shadow */
            padding: 1.75rem 2rem;
            position: relative; /* For logout button placement */
        }
        .header h1 {
            color: var(--text-dark);
            font-size: 2.25rem; /* Larger */
            font-weight: 800;
        }
        .header .logout-btn-container {
            position: absolute;
            top: 1.75rem;
            right: 2rem;
        }
        .header button {
            font-weight: 600;
            border-radius: 0.65rem;
            padding: 0.75rem 1.25rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .header button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px var(--shadow-medium);
        }
        .header button.bg-blue-600 { background-color: var(--primary-blue); }
        .header button.bg-blue-600:hover { background-color: var(--primary-dark-blue); }
        .header button.bg-green-500 { background-color: var(--accent-green); } /* Using accent-green */
        .header button.bg-green-500:hover { background-color: #16a34a; } /* Darker green */
        .header button.bg-red-500 { background-color: #ef4444; }
        .header button.bg-red-500:hover { background-color: #dc2626; }
        .header button.bg-gray-500 { background-color: #6b7280; }
        .header button.bg-gray-500:hover { background-color: #4b5563; }
        .header button.bg-gray-200 { background-color: var(--bg-medium); color: var(--text-dark); }
        .header button.bg-gray-200:hover { background-color: var(--border-color); }

        /* Ripple Effect */
        .ripple {
            position: absolute;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.7);
            animation: ripple-animation 0.6s linear forwards;
            transform: scale(0);
            pointer-events: none;
        }
        @keyframes ripple-animation {
            from { transform: scale(0); opacity: 1; }
            to { transform: scale(4); opacity: 0; }
        }

        /* Input & Select Styling */
        input[type="text"], input[type="date"], input[type="number"], select, textarea {
            border: 1px solid var(--border-color);
            border-radius: 0.65rem;
            padding: 0.75rem 1rem;
            font-size: 0.95rem;
            color: var(--text-dark);
            transition: all 0.2s ease;
        }
        input:focus, select:focus, textarea:focus {
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
            outline: none;
        }

        /* Pipeline Stage */
        .pipeline-stage {
            min-height: 480px;
            max-height: 600px;
            transition: all 0.4s ease-out;
            border-radius: 1rem; /* More rounded */
            overflow: hidden;
            display: flex;
            flex-direction: column;
            background-color: #ffffff;
            box-shadow: 0 12px 30px var(--shadow-light); /* Deeper shadow */
            box-sizing: border-box;
        }
        .pipeline-stage-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--bg-medium);
            background-image: linear-gradient(to right, var(--primary-blue), var(--accent-teal)); /* Animation: Gradient on header */
            color: white; /* Animation: Text color for gradient contrast */
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); /* Animation: Shadow on header */
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
        }
        .pipeline-stage-header h3 {
            font-size: 1.2rem; /* Larger */
            font-weight: 700;
            color: white; /* Animation: Ensure title text remains white */
            flex-shrink: 0;
            text-align: center;
            width: 100%;
        }
        .pipeline-stage-content {
            flex-grow: 1;
            padding: 1.25rem; /* Larger padding */
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            min-height: 100px;
            height: 100%;
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-content: flex-start;
            background-image: linear-gradient(to bottom right, var(--bg-light), var(--bg-soft)); /* Animation: Soft gradient on content */
        }

        /* Deal Card */
        .deal-card {
            transition: transform 0.4s ease-out, opacity 0.4s ease-out, box-shadow 0.3s ease-out; /* Animation: Smoother transition */
            cursor: grab;
            position: relative;
            background-color: #ffffff;
            border: 1px solid var(--bg-medium);
            border-radius: 0.85rem; /* More rounded */
            padding: 1.1rem; /* Larger padding */
            margin-bottom: 0;
            box-shadow: 0 6px 15px var(--shadow-light); /* Clearer shadow */
            font-size: 0.875rem;
            width: calc(25% - 0.75rem); /* Adjusted for 4 columns */
            /* min-width: 220px; <-- Hapus baris ini */
            box-sizing: border-box;
            opacity: 0; /* Animation: Start invisible */
            transform: translateY(20px); /* Animation: Start slightly below */
            display: flex; /* Using flexbox for internal layout */
            flex-direction: column;
            justify-content: space-between;
        }
        .deal-card.show {
            opacity: 1;
            transform: translateY(0);
        }
        .deal-card:hover {
            transform: translateY(-7px) scale(1.02); /* Animation: More dramatic hover effect (lift and enlarge) */
            box-shadow: 0 15px 35px var(--shadow-medium); /* Stronger hover shadow */
        }
        .deal-card:active {
            cursor: grabbing;
        }
        .deal-card h3 {
            font-size: 1.05rem; /* Slightly larger font size */
            font-weight: 700;
            color: var(--text-dark);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: calc(100% - 60px);
            margin-bottom: 0.5rem; /* Space below title */
        }
        .deal-details {
            flex-grow: 1; /* Allow details to fill space */
            margin-bottom: 1rem; /* Space below details */
        }
        .deal-details p {
            font-size: 0.85rem; /* Slightly larger font size */
            margin-top: 0.3rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--text-medium);
            display: flex;
            align-items: center;
        }
        .deal-details p i {
            font-size: 0.8rem;
            color: var(--text-light);
            margin-right: 0.5rem; /* Space between icon and text */
            width: 1rem; /* Fixed width for icon */
            text-align: center;
        }
        .deal-actions {
            display: flex;
            justify-content: flex-end; /* Action buttons to the right */
            gap: 0.5rem; /* Space between action buttons */
        }
        .deal-actions button {
            padding: 0.3rem 0.6rem;
            font-size: 0.8rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease-out, transform 0.2s ease-out;
            color: var(--text-medium); /* Default icon color */
            background-color: var(--bg-light); /* Action button background */
            border: 1px solid var(--border-color);
        }
        .deal-actions button:hover {
            transform: translateY(-2px);
            background-color: var(--bg-medium);
        }
        .deal-actions button.text-blue-600:hover { color: var(--primary-blue); }
        .deal-actions button.text-green-600:hover { color: #22c55e; } /* Using accent-green */
        .deal-actions button.text-red-600:hover { color: #ef4444; }

        .deal-footer {
            margin-top: 1rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--bg-medium);
            display: flex; /* Add this for flexbox */
            justify-content: space-between; /* To place status on the left and actions on the right */
            align-items: center; /* To align vertically */
        }

        /* Scrollbar */
        .pipeline-stage-content::-webkit-scrollbar {
            width: 8px; /* Animation: Scrollbar width */
        }
        .pipeline-stage-content::-webkit-scrollbar-track {
            background: var(--bg-soft); /* Animation: Track color */
            border-radius: 10px;
        }
        .pipeline-stage-content::-webkit-scrollbar-thumb {
            background: var(--primary-blue); /* Animation: Thumb color */
            border-radius: 10px;
            border: 2px solid var(--bg-soft); /* Animation: Border for better appearance */
        }
        .pipeline-stage-content::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark-blue); /* Animation: Thumb color on hover */
        }

        /* Modals */
        /* Remove transition property to remove animation */
        .modal-content-enter-active, .modal-content-leave-active {
            /* transition: opacity 0.15s cubic-bezier(0.25, 0.8, 0.25, 1), transform 0.15s cubic-bezier(0.25, 0.8, 0.25, 1); */
        }
        #monitoringModalContent, #monitoringDetailModalContent, #deleteModalContent, #filterPanelContent, #successAlertModalContent, #uploadDocumentModalContent, #documentInfoModalContent {
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 20px 50px var(--shadow-strong);
            padding: 2.5rem;
        }

        /* Fullscreen PO Modal */
        #monitoringModalContent {
            width: 98vw; /* Almost fullscreen */
            height: 98vh; /* Almost fullscreen */
            max-width: 98vw; /* Ensure it doesn't exceed viewport */
            max-height: 98vh; /* Ensure it doesn't exceed viewport */
            border-radius: 1rem;
            box-shadow: 0 20px 50px var(--shadow-strong);
            display: flex;
            flex-direction: column;
            padding: 1rem; /* Adjust padding to not be too large */
        }
        #monitoringModalContent .monitoring-form-container {
            flex-grow: 1;
            overflow-y: auto; /* Scrollbar only inside the form if content is too long */
            padding-right: 0.5rem; /* Space for scrollbar */
        }
        #monitoringModalContent .monitoring-form-container::-webkit-scrollbar {
            width: 8px;
        }
        #monitoringModalContent .monitoring-form-container::-webkit-scrollbar-track {
            background: var(--bg-soft);
            border-radius: 10px;
        }
        #monitoringModalContent .monitoring-form-container::-webkit-scrollbar-thumb {
            background: var(--primary-blue);
            border-radius: 10px;
            border: 2px solid var(--bg-soft);
        }
        #monitoringModalContent .monitoring-form-container::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark-blue);
        }


        #monitoringModalContent h2, #monitoringDetailModalContent h2, #deleteModalContent h2, #filterPanelContent h2, #successAlertModalContent h2, #uploadDocumentModalContent h2, #documentInfoModalContent h2 {
            color: var(--text-dark);
            font-weight: 800;
            font-size: 1.75rem; /* Smaller */
            margin-bottom: 1rem; /* Smaller */
        }
        #monitoringForm label, #uploadDocumentForm label {
            color: var(--text-dark);
            font-weight: 600;
            font-size: 0.75rem; /* Smaller */
            margin-bottom: 0.25rem; /* Smaller */
        }
        #monitoringForm input, #monitoringForm select, #monitoringForm textarea, #uploadDocumentForm input, #uploadDocumentForm select, #uploadDocumentForm textarea {
            border-radius: 0.5rem;
            padding: 0.5rem 0.75rem; /* Smaller */
            font-size: 0.85rem; /* Smaller */
        }
        #monitoringForm textarea, #uploadDocumentForm textarea { height: 80px; } /* Slightly shorter */

        /* Detail Grid */
        #monitoringDetailModalContent .detail-grid {
            display: grid; /* Ensure this is a grid */
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); /* Tighter */
            gap: 1rem;
        }
        /* Modification for 3 columns on PO details */
        @media (min-width: 768px) { /* For tablets and desktops */
            #monitoringDetailModalContent .detail-grid {
                grid-template-columns: repeat(3, 1fr); /* 3 columns */
            }
        }
        /* Modification for 4 columns on PO details */
        @media (min-width: 1024px) { /* For desktops */
            #monitoringDetailModalContent .detail-grid {
                grid-template-columns: repeat(4, 1fr); /* 4 columns */
            }
        }
        #monitoringDetailModalContent .detail-item p { /* Combine these two rules */
            color: #000000; /* Set to black */
            font-size: 0.9rem; /* Desired font size */
            font-weight: 500;
        }
        #monitoringDetailModalContent .detail-item p:first-child {
            color: #000000; /* Set to black for labels as well */
            font-weight: 600; /* Make labels slightly bolder */
        }
        #monitoringDetailModalContent .detail-item ul,
        #monitoringDetailModalContent .detail-item li {
            font-size: 0.9rem; /* Match other detail font sizes */
            color: #000000; /* Set to black */
            font-weight: 500; /* Match other detail text weight */
        }

        /* Additional rules for dynamic content within the detail modal */
        #detailDocumentChecklist p,
        #detailDocumentChecklist span,
        #detailItemsList p,
        #detailItemsList span {
            color: #000000 !important; /* Ensure black for these sections, use !important if needed to override Tailwind */
        }

        /* Loading Spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--primary-blue);
            border-radius: 50%;
            width: 40px; /* Larger */
            height: 40px;
            animation: spin 1s linear infinite;
        }
        /* Global Loading Overlay */
        #global-loading-overlay.show {
            display: flex; /* Ensure overlay is visible when 'show' */
        }

        /* Empty State */
        .empty-state {
            color: var(--text-light);
            text-align: center;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
        }
        .empty-state i {
            font-size: 3rem;
            color: var(--bg-medium);
            margin-bottom: 1rem;
        }
        .empty-state p {
            font-size: 1rem;
            color: var(--text-light);
        }

        /* PO Card Number */
        .monitoring-card-number {
            position: absolute;
            top: 0.6rem;
            right: 0.6rem; /* Move to top right */
            left: unset; /* Ensure no conflicting left property */
            font-size: 0.8rem; /* Slightly larger */
            font-weight: 700;
            color: var(--text-dark); /* Darker text color */
            background-color: var(--bg-medium);
            padding: 0.15rem 0.5rem;
            border-radius: 0.35rem;
            z-index: 10; /* Ensure on top of other content */
        }

        /* Status Colors - Adjusted to match button colors */
        .status-on-order { background-color: var(--primary-blue); color: white; } /* Primary blue */
        .status-waiting { background-color: #facc15; color: #333; } /* Yellow */
        .status-picked-up { background-color: var(--accent-green); color: white; } /* Accent green */
        .status-on-delivery { background-color: #a78bfa; color: white; } /* Purple */
        .status-delivered { background-color: #10b981; color: white; } /* Emerald green */
        .status-partial-delivered { background-color: #fbbf24; color: #333; } /* Amber */
        .status-delayed { background-color: #ef4444; color: white; } /* Red */
        .status-on-hold { background-color: #9ca3af; color: white; } /* Gray */

        /* Styling for status dropdown in deal-card */
        .status-dropdown {
            appearance: none; /* Remove default browser styling */
            background-color: var(--primary-blue);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            min-width: 100px; /* To prevent it from being too small */
            max-width: 120px;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            position: relative;
            padding-right: 1.5rem; /* Space for arrow icon */
        }
        .status-dropdown:hover {
            background-color: var(--primary-blue);
        }
        .status-dropdown:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        /* Custom arrow for dropdown */
        .status-dropdown::after {
            content: '\f078'; /* FontAwesome chevron-down icon */
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: var(--text-medium);
        }

        /* Media Queries for responsiveness */
        /* Media queries for .deal-card have been removed to force 4 columns and allow shrinking */

        @media (max-width: 1024px) { /* For tablets, 2 columns */
            /* Adjust main PO form grid columns for tablets */
            #monitoringModalContent .grid.grid-cols-1.sm\:grid-cols-2.md\:grid-cols-3.lg\:grid-cols-4 > div {
                grid-column: span 1; /* Default 1 column */
            }
            @media (min-width: 640px) { /* sm breakpoint */
                #monitoringModalContent .grid.grid-cols-1.sm\:grid-cols-2.md\:grid-cols-3.lg\:grid-cols-4 > div {
                    grid-column: span 1; /* 2 columns */
                }
            }
            @media (min-width: 768px) { /* md breakpoint */
                #monitoringModalContent .grid.grid-cols-1.sm\:grid-cols-2.md\:grid-cols-3.lg\:grid-cols-4 > div {
                    grid-column: span 1; /* 3 columns */
                }
            }
        }

        @media (max-width: 768px) { /* For mobile, 1 column */
            .max-w-7xl {
                padding-left: 1rem;
                padding-right: 1rem;
            }
            .header {
                flex-direction: column;
                align-items: flex-start;
                padding: 1.25rem 1.5rem;
            }
            .header h1 {
                font-size: 1.75rem;
            }
            .header .logout-btn-container {
                position: static; /* Revert to normal position on mobile */
                margin-top: 1rem;
                width: 100%;
            }
            .header > div:last-child { /* This is the div containing buttons below the title */
                margin-top: 1rem;
                width: 100%;
                flex-direction: column;
                align-items: stretch;
                gap: 0.75rem;
            }
            .header button {
                width: 100%;
                justify-content: center;
                padding: 0.65rem 1rem;
                font-size: 0.9rem;
            }
            .header .flex-col.sm\:flex-row {
                flex-direction: column;
            }
            .header .sm\:w-1\/2 {
                width: 100%;
            }
            #monitoringModalContent {
                padding: 1rem; /* Smaller padding for mobile */
            }
            #monitoringModalContent h2 {
                font-size: 1.5rem;
            }
            /* Adjust main PO form grid columns for mobile */
            #monitoringModalContent .grid.grid-cols-1.sm\:grid-cols-2.md\:grid-cols-3.lg\:grid-cols-4 > div {
                grid-column: span 1; /* 1 column */
            }
        }

        /* Styling for search dropdown */
        .autocomplete-items {
            position: absolute;
            border: 1px solid #d4d4d4;
            border-bottom: none;
            border-top: none;
            z-index: 99;
            /*position the autocomplete items to be the same width as the container:*/
            top: 100%;
            left: 0;
            right: 0;
            max-height: 200px; /* Limit dropdown height */
            overflow-y: auto; /* Add scroll if too many items */
            background-color: #fff; /* Ensure white background */
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); /* Add shadow for better visibility */
            border-radius: 0 0 0.5rem 0.5rem; /* Rounded bottom corners */
        }

        .autocomplete-items div {
            padding: 10px;
            cursor: pointer;
            background-color: #fff;
            border-bottom: 1px solid #d4d4d4;
        }

        .autocomplete-items div:hover {
            /*when hovering an item:*/
            background-color: #e9e9e9;
        }

        .autocomplete-active {
            /*when navigating through the items using the arrow keys:*/
            background-color: DodgerBlue !important;
            color: #ffffff;
        }

        /* Custom styles for item rows */
        .item-row-container {
            display: flex;
            flex-direction: column;
            gap: 0.75rem; /* Space between item rows, tighter */
            margin-top: 1rem; /* Add top margin to prevent being too close */
            padding-top: 1rem; /* Add top padding */
            border-top: 1px solid var(--border-color); /* Add separator line */
        }

        .item-row {
            display: grid;
            /* Default for mobile: 1 column */
            grid-template-columns: 1fr;
            gap: 0.4rem; /* Space between inputs in a row, tighter */
            align-items: end; /* Align items at the bottom */
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 0.6rem; /* Smaller */
            background-color: var(--bg-light);
        }

        /* For larger screens, adjust item-row columns */
        @media (min-width: 640px) { /* sm breakpoint */
            .item-row {
                /* PID (1.5fr), Description (3fr), Qty (0.8fr), COO (1.2fr), HS Code (1.5fr), Revised HS Code (1.5fr), Actions (0.5fr) */
                grid-template-columns: 1.5fr 3fr 0.8fr 1.2fr 1.5fr 1.5fr 0.5fr;
            }
        }
        @media (min-width: 1024px) { /* lg breakpoint */
            .item-row {
                /* PID (1.5fr), Description (3fr), Qty (0.8fr), COO (1.2fr), HS Code (1.5fr), Revised HS Code (1.5fr), Actions (0.5fr) */
                grid-template-columns: 1.5fr 3fr 0.8fr 1.2fr 1.5fr 1.5fr 0.5fr;
            }
        }


        .item-row > div {
            display: flex;
            flex-direction: column;
        }

        .item-row .item-action-buttons {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 0.5rem;
        }

        /* Checkmark icon for uploaded documents */
        .document-uploaded-checkmark {
            color: var(--accent-green); /* Green color for checkmark */
            font-size: 1.2rem; /* Slightly larger icon */
            margin-right: 0.5rem; /* Space between checkmark and action buttons */
        }

        /* New container for status/checkmark on the left side of the footer */
        .deal-footer-left {
            display: flex;
            align-items: center;
            gap: 0.5rem; /* Space between elements in the left footer */
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <div class="max-w-7xl mx-auto px-4 py-8">
        <!-- Header -->
        <header class="mb-8 bg-white p-6 rounded-lg shadow-md header">
            <div class="flex justify-between items-start">
                <div>
                    <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-900">Document Monitoring <i class="fas fa-box-open text-blue-600 ml-2"></i></h1>
                </div>
                <div class="logout-btn-container flex space-x-2">
                    <button id="authButton" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg shadow-md transition duration-200 ease-in-out transform hover:scale-105 flex items-center text-sm">
                        <i class="fas fa-sign-out-alt mr-2"></i> Logout
                    </button>
                </div>
            </div>

            <!-- Buttons below title -->
            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4 mt-4">
                <button id="addMonitoringBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow-md transition duration-200 ease-in-out transform hover:scale-105 flex items-center text-sm">
                    <i class="fas fa-plus-circle mr-2"></i> Add Monitoring
                </button>

                <button id="uploadDocumentBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg shadow-md transition duration-200 ease-in-out transform hover:scale-105 flex items-center text-sm">
                    <i class="fas fa-upload mr-2"></i> Upload Document
                </button>

                <button id="exportExcelBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg shadow-md transition duration-200 ease-in-out transform hover:scale-105 flex items-center text-sm">
                    <i class="fas fa-file-excel mr-2"></i> Export Excel
                </button>

                <button id="backButton" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg shadow-md transition duration-200 ease-in-out transform hover:scale-105 flex items-center text-sm">
                    <i class="fas fa-arrow-left mr-2"></i> Back
                </button>
            </div>

            <!-- Combined Filter Section -->
            <div class="mt-6 flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4 items-center">
                <input type="text" id="searchMonitorings" placeholder="Search by document type, number, description..." class="w-full sm:w-1/2 p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">

                <button id="openFilterPanelBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg shadow-md transition duration-200 ease-in-out transform hover:scale-105 flex items-center text-sm">
                    <i class="fas fa-filter mr-2"></i> Filter
                </button>
            </div>
        </header>

        <!-- Pipeline Visualization -->
        <div class="grid grid-cols-1 gap-6 mb-10">
            <div class="pipeline-stage stage-main-pipeline">
                <div class="pipeline-stage-header">
                    <h3>Monitoring List</h3>
                </div>
                <div id="monitorings-stage" class="pipeline-stage-content">
                    <!-- Your content goes here -->
                    <div class="empty-state">
                        <i class="fas fa-box-open"></i>
                        <p>No Monitoring entries to display.</p>
                        <p>Start by adding a new monitoring entry or adjusting your filters.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add/Edit Monitoring Modal -->
        <div id="monitoringModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
            <div class="bg-white rounded-none p-8 w-full h-full shadow-2xl modal-content-enter" id="monitoringModalContent">
                <h2 class="text-xl sm:text-2xl font-bold mb-4 text-gray-900" id="modalTitle">Add New Monitoring</h2>
                <form id="monitoringForm" class="monitoring-form-container">
                    <input type="hidden" id="monitoringId">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                        <!-- Column 1: Document Details -->
                        <div>
                            <h3 class="text-lg font-bold text-gray-900 mb-3">Document Details</h3>
                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-semibold mb-1" for="documentType">Document Type <span class="text-red-500">*</span></label>
                                <input type="text" id="documentType" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm" required>
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-semibold mb-1" for="documentNumber">Document Number <span class="text-red-500">*</span></label>
                                <input type="text" id="documentNumber" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm" required>
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-semibold mb-1" for="documentDate">Document Date</label>
                                <input type="date" id="documentDate" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-semibold mb-1" for="documentDescription">Description</label>
                                <textarea id="documentDescription" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm" rows="4" placeholder="Document description..."></textarea>
                            </div>
                        </div>
                        <!-- Column 2: Value and Changes -->
                        <div>
                            <h3 class="text-lg font-bold text-gray-900 mb-3">Value & Changes</h3>
                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-semibold mb-1" for="initialValue">Initial Price Value (Rp)</label>
                                <input type="text" id="initialValue" class="currency-input w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm" placeholder="Rp 0">
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-semibold mb-1" for="changeDate">Change Date</label>
                                <input type="date" id="changeDate" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-semibold mb-1" for="changeDescription">Change Description</label>
                                <textarea id="changeDescription" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm" rows="4" placeholder="Description of change..."></textarea>
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-semibold mb-1" for="changedValue">Changed Price Value (Rp)</label>
                                <input type="text" id="changedValue" class="currency-input w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm" placeholder="Rp 0">
                            </div>
                            <!-- NEW: Changed By Dropdown -->
                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-semibold mb-1" for="changedBy">Changed By</label>
                                <select id="changedBy" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                                    <option value="">Select Person</option>
                                    <option value="Rossiana">Rossiana</option>
                                    <option value="Maya">Maya</option>
                                    <option value="Evi">Evi</option>
                                    <option value="Maida">Maida</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" id="cancelMonitoringBtn" class="px-4 py-2 text-gray-600 hover:text-gray-800 font-medium rounded-lg transition duration-200 text-sm">
                            Cancel
                        </button>
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow-md font-medium transition duration-200 ease-in-out transform hover:scale-105 text-sm">
                            Save Monitoring
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Monitoring Detail Modal -->
        <div id="monitoringDetailModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
            <div class="bg-white rounded-xl p-8 w-full max-w-5xl shadow-2xl modal-content-enter overflow-y-auto" id="monitoringDetailModalContent">
                <h2 class="text-xl sm:text-2xl font-bold mb-6 text-gray-900" id="monitoringDetailTitle">Monitoring Details</h2>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Left Column: Main Monitoring Details -->
                    <div>
                        <h3 class="text-lg font-bold text-gray-900 mb-4">Document Information</h3>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <p class="font-semibold">Document Type:</p>
                                <p id="detailDocumentType">-</p>
                            </div>
                            <div class="detail-item">
                                <p class="font-semibold">Document Number:</p>
                                <p id="detailDocumentNumber">-</p>
                            </div>
                            <div class="detail-item">
                                <p class="font-semibold">Document Date:</p>
                                <p id="detailDocumentDate">-</p>
                            </div>
                            <div class="detail-item col-span-full">
                                <p class="font-semibold">Description:</p>
                                <p id="detailDocumentDescription">-</p>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Value and Changes -->
                    <div>
                        <h3 class="text-lg font-bold text-gray-900 mb-4">Value & Changes</h3>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <p class="font-semibold">Initial Price Value:</p>
                                <p id="detailInitialValue">-</p>
                            </div>
                            <div class="detail-item">
                                <p class="font-semibold">Change Date:</p>
                                <p id="detailChangeDate">-</p>
                            </div>
                            <div class="detail-item col-span-full">
                                <p class="font-semibold">Change Description:</p>
                                <p id="detailChangeDescription">-</p>
                            </div>
                            <div class="detail-item">
                                <p class="font-semibold">Changed Price Value:</p>
                                <p id="detailChangedValue">-</p>
                            </div>
                            <!-- NEW: Changed By Detail -->
                            <div class="detail-item">
                                <p class="font-semibold">Changed By:</p>
                                <p id="detailChangedBy">-</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" id="closeMonitoringDetailBtn" class="px-4 py-2 text-gray-600 hover:text-gray-800 font-medium rounded-lg transition duration-200 text-sm">
                        Close
                    </button>
                </div>
            </div>
        </div>

        <!-- Delete Confirmation Modal -->
        <div id="deleteModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
            <div class="bg-white rounded-xl p-8 w-full max-w-sm shadow-2xl modal-content-enter" id="deleteModalContent">
                <h2 class="text-xl font-bold mb-4 text-gray-900">Delete Confirmation</h2>
                <p class="text-gray-700 mb-6 text-sm">Are you sure you want to delete "<span id="dealToDeleteName" class="font-semibold"></span>"? This action cannot be undone.</p>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancelDeleteBtn" class="px-4 py-2 text-gray-600 hover:text-gray-800 font-medium rounded-lg transition duration-200 text-sm">
                        Cancel
                    </button>
                    <button type="button" id="confirmDeleteBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg shadow-md font-medium transition duration-200 ease-in-out transform hover:scale-105 text-sm">
                        Delete
                    </button>
                </div>
            </div>
        </div>

        <!-- Filter Panel Modal -->
        <div id="filterPanel" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
            <div class="bg-white rounded-xl p-8 w-full max-w-2xl shadow-2xl modal-content-enter" id="filterPanelContent">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-900 flex items-center"><i class="fas fa-filter mr-3 text-gray-500"></i> Filter Monitorings</h2>
                    <button type="button" id="closeFilterPanelBtn" class="text-gray-500 hover:text-gray-700 transition duration-200">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Filter: Document Type -->
                    <div>
                        <label class="block text-gray-700 text-sm font-semibold mb-2" for="filterDocumentType">Document Type</label>
                        <select id="filterDocumentType" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                            <option value="all">All Document Types</option>
                            <!-- Options will be dynamically loaded from Firebase -->
                        </select>
                    </div>
                    <!-- Filter: Document Number -->
                    <div>
                        <label class="block text-gray-700 text-sm font-semibold mb-2" for="filterDocumentNumber">Document Number</label>
                        <select id="filterDocumentNumber" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                            <option value="all">All Document Numbers</option>
                            <!-- Options will be dynamically loaded from Firebase -->
                        </select>
                    </div>
                    <!-- Filter: Date Range (Example) -->
                    <div>
                        <label class="block text-gray-700 text-sm font-semibold mb-2" for="filterStartDate">From Date</label>
                        <input type="date" id="filterStartDate" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-semibold mb-2" for="filterEndDate">To Date</label>
                        <input type="date" id="filterEndDate" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                    </div>
                    <!-- NEW: Filter Changed By -->
                    <div>
                        <label class="block text-gray-700 text-sm font-semibold mb-2" for="filterChangedBy">Changed By</label>
                        <select id="filterChangedBy" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                            <option value="all">All Persons</option>
                            <option value="Rossiana">Rossiana</option>
                            <option value="Maya">Maya</option>
                            <option value="Evi">Evi</option>
                            <option value="Maida">Maida</option>
                        </select>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" id="resetFiltersBtn" class="px-4 py-2 text-gray-600 hover:text-gray-800 font-medium rounded-lg transition duration-200 text-sm">
                        Reset Filters
                    </button>
                    <button type="button" id="applyFiltersBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow-md font-medium transition duration-200 ease-in-out transform hover:scale-105 text-sm">
                        Apply Filters
                    </button>
                </div>
            </div>
        </div>

        <!-- Upload Document Modal (Simplified) -->
        <div id="uploadDocumentModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
            <div class="bg-white rounded-xl p-8 w-full max-w-md shadow-2xl modal-content-enter" id="uploadDocumentModalContent">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-900 flex items-center"><i class="fas fa-upload mr-3 text-gray-500"></i> Upload Document</h2>
                    <button type="button" class="text-gray-500 hover:text-gray-700 transition duration-200" id="closeUploadDocumentModalBtn">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <form id="uploadDocumentForm">
                    <!-- Document Number Search for Upload Document -->
                    <div class="mb-6 border-b pb-4 border-gray-200">
                        <label class="block text-gray-700 text-sm font-semibold mb-2" for="uploadDoc_documentNumberSearch">Search Document Number</label>
                        <div class="relative">
                            <input type="text" id="uploadDoc_documentNumberSearch" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm" placeholder="Type Document Number...">
                            <input type="hidden" id="uploadDoc_monitoringId" value="">
                            <div id="uploadDoc_documentNumberSuggestions" class="autocomplete-items suggestions-list"></div>
                        </div>
                        <p id="selectedMonitoringInfo" class="text-sm text-gray-600 mt-2 hidden">Selected Document: <span class="font-medium" id="selectedDocumentNumberDisplay"></span></p>
                    </div>

                    <!-- Document Upload 1 -->
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-semibold mb-2" for="uploadDoc_document1">Document Before Change</label>
                        <input type="file" id="uploadDoc_document1" accept=".pdf" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                        <p id="document1FileName" class="text-sm text-gray-600 mt-1 hidden"></p>
                        <!-- <a id="document1DownloadLink" href="#" target="_blank" class="text-blue-600 hover:underline text-sm mt-1 hidden">View Document 1</a> -->
                    </div>

                    <!-- Document Upload 2 -->
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-semibold mb-2" for="uploadDoc_document2">Document After Change</label>
                        <input type="file" id="uploadDoc_document2" accept=".pdf" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm">
                        <p id="document2FileName" class="text-sm text-gray-600 mt-1 hidden"></p>
                        <!-- <a id="document2DownloadLink" href="#" target="_blank" class="text-blue-600 hover:underline text-sm mt-1 hidden">View Document 2</a> -->
                    </div>

                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" class="px-4 py-2 text-gray-600 hover:text-gray-800 font-medium rounded-lg transition duration-200 text-sm" id="cancelUploadDocumentBtn">
                            Cancel
                        </button>
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow-md font-medium transition duration-200 ease-in-out transform hover:scale-105 text-sm">
                            Save Document Status
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Success Alert Modal -->
        <div id="successAlertModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
            <div class="bg-white rounded-xl p-8 w-full max-w-sm text-center shadow-2xl modal-content-enter" id="successAlertModalContent">
                <div class="text-green-500 text-6xl mb-4">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h2 class="text-2xl font-bold mb-4 text-gray-900">Success!</h2>
                <p class="text-gray-700 mb-6" id="successAlertMessage">Operation completed successfully.</p>
                <button type="button" id="closeSuccessAlertBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg shadow-md font-medium transition duration-200 ease-in-out transform hover:scale-105">
                    OK
                </button>
            </div>
        </div>

        <!-- Global Loading Overlay -->
        <div id="global-loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-[9999] hidden">
            <div class="spinner"></div>
        </div>

        <!-- Document Info Modal (NEW) -->
        <div id="documentInfoModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
            <div class="bg-white rounded-xl p-8 w-full max-w-md shadow-2xl modal-content-enter" id="documentInfoModalContent">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-900 flex items-center"><i class="fas fa-info-circle mr-3 text-gray-500"></i> Document Information</h2>
                    <button type="button" class="text-gray-500 hover:text-gray-700 transition duration-200" id="closeDocumentInfoModalBtn">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div id="documentInfoContent" class="space-y-3">
                    <p><span class="font-semibold">Document Number:</span> <span id="docInfo_documentNumber"></span></p>
                    <p><span class="font-semibold">Document Before Change:</span> <span id="docInfo_doc1Name">None</span></p>
                    <p><span class="font-semibold">Document After Change:</span> <span id="docInfo_doc2Name">None</span></p>
                </div>
                <div class="flex justify-end mt-6">
                    <button type="button" id="closeDocumentInfoBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow-md font-medium transition duration-200 ease-in-out transform hover:scale-105 text-sm">
                        OK
                    </button>
                </div>
            </div>
        </div>

    </div>

<script>
    // Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyDWgxJfYKksEoeUF2rK67rAH-arejKawJM",
        authDomain: "monitoring-acc.firebaseapp.com",
        projectId: "monitoring-acc",
        storageBucket: "monitoring-acc.firebasestorage.app",
        messagingSenderId: "898707897888",
        appId: "1:898707897888:web:8cfe6f77cd784d8c1ec645"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const monitoringsCollection = db.collection('monitorings');
    const purchaseOrdersCollection = db.collection('purchaseOrders'); // Assuming you have a 'purchaseOrders' collection
    const documentUploadsCollection = db.collection('documentUploads'); // New collection for document upload status
    // const activitiesCollection = db.collection('activities'); // NEW: Collection for user activities - REMOVED

    // Appwrite Configuration
    const client = new Appwrite.Client();
    client
        .setEndpoint('https://fra.cloud.appwrite.io/v1') // *** CORRECTED: Using the correct endpoint ***
        .setProject('68d0d6eb001dc06a95b3'); // Your Project ID

    const storage = new Appwrite.Storage(client);
    const database = new Appwrite.Databases(client); // If you plan to use Appwrite Database for document metadata
    const APPWRITE_DATABASE_ID = '68d0d71600124cfdc86e'; // This is not used in this code, but it's fine

    // Appwrite Hardcoded Config
    const APPWRITE_ENDPOINT = "https://fra.cloud.appwrite.io/v1"; // Original Appwrite endpoint
    const PROJECT_ID = '68d0d6eb001dc06a95b3'; // Use your project ID
    const APPWRITE_BUCKET_ID = '68d0d72500025b188805';


    document.addEventListener('DOMContentLoaded', function() {
        // --- User Authentication (Simulated) ---
        // In a real application, you would use Firebase Authentication or Appwrite Auth
        // For this example, we'll simulate a logged-in user with a fixed email.
        // IMPORTANT: Replace 'user@example.com' with the actual logged-in user's email
        // obtained from your authentication system (e.g., Firebase Auth, Appwrite Auth).
        let currentUserEmail = 'user@example.com'; // Default simulated user

        // Function to get current user email (simulated)
        function getCurrentUserEmail() {
            // In a real app, this would return the actual logged-in user's email
            // For now, we'll use the simulated one.
            return currentUserEmail;
        }

        // --- Activity Logging Function (NEW) ---
        // REMOVED: logActivity function and all its calls

        // --- Generic function to toggle modal visibility ---
        function toggleModal(modalId, show) {
            const modal = document.getElementById(modalId);
            if (modal) {
                if (show) {
                    modal.classList.remove('hidden');
                    // Optional: Add a class to body to prevent scrolling when modal is open
                    document.body.classList.add('overflow-hidden');
                } else {
                    modal.classList.add('hidden');
                    // Optional: Remove the class from body
                    document.body.classList.remove('overflow-hidden');
                    // Hide autocomplete suggestions if any modal is closed
                    const suggestions = document.getElementById('uploadDoc_documentNumberSuggestions');
                    if (suggestions) suggestions.innerHTML = '';
                }
            }
        }

        // --- Currency Formatting Functions ---
        function formatRupiah(angka, prefix) {
            if (angka === null || angka === undefined || isNaN(angka)) return ''; // Handle null, undefined, NaN
            let number_string = angka.toString().replace(/[^,\d]/g, ''),
                split = number_string.split(','),
                sisa = split[0].length % 3,
                rupiah = split[0].substr(0, sisa),
                ribuan = split[0].substr(sisa).match(/\d{3}/gi);

            if (ribuan) {
                let separator = sisa ? '.' : '';
                rupiah += separator + ribuan.join('.');
            }

            rupiah = split[1] !== undefined ? rupiah + ',' + split[1] : rupiah;
            return prefix === undefined ? rupiah : (rupiah ? 'Rp ' + rupiah : '');
        }

        function unformatRupiah(rupiah) {
            if (!rupiah) return 0;
            // Remove "Rp ", dots, and replace comma with dot for proper parsing
            const cleaned = rupiah.replace('Rp ', '').replace(/\./g, '').replace(/,/g, '.');
            return parseFloat(cleaned) || 0; // Use parseFloat for decimal values if needed, otherwise parseInt
        }

        // Apply currency formatting to inputs
        document.querySelectorAll('.currency-input').forEach(input => {
            input.addEventListener('keyup', function(e) {
                this.value = formatRupiah(unformatRupiah(this.value), 'Rp ');
            });
            input.addEventListener('blur', function() {
                if (this.value === 'Rp ' || this.value === '') {
                    this.value = '';
                } else {
                    this.value = formatRupiah(unformatRupiah(this.value), 'Rp ');
                }
            });
            // Initial format if there's a value on load
            if (input.value) {
                input.value = formatRupiah(unformatRupiah(input.value), 'Rp ');
            }
        });

        // --- Event Listeners for Modals ---

        // Add Monitoring Button
        document.getElementById('addMonitoringBtn').addEventListener('click', () => {
            document.getElementById('modalTitle').textContent = 'Add New Monitoring';
            document.getElementById('monitoringId').value = ''; // Clear ID for new entry
            document.getElementById('monitoringForm').reset(); // Clear form fields
            toggleModal('monitoringModal', true);
            // logActivity('Opened "Add New Monitoring" form'); // REMOVED
        });

        // Close Add/Edit Monitoring Modal (using new ID for cancel button)
        document.getElementById('cancelMonitoringBtn').addEventListener('click', () => toggleModal('monitoringModal', false));

        // Submit Monitoring Form
        document.getElementById('monitoringForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            showGlobalLoading();

            const monitoringId = document.getElementById('monitoringId').value;
            const documentNumber = document.getElementById('documentNumber').value; // Get document number for logging
            const data = {
                documentType: document.getElementById('documentType').value,
                documentNumber: documentNumber,
                documentDate: document.getElementById('documentDate').value,
                documentDescription: document.getElementById('documentDescription').value,
                initialValue: unformatRupiah(document.getElementById('initialValue').value),
                changeDate: document.getElementById('changeDate').value,
                changeDescription: document.getElementById('changeDescription').value,
                changedValue: unformatRupiah(document.getElementById('changedValue').value),
                changedBy: document.getElementById('changedBy').value, // NEW: Get Changed By value
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                if (monitoringId) {
                    // Update existing monitoring
                    await monitoringsCollection.doc(monitoringId).update(data);
                    document.getElementById('successAlertMessage').textContent = 'Monitoring updated successfully!';
                    // logActivity(`Updated monitoring for document number: ${documentNumber}`, monitoringId, documentNumber); // REMOVED
                } else {
                    // Add new monitoring
                    const newDocRef = await monitoringsCollection.add(data);
                    document.getElementById('successAlertMessage').textContent = 'New monitoring added successfully!';
                    // logActivity(`Added new monitoring for document number: ${documentNumber}`, newDocRef.id, documentNumber); // REMOVED
                }
                toggleModal('monitoringModal', false);
                toggleModal('successAlertModal', true);
                loadMonitorings(); // Reload list after save
                fetchAllDocumentNumbers(); // Re-fetch document numbers for autocomplete
            } catch (error) {
                console.error("Error saving monitoring: ", error);
                alert("Failed to save monitoring. Please try again.");
            } finally {
                hideGlobalLoading();
            }
        });

        // Upload Document Button (formerly Document Checklist)
        document.getElementById('uploadDocumentBtn').addEventListener('click', () => {
            document.getElementById('uploadDocumentForm').reset();
            document.getElementById('uploadDoc_monitoringId').value = ''; // Clear monitoringId
            document.getElementById('selectedMonitoringInfo').classList.add('hidden');
            document.getElementById('uploadDoc_documentNumberSuggestions').innerHTML = '';
            // Clear file inputs and their display
            document.getElementById('uploadDoc_document1').value = '';
            document.getElementById('document1FileName').classList.add('hidden');
            // document.getElementById('document1DownloadLink').classList.add('hidden'); // REMOVED
            // document.getElementById('document1DownloadLink').removeAttribute('href'); // REMOVED

            document.getElementById('uploadDoc_document2').value = '';
            document.getElementById('document2FileName').classList.add('hidden');
            // document.getElementById('document2DownloadLink').classList.add('hidden'); // REMOVED
            // document.getElementById('document2DownloadLink').removeAttribute('href'); // REMOVED

            toggleModal('uploadDocumentModal', true);
            // logActivity('Opened "Upload Document" form'); // REMOVED
        });

        // Close Upload Document Modal
        document.getElementById('closeUploadDocumentModalBtn').addEventListener('click', () => toggleModal('uploadDocumentModal', false));
        document.getElementById('cancelUploadDocumentBtn').addEventListener('click', () => toggleModal('uploadDocumentModal', false));

        // Upload Document Form Submission
        document.getElementById('uploadDocumentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            showGlobalLoading();

            const monitoringId = document.getElementById('uploadDoc_monitoringId').value;
            const documentNumber = document.getElementById('uploadDoc_documentNumberSearch').value;
            const document1File = document.getElementById('uploadDoc_document1').files[0];
            const document2File = document.getElementById('uploadDoc_document2').files[0];

            if (!monitoringId) {
                alert('Please select a valid Document Number from the suggestions.');
                hideGlobalLoading();
                return;
            }

            if (!document1File && !document2File) {
                alert('Please upload at least one document.');
                hideGlobalLoading();
                return;
            }

            let document1FileId = '';
            let document2FileId = '';
            let document1Url = '';
            let document2Url = '';

            try {
                const updateData = {
                    documentNumber: documentNumber,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                // Upload Document 1 to Appwrite Storage
                if (document1File) {
                    const file1Response = await storage.createFile(
                        APPWRITE_BUCKET_ID,
                        Appwrite.ID.unique(), // Generate a unique ID for the file
                        document1File,
                        [Appwrite.Permission.read(Appwrite.Role.any())] // public permission
                    );
                    document1FileId = file1Response.$id;
                    document1Url = APPWRITE_ENDPOINT + '/storage/buckets/' + APPWRITE_BUCKET_ID + '/files/' + document1FileId + '/view?project=' + PROJECT_ID;
                    updateData.document1FileId = document1FileId;
                    updateData.document1FileName = document1File.name;
                    updateData.document1Url = document1Url;
                }

                // Upload Document 2 to Appwrite Storage
                if (document2File) {
                    const file2Response = await storage.createFile(
                        APPWRITE_BUCKET_ID,
                        Appwrite.ID.unique(), // Generate a unique ID for the file
                        document2File,
                        [Appwrite.Permission.read(Appwrite.Role.any())] // public permission
                    );
                    document2FileId = file2Response.$id;
                    document2Url = APPWRITE_ENDPOINT + '/storage/buckets/' + APPWRITE_BUCKET_ID + '/files/' + document2FileId + '/view?project=' + PROJECT_ID;
                    updateData.document2FileId = document2FileId;
                    updateData.document2FileName = document2File.name;
                    updateData.document2Url = document2Url;
                }

                // Store document upload status and URLs in Firebase 'documentUploads' collection
                const uploadRef = documentUploadsCollection.doc(monitoringId);
                await uploadRef.set(updateData, { merge: true });

                document.getElementById('successAlertMessage').textContent = `Document files for Document Number ${documentNumber} saved successfully!`;
                toggleModal('uploadDocumentModal', false);
                toggleModal('successAlertModal', true);
                loadMonitorings(); // Reload list to update checkmarks on cards
                // logActivity(`Uploaded documents for document number: ${documentNumber}`, monitoringId, documentNumber); // REMOVED
            } catch (error) {
                console.error("Error saving document upload status or uploading files: ", error);
                alert(`Failed to save document upload status or upload files. Error: ${error.message}. Please try again.`);
            } finally {
                hideGlobalLoading();
            }
        });

        // Autocomplete for Document Number Search in Upload Document (Modified for substring search)
        let allDocumentNumbers = []; // Cache all document numbers for client-side filtering
        async function fetchAllDocumentNumbers() {
            try {
                const snapshot = await monitoringsCollection.get(); // Fetch all documents
                allDocumentNumbers = snapshot.docs.map(doc => ({ id: doc.id, documentNumber: doc.data().documentNumber }));
                // console.log("Fetched all document numbers:", allDocumentNumbers); // Debugging line
            } catch (error) {
                console.error("Error fetching all document numbers for search: ", error);
            }
        }

        // Call this once on page load
        fetchAllDocumentNumbers();

        document.getElementById('uploadDoc_documentNumberSearch').addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const suggestionsContainer = document.getElementById('uploadDoc_documentNumberSuggestions');
            suggestionsContainer.innerHTML = '';
            document.getElementById('selectedMonitoringInfo').classList.add('hidden');
            document.getElementById('uploadDoc_monitoringId').value = '';

            if (searchTerm.length < 1) { // Allow search with 1 character
                return;
            }

            const filteredSuggestions = allDocumentNumbers.filter(doc =>
                doc.documentNumber && doc.documentNumber.toLowerCase().includes(searchTerm)
            ).slice(0, 10); // Limit to 10 suggestions

            filteredSuggestions.forEach(doc => {
                const div = document.createElement('div');
                div.textContent = doc.documentNumber;
                div.addEventListener('click', () => {
                    document.getElementById('uploadDoc_documentNumberSearch').value = doc.documentNumber;
                    document.getElementById('uploadDoc_monitoringId').value = doc.id;
                    document.getElementById('selectedDocumentNumberDisplay').textContent = doc.documentNumber;
                    document.getElementById('selectedMonitoringInfo').classList.remove('hidden');
                    suggestionsContainer.innerHTML = ''; // Clear suggestions after selection
                    loadUploadDocumentStatus(doc.id); // Load existing status for this Monitoring
                });
                suggestionsContainer.appendChild(div);
            });
        });

        // Hide autocomplete suggestions when clicking outside
        document.addEventListener('click', function(e) {
            const suggestionsContainer = document.getElementById('uploadDoc_documentNumberSuggestions');
            const searchInput = document.getElementById('uploadDoc_documentNumberSearch');
            if (suggestionsContainer && searchInput && !searchInput.contains(e.target) && !suggestionsContainer.contains(e.target)) {
                suggestionsContainer.innerHTML = '';
            }
        });


        // Function to load existing upload document status for a selected Monitoring
        async function loadUploadDocumentStatus(monitoringId) {
            try {
                const uploadDoc = await documentUploadsCollection.doc(monitoringId).get();
                const document1FileNameDisplay = document.getElementById('document1FileName');
                // const document1DownloadLink = document.getElementById('document1DownloadLink'); // REMOVED
                const document2FileNameDisplay = document.getElementById('document2FileName');
                // const document2DownloadLink = document.getElementById('document2DownloadLink'); // REMOVED

                // Reset display elements
                document1FileNameDisplay.classList.add('hidden');
                // document1DownloadLink.classList.add('hidden'); // REMOVED
                // document1DownloadLink.removeAttribute('href'); // REMOVED

                document2FileNameDisplay.classList.add('hidden');
                // document2DownloadLink.classList.add('hidden'); // REMOVED
                // document2DownloadLink.removeAttribute('href'); // REMOVED


                if (uploadDoc.exists) {
                    const data = uploadDoc.data();
                    console.log("Document Upload Data for monitoringId", monitoringId, ":", data); // Debugging

                    // Document 1
                    if (data.document1FileName && data.document1FileId && data.document1Url) {
                        document1FileNameDisplay.textContent = `File: ${data.document1FileName}`;
                        document1FileNameDisplay.classList.remove('hidden');
                        // document1DownloadLink.href = data.document1Url; // REMOVED
                        // document1DownloadLink.classList.remove('hidden'); // REMOVED
                        console.log("Document 1 URL:", data.document1Url); // Debugging
                    } else {
                        console.log("Document 1 not found or incomplete data for monitoringId", monitoringId); // Debugging
                    }

                    // Document 2
                    if (data.document2FileName && data.document2FileId && data.document2Url) {
                        document2FileNameDisplay.textContent = `File: ${data.document2FileName}`;
                        document2FileNameDisplay.classList.remove('hidden');
                        // document2DownloadLink.href = data.document2Url; // REMOVED
                        // document2DownloadLink.classList.remove('hidden'); // REMOVED
                        console.log("Document 2 URL:", data.document2Url); // Debugging
                    } else {
                        console.log("Document 2 not found or incomplete data for monitoringId", monitoringId); // Debugging
                    }
                } else {
                    console.log("No document upload entry found for monitoringId", monitoringId); // Debugging
                }
            } catch (error) {
                console.error("Error loading document upload status: ", error);
            }
        }


        // Filter Panel Button
        document.getElementById('openFilterPanelBtn').addEventListener('click', () => {
            toggleModal('filterPanel', true);
            // logActivity('Opened "Filter" panel'); // REMOVED
        });
        document.getElementById('closeFilterPanelBtn').addEventListener('click', () => toggleModal('filterPanel', false)); // Added ID for close button
        document.getElementById('applyFiltersBtn').addEventListener('click', () => { // Added ID for apply button
            // Save current filter values before applying
            document.getElementById('filterDocumentType').dataset.currentValue = document.getElementById('filterDocumentType').value;
            document.getElementById('filterDocumentNumber').dataset.currentValue = document.getElementById('filterDocumentNumber').value;
            document.getElementById('filterChangedBy').dataset.currentValue = document.getElementById('filterChangedBy').value; // NEW: Store Changed By filter
            loadMonitorings(); // Reload with filters
            toggleModal('filterPanel', false);
            // logActivity('Applied filters'); // REMOVED
        });
        document.getElementById('resetFiltersBtn').addEventListener('click', () => { // Added ID for reset button
            // Reset filter dropdowns
            document.getElementById('filterDocumentType').value = 'all';
            document.getElementById('filterDocumentNumber').value = 'all';
            document.getElementById('filterStartDate').value = '';
            document.getElementById('filterEndDate').value = '';
            document.getElementById('filterChangedBy').value = 'all'; // NEW: Reset Changed By filter
            // Clear stored current values
            delete document.getElementById('filterDocumentType').dataset.currentValue;
            delete document.getElementById('filterDocumentNumber').dataset.currentValue;
            delete document.getElementById('filterChangedBy').dataset.currentValue; // NEW: Clear Changed By stored value
            loadMonitorings(); // Reload without filters
            toggleModal('filterPanel', false);
            // logActivity('Reset filters'); // REMOVED
        });

        // Close Success Alert Modal
        document.getElementById('closeSuccessAlertBtn').addEventListener('click', () => toggleModal('successAlertModal', false)); // Added ID for close button

        // --- Global Loading Overlay ---
        function showGlobalLoading() {
            document.getElementById('global-loading-overlay').classList.remove('hidden');
            document.body.classList.add('overflow-hidden'); // Prevent scrolling
        }

        function hideGlobalLoading() {
            document.getElementById('global-loading-overlay').classList.add('hidden');
            document.body.classList.remove('overflow-hidden'); // Allow scrolling
        }

        // --- Ripple Effect for Buttons ---
        document.querySelectorAll('button').forEach(button => {
            button.addEventListener('click', function(event) {
                const circle = document.createElement('span');
                const diameter = Math.max(this.clientWidth, this.clientHeight);
                const radius = diameter / 2;

                circle.style.width = circle.style.height = `${diameter}px`;
                circle.style.left = `${event.clientX - (this.getBoundingClientRect().left + radius)}px`;
                circle.style.top = `${event.clientY - (this.getBoundingClientRect().top + radius)}px`;
                circle.classList.add('ripple');

                const ripple = this.getElementsByClassName('ripple')[0];

                if (ripple) {
                    ripple.remove();
                }

                this.appendChild(circle);
            });
        });

        // --- Placeholder for other buttons ---
        document.getElementById('authButton').addEventListener('click', () => {
            alert('Logout button clicked!');
            // In a real app, this would handle actual logout and redirect
            currentUserEmail = null; // Clear current user
            // logActivity('Logged out'); // REMOVED
            // window.location.href = 'login.html'; // Example redirect to a login page
        });
        // Updated Back button functionality
        document.getElementById('backButton').addEventListener('click', () => {
            window.location.href = 'index.html'; // Redirect to index.html
        });

        // --- Export Excel Functionality ---
        document.getElementById('exportExcelBtn').addEventListener('click', async () => {
            showGlobalLoading();
            try {
                const snapshot = await monitoringsCollection.orderBy('createdAt', 'desc').get();
                const dataToExport = [];

                snapshot.forEach(doc => {
                    const monitoring = doc.data();
                    dataToExport.push({
                        'Document Type': monitoring.documentType || '',
                        'Document Number': monitoring.documentNumber || '',
                        'Document Date': monitoring.documentDate || '',
                        'Document Description': monitoring.documentDescription || '',
                        'Initial Value (Rp)': formatRupiah(monitoring.initialValue, ''),
                        'Change Date': monitoring.changeDate || '',
                        'Change Description': monitoring.changeDescription || '',
                        'Changed Value (Rp)': formatRupiah(monitoring.changedValue, ''),
                        'Changed By': monitoring.changedBy || '', // NEW: Export Changed By
                        'Created At': monitoring.createdAt ? new Date(monitoring.createdAt.toDate()).toLocaleString() : '',
                        'Updated At': monitoring.updatedAt ? new Date(monitoring.updatedAt.toDate()).toLocaleString() : ''
                    });
                });

                if (dataToExport.length === 0) {
                    alert('No data to export.');
                    return;
                }

                const ws = XLSX.utils.json_to_sheet(dataToExport);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Monitoring Data");
                XLSX.writeFile(wb, "Document_Monitoring.xlsx"); // Changed filename

                document.getElementById('successAlertMessage').textContent = 'Data exported to Excel successfully!';
                toggleModal('successAlertModal', true);
                // logActivity('Exported monitoring data to Excel'); // REMOVED

            } catch (error) {
                console.error("Error exporting data to Excel: ", error);
                alert("Failed to export data to Excel. Please try again.");
            } finally {
                hideGlobalLoading();
            }
        });


        // --- Functions for Monitoring List and Details ---

        async function loadMonitorings() {
            showGlobalLoading();
            const monitoringsStage = document.getElementById('monitorings-stage');
            monitoringsStage.innerHTML = ''; // Clear current list

            try {
                let query = monitoringsCollection.orderBy('createdAt', 'desc');

                const filterDocType = document.getElementById('filterDocumentType').value;
                const filterDocNumber = document.getElementById('filterDocumentNumber').value;
                const filterStartDate = document.getElementById('filterStartDate').value;
                const filterEndDate = document.getElementById('filterEndDate').value;
                const filterChangedBy = document.getElementById('filterChangedBy').value; // NEW: Get Changed By filter
                const searchTerm = document.getElementById('searchMonitorings').value.toLowerCase();

                if (filterDocType !== 'all') {
                    query = query.where('documentType', '==', filterDocType);
                }
                if (filterDocNumber !== 'all') {
                    query = query.where('documentNumber', '==', filterDocNumber);
                }
                if (filterChangedBy !== 'all') { // NEW: Apply Changed By filter
                    query = query.where('changedBy', '==', filterChangedBy);
                }

                const snapshot = await query.get();
                const monitorings = [];
                snapshot.forEach(doc => {
                    monitorings.push({ id: doc.id, ...doc.data() });
                });

                const filteredMonitorings = monitorings.filter(monitoring => {
                    const matchesSearch = searchTerm === '' ||
                                          (monitoring.documentType && monitoring.documentType.toLowerCase().includes(searchTerm)) ||
                                          (monitoring.documentNumber && monitoring.documentNumber.toLowerCase().includes(searchTerm)) ||
                                          (monitoring.documentDescription && monitoring.documentDescription.toLowerCase().includes(searchTerm));

                    const docDate = monitoring.documentDate;
                    const matchesDate = (!filterStartDate || (docDate && docDate >= filterStartDate)) &&
                                        (!filterEndDate || (docDate && docDate <= filterEndDate));

                    return matchesSearch && matchesDate;
                });


                if (filteredMonitorings.length === 0) {
                    monitoringsStage.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-box-open"></i>
                            <p>No Monitoring entries to display.</p>
                            <p>Start by adding a new monitoring entry or adjusting your filters.</p>
                        </div>
                    `;
                } else {
                    // Assign sequential numbers based on the filtered and sorted list
                    for (const [index, monitoring] of filteredMonitorings.entries()) {
                        const card = createMonitoringCard(monitoring, index + 1); // Pass index + 1 as the sequential number
                        monitoringsStage.appendChild(card);
                        setTimeout(() => card.classList.add('show'), 50); // Animate cards
                    }
                }

                populateFilterOptions(monitorings); // Update filter dropdowns
            } catch (error) {
                console.error("Error loading monitorings: ", error);
                monitoringsStage.innerHTML = `
                    <div class="empty-state text-red-500">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>Error loading monitoring data.</p>
                        <p>Please check your internet connection or try again later.</p>
                    </div>
                `;
            } finally {
                hideGlobalLoading();
            }
        }

        // Modified createMonitoringCard to accept a sequential number and change checkmark to button
        function createMonitoringCard(monitoring, sequentialNumber) {
            const card = document.createElement('div');
            card.className = 'deal-card relative w-full sm:w-1/2 lg:w-1/4'; // Adjust width for responsiveness
            card.setAttribute('data-id', monitoring.id);

            const formattedInitialValue = formatRupiah(monitoring.initialValue, 'Rp ');
            const formattedChangedValue = formatRupiah(monitoring.changedValue, 'Rp ');

            card.innerHTML = `
                <span class="monitoring-card-number">${sequentialNumber}</span> <!-- Display sequential number -->
                <h3 class="text-lg font-bold text-gray-900 mb-2">${monitoring.documentNumber || 'N/A'}</h3>
                <div class="deal-details">
                    <p><i class="fas fa-calendar-alt"></i> Document Date: ${monitoring.documentDate || 'N/A'}</p>
                    <p><i class="fas fa-file-alt"></i> Document Description: ${monitoring.documentDescription || 'N/A'}</p>
                    <p><i class="fas fa-money-bill-wave"></i> Changed Price Value: ${formattedChangedValue || 'Rp 0'}</p>
                    <p><i class="fas fa-user"></i> Changed By: ${monitoring.changedBy || 'N/A'}</p> <!-- NEW: Display Changed By -->
                </div>
                <div class="deal-footer">
                    <div class="deal-footer-left">
                        <!-- Checkmark button -->
                        <button class="document-info-btn text-green-600 hover:text-green-800 p-1 rounded-full hidden" title="View Uploaded Documents" id="doc-info-btn-${monitoring.id}">
                            <i class="fas fa-check-circle"></i>
                        </button>
                    </div>
                    <div class="deal-actions">
                        <button class="view-btn text-blue-600 hover:text-blue-800 p-1" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="edit-btn text-green-600 hover:text-green-800 p-1" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="delete-btn text-red-600 hover:text-red-800 p-1" title="Delete">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </div>
            `;

            // Event Listeners for card buttons
            card.querySelector('.view-btn').addEventListener('click', () => {
                viewMonitoringDetails(monitoring.id);
                // logActivity(`Viewed details for document number: ${monitoring.documentNumber}`, monitoring.id, monitoring.documentNumber); // REMOVED
            });
            card.querySelector('.edit-btn').addEventListener('click', () => {
                editMonitoring(monitoring.id);
                // logActivity(`Opened edit form for document number: ${monitoring.documentNumber}`, monitoring.id, monitoring.documentNumber); // REMOVED
            });
            card.querySelector('.delete-btn').addEventListener('click', () => {
                confirmDeleteMonitoring(monitoring.id, monitoring.documentNumber);
                // logActivity(`Opened delete confirmation for document number: ${monitoring.documentNumber}`, monitoring.id, monitoring.documentNumber); // REMOVED
            });

            // Event listener for the new document info button
            const docInfoButton = card.querySelector(`#doc-info-btn-${monitoring.id}`);
            if (docInfoButton) { // Ensure button exists before adding listener
                docInfoButton.addEventListener('click', () => {
                    showDocumentInfo(monitoring.id, monitoring.documentNumber);
                    // logActivity(`Viewed uploaded document info for document number: ${monitoring.documentNumber}`, monitoring.id, monitoring.documentNumber); // REMOVED
                });
            }


            // Call function to check document upload status and display checkmark
            checkAndDisplayDocumentUploadStatus(monitoring.id);

            return card;
        }

        async function viewMonitoringDetails(id) {
            showGlobalLoading();
            try {
                const doc = await monitoringsCollection.doc(id).get();
                if (doc.exists) {
                    const data = doc.data();
                    document.getElementById('detailDocumentType').textContent = data.documentType || '-';
                    document.getElementById('detailDocumentNumber').textContent = data.documentNumber || '-';
                    document.getElementById('detailDocumentDate').textContent = data.documentDate || '-';
                    document.getElementById('detailDocumentDescription').textContent = data.documentDescription || '-';
                    document.getElementById('detailInitialValue').textContent = formatRupiah(data.initialValue, 'Rp ') || 'Rp 0';
                    document.getElementById('detailChangeDate').textContent = data.changeDate || '-';
                    document.getElementById('detailChangeDescription').textContent = data.changeDescription || '-';
                    document.getElementById('detailChangedValue').textContent = formatRupiah(data.changedValue, 'Rp ') || 'Rp 0';
                    document.getElementById('detailChangedBy').textContent = data.changedBy || '-'; // NEW: Display Changed By

                    toggleModal('monitoringDetailModal', true);
                } else {
                    alert("Monitoring not found.");
                }
            } catch (error) {
                console.error("Error fetching monitoring details: ", error);
                alert("Failed to load monitoring details.");
            } finally {
                hideGlobalLoading();
            }
        }

        // FIX: Add event listener for closeMonitoringDetailBtn
        document.getElementById('closeMonitoringDetailBtn').addEventListener('click', () => toggleModal('monitoringDetailModal', false));


        async function editMonitoring(id) {
            showGlobalLoading();
            try {
                const doc = await monitoringsCollection.doc(id).get();
                if (doc.exists) {
                    const data = doc.data();
                    document.getElementById('modalTitle').textContent = 'Edit Monitoring';
                    document.getElementById('monitoringId').value = id;
                    document.getElementById('documentType').value = data.documentType || '';
                    document.getElementById('documentNumber').value = data.documentNumber || '';
                    document.getElementById('documentDate').value = data.documentDate || '';
                    document.getElementById('documentDescription').value = data.documentDescription || '';
                    document.getElementById('initialValue').value = formatRupiah(data.initialValue, 'Rp ') || '';
                    document.getElementById('changeDate').value = data.changeDate || '';
                    document.getElementById('changeDescription').value = data.changeDescription || '';
                    document.getElementById('changedValue').value = formatRupiah(data.changedValue, 'Rp ') || '';
                    document.getElementById('changedBy').value = data.changedBy || ''; // NEW: Set Changed By value

                    toggleModal('monitoringModal', true);
                } else {
                    alert("Monitoring not found for editing.");
                }
            } catch (error) {
                console.error("Error fetching monitoring for edit: ", error);
                alert("Failed to load monitoring for editing.");
            } finally {
                hideGlobalLoading();
            }
        }

        let monitoringToDeleteId = null;
        async function confirmDeleteMonitoring(id, name) {
            monitoringToDeleteId = id;
            document.getElementById('dealToDeleteName').textContent = name;
            toggleModal('deleteModal', true);
        }

        document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
            if (monitoringToDeleteId) {
                showGlobalLoading();
                try {
                    const docToDelete = await monitoringsCollection.doc(monitoringToDeleteId).get();
                    const documentNumber = docToDelete.exists ? docToDelete.data().documentNumber : 'N/A';

                    await monitoringsCollection.doc(monitoringToDeleteId).delete();
                    // Also delete associated document uploads if any
                    // It's good practice to also delete the files from Appwrite Storage
                    const uploadDoc = await documentUploadsCollection.doc(monitoringToDeleteId).get();
                    if (uploadDoc.exists) {
                        const uploadData = uploadDoc.data();
                        if (uploadData.document1FileId) {
                            try { await storage.deleteFile(APPWRITE_BUCKET_ID, uploadData.document1FileId); } catch (e) { console.warn("Error deleting Appwrite file 1:", e); }
                        }
                        if (uploadData.document2FileId) {
                            try { await storage.deleteFile(APPWRITE_BUCKET_ID, uploadData.document2FileId); } catch (e) { console.warn("Error deleting Appwrite file 2:", e); }
                        }
                        await documentUploadsCollection.doc(monitoringToDeleteId).delete();
                    }


                    toggleModal('deleteModal', false);
                    toggleModal('successAlertModal', true);
                    document.getElementById('successAlertMessage').textContent = 'Monitoring deleted successfully!';
                    loadMonitorings(); // Reload list after deletion
                    fetchAllDocumentNumbers(); // Re-fetch document numbers for autocomplete
                    // logActivity(`Deleted monitoring for document number: ${documentNumber}`, monitoringToDeleteId, documentNumber); // REMOVED
                } catch (error) {
                    console.error("Error deleting monitoring: ", error);
                    alert("Failed to delete monitoring. Please try again.");
                } finally {
                    hideGlobalLoading();
                    monitoringToDeleteId = null;
                }
            }
        });
        document.getElementById('cancelDeleteBtn').addEventListener('click', () => toggleModal('deleteModal', false)); // Added ID for cancel button


        // Function to populate filter dropdowns
        async function populateFilterOptions(monitorings) {
            const filterDocumentTypeSelect = document.getElementById('filterDocumentType');
            const filterDocumentNumberSelect = document.getElementById('filterDocumentNumber');
            const filterChangedBySelect = document.getElementById('filterChangedBy'); // NEW: Get Changed By filter select

            // Store current selected values
            const currentFilterDocType = filterDocumentTypeSelect.dataset.currentValue || 'all';
            const currentFilterDocNumber = filterDocumentNumberSelect.dataset.currentValue || 'all';
            const currentFilterChangedBy = filterChangedBySelect.dataset.currentValue || 'all'; // NEW: Store current Changed By filter

            // Clear existing options (except "All")
            filterDocumentTypeSelect.innerHTML = '<option value="all">All Document Types</option>';
            filterDocumentNumberSelect.innerHTML = '<option value="all">All Document Numbers</option>';
            // Do not clear filterChangedBySelect as its options are static

            const documentTypes = new Set();
            const documentNumbers = new Set();
            const changedByPersons = new Set(); // NEW: Collect Changed By persons

            monitorings.forEach(m => {
                if (m.documentType) documentTypes.add(m.documentType);
                if (m.documentNumber) documentNumbers.add(m.documentNumber);
                if (m.changedBy) changedByPersons.add(m.changedBy); // NEW: Add to set
            });

            Array.from(documentTypes).sort().forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                filterDocumentTypeSelect.appendChild(option);
            });

            Array.from(documentNumbers).sort().forEach(number => {
                const option = document.createElement('option');
                option.value = number;
                option.textContent = number;
                filterDocumentNumberSelect.appendChild(option);
            });

            // Restore selected filter values
            filterDocumentTypeSelect.value = currentFilterDocType;
            filterDocumentNumberSelect.value = currentFilterDocNumber;
            filterChangedBySelect.value = currentFilterChangedBy; // NEW: Restore Changed By filter
        }

        // Function to check document upload status and display checkmark button (MODIFIED)
        async function checkAndDisplayDocumentUploadStatus(monitoringId) {
            try {
                const uploadDoc = await documentUploadsCollection.doc(monitoringId).get();
                const docInfoButton = document.getElementById(`doc-info-btn-${monitoringId}`);

                if (docInfoButton) {
                    if (uploadDoc.exists) {
                        const data = uploadDoc.data();
                        // Check if at least one document (document1 or document2) has been uploaded AND has a URL
                        if ((data.document1FileId && data.document1Url) || (data.document2FileId && data.document2Url)) {
                            docInfoButton.classList.remove('hidden');
                        } else {
                            docInfoButton.classList.add('hidden');
                        }
                    } else {
                        docInfoButton.classList.add('hidden'); // Hide if no upload document entry exists
                    }
                }
            } catch (error) {
                console.error("Error checking document upload status: ", error);
            }
        }

        // --- Show Document Info Modal (NEW) ---
        async function showDocumentInfo(monitoringId, documentNumber) {
            showGlobalLoading();
            try {
                const uploadDoc = await documentUploadsCollection.doc(monitoringId).get();
                const docInfo_documentNumber = document.getElementById('docInfo_documentNumber');
                const docInfo_doc1Name = document.getElementById('docInfo_doc1Name');
                // const docInfo_doc1Link = document.getElementById('docInfo_doc1Link'); // REMOVED
                const docInfo_doc2Name = document.getElementById('docInfo_doc2Name');
                // const docInfo_doc2Link = document.getElementById('doc2Link'); // REMOVED

                docInfo_documentNumber.textContent = documentNumber;

                // Reset previous info
                docInfo_doc1Name.textContent = 'None';
                // docInfo_doc1Link.classList.add('hidden'); // REMOVED
                // docInfo_doc1Link.removeAttribute('href'); // REMOVED

                docInfo_doc2Name.textContent = 'None';
                // docInfo_doc2Link.classList.add('hidden'); // REMOVED
                // docInfo_doc2Link.removeAttribute('href'); // REMOVED

                if (uploadDoc.exists) {
                    const data = uploadDoc.data();
                    console.log("Document Info Modal Data for monitoringId", monitoringId, ":", data); // Debugging

                    // Document 1
                    if (data.document1FileName && data.document1FileId && data.document1Url) {
                        docInfo_doc1Name.textContent = data.document1FileName;
                        // docInfo_doc1Link.href = data.document1Url; // REMOVED
                        // docInfo_doc1Link.classList.remove('hidden'); // REMOVED
                        console.log("Doc Info - Document 1 URL:", data.document1Url); // Debugging
                    } else {
                        console.log("Doc Info - Document 1 not found or incomplete data for monitoringId", monitoringId); // Debugging
                    }

                    // Document 2
                    if (data.document2FileName && data.document2FileId && data.document2Url) {
                        docInfo_doc2Name.textContent = data.document2FileName;
                        // docInfo_doc2Link.href = data.document2Url; // REMOVED
                        // docInfo_doc2Link.classList.remove('hidden'); // REMOVED
                        console.log("Doc Info - Document 2 URL:", data.document2Url); // Debugging
                    } else {
                        console.log("Doc Info - Document 2 not found or incomplete data for monitoringId", monitoringId); // Debugging
                    }
                } else {
                    console.log("No document upload entry found for monitoringId", monitoringId, "in Document Info Modal."); // Debugging
                }

                toggleModal('documentInfoModal', true);
            } catch (error) {
                console.error("Error showing document info: ", error);
                alert("Failed to load document information.");
            } finally {
                hideGlobalLoading();
            }
        }

        // Close Document Info Modal
        document.getElementById('closeDocumentInfoModalBtn').addEventListener('click', () => toggleModal('documentInfoModal', false));
        document.getElementById('closeDocumentInfoBtn').addEventListener('click', () => toggleModal('documentInfoModal', false));


        // --- Initial Load ---
        loadMonitorings(); // Load monitorings when the page loads
    });
</script>
</body>
</html>
